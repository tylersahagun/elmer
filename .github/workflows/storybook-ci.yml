# Storybook CI - Validates stories exist for all components
# Runs on PRs that touch component files

name: Storybook CI

on:
  pull_request:
    paths:
      - "prototypes/src/components/**"
      - "orchestrator/src/components/**"
    branches:
      - main

  push:
    paths:
      - "prototypes/src/components/**"
    branches:
      - main

  workflow_dispatch:

jobs:
  # Job 1: Validate that components have stories
  validate-stories:
    runs-on: ubuntu-latest
    name: Validate Story Coverage

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check story coverage
        id: check-stories
        run: |
          echo "ðŸ” Checking for components without stories..."
          
          MISSING_STORIES=""
          
          # Find all .tsx component files (excluding stories, index, types)
          for file in $(find prototypes/src/components -name "*.tsx" \
            ! -name "*.stories.tsx" \
            ! -name "index.tsx" \
            ! -name "types.tsx" \
            ! -path "*/ui/*" \
            -type f); do
            
            # Get the expected story file path
            story_file="${file%.tsx}.stories.tsx"
            
            # Check if story file exists
            if [ ! -f "$story_file" ]; then
              MISSING_STORIES="$MISSING_STORIES\n- $file (expected: $story_file)"
            fi
          done
          
          if [ -n "$MISSING_STORIES" ]; then
            echo "âŒ Components missing stories:"
            echo -e "$MISSING_STORIES"
            echo ""
            echo "ðŸ“ Every component needs a .stories.tsx file."
            echo "Run: npm run storybook:validate in prototypes/"
            echo "missing=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… All components have stories!"
            echo "missing=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR (if missing stories)
        if: github.event_name == 'pull_request' && steps.check-stories.outputs.missing == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âš ï¸ **Storybook Coverage Warning**\n\nSome components are missing Storybook stories. Please ensure every component has a corresponding `.stories.tsx` file.\n\nRun `npm run storybook:validate` in the `prototypes/` directory to see details.'
            })

  # Job 2: Build Storybook to catch errors
  build-storybook:
    runs-on: ubuntu-latest
    name: Build Storybook

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: prototypes/package-lock.json

      - name: Install dependencies
        working-directory: prototypes
        run: npm ci

      - name: Build Storybook
        working-directory: prototypes
        run: npm run build-storybook

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: storybook-build
          path: prototypes/storybook-static
          retention-days: 7

  # Job 3: Deploy to Chromatic (visual regression)
  chromatic:
    runs-on: ubuntu-latest
    name: Chromatic Visual Tests
    needs: build-storybook

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: prototypes/package-lock.json

      - name: Install dependencies
        working-directory: prototypes
        run: npm ci

      - name: Run Chromatic
        id: chromatic
        uses: chromaui/action@latest
        with:
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          workingDir: prototypes
          exitZeroOnChanges: true
          exitOnceUploaded: ${{ github.event_name == 'push' }}
          autoAcceptChanges: main
          onlyChanged: true

      - name: Output Chromatic URLs
        run: |
          echo "## ðŸŽ¨ Storybook Preview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Storybook URL:** ${{ steps.chromatic.outputs.storybookUrl }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build URL:** ${{ steps.chromatic.outputs.buildUrl }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Permanent URL:** https://main--696c2c54e35ea5bca2a772d8.chromatic.com" >> $GITHUB_STEP_SUMMARY

      - name: Comment Chromatic URL on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸŽ¨ Storybook Preview Ready\n\n**Preview:** ${{ steps.chromatic.outputs.storybookUrl }}\n**Build:** ${{ steps.chromatic.outputs.buildUrl }}\n\nReview visual changes in [Chromatic](https://www.chromatic.com/builds?appId=696c2c54e35ea5bca2a772d8).`
            })
