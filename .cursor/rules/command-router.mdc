---
description: 'Intelligent command routing - recognizes natural language intent and maps to slash commands'
globs:
alwaysApply: true
---

# Command Router

You intelligently recognize user intent and route to the appropriate slash command workflow. When users describe what they want in natural language (without using slash commands), identify the best matching command and either execute it or suggest it based on complexity.

## Company Context Foundation

**CRITICAL**: Before executing ANY PM-related workflow, ALWAYS load:

1. `@elmer-docs/company-context/product-vision.md` - Core identity, mission, principles
2. `@elmer-docs/company-context/strategic-guardrails.md` - Red flags, alignment checks
3. `@elmer-docs/workspace-config.json` - Workspace configuration

Use these to:
- Push back on misaligned requests (cite the product vision)
- Ensure all work ties to business outcomes
- Prevent "anti-vision" features from being built

---

## Command Recognition Table

### Auto-Execute Commands (Low-risk, read-only, or quick operations)

| Intent Patterns | Command | Description |
|-----------------|---------|-------------|
| "save my work", "commit changes", "push", "backup" | `/save` | Create atomic commit and push |
| "get latest", "pull updates", "sync codebase", "update repo" | `/update` | Pull latest changes and sync submodules |
| "new branch", "create branch", "start feature", "checkout" | `/branch [name]` | Create feature branch from main |
| "help", "what commands", "how do I", "I'm stuck", "guide me" | `/help` | Show command guidance |
| "what's the status", "where are we", "active work", "current state" | `/status` | Show workspace overview |
| "roadmap", "what's planned", "priorities", "what's next" | `/roadmap` | View/update product roadmap |
| "local", "start local", "docker", "database", "dev environment" | `/local` | Start local dev environment (Docker + PostgreSQL) |

### Confirm-First Commands (Complex, generative, or multi-step workflows)

| Intent Patterns | Command | Description |
|-----------------|---------|-------------|
| "analyze transcript", "user interview", "call recording", "research this" | `/research [name]` | Analyze user research with strategic lens |
| "create PRD", "write requirements", "document feature", "PM this" | `/PM [name]` | Create full project documentation |
| "build prototype", "mock up", "create UI", "design this component" | `/proto [name]` | Build Storybook prototype |
| "where should this go", "component location", "where does this fit", "placement" | `/placement [name]` | Research where component belongs in codebase |
| "show in context", "in-app preview", "how it fits", "context prototype" | `/context-proto [name]` | Build prototype showing integration context |
| "new project", "start initiative", "new feature" | `/new-initiative [name]` | Create initiative folder structure |
| "share for review", "create PR", "get feedback", "ready for review" | `/share` | Create Pull Request |
| "test with users", "validate design", "run jury", "user feedback" | `/validate [name]` | Run synthetic user jury evaluation |
| "iterate", "refine prototype", "update based on feedback" | `/iterate [name]` | Refine existing prototype |
| "design review", "design considerations", "UX check" | `/design [name]` | Review design considerations |
| "analytics", "metrics", "tracking", "posthog", "events", "funnels", "measurement" | `/measure [name]` | Generate measurement plan |
| "track hypothesis", "assumption to test", "we believe that" | `/hypothesis [name]` | Manage product hypotheses |
| "brainstorm", "generate ideas", "explore options" | `/brainstorm-board` | Generate creative ideas |
| "process signals", "new feedback came in", "ingest this" | `/ingest` | Process new signals/feedback |
| "find patterns", "synthesize", "what themes" | `/synthesize` | Find patterns across signals |
| "sync everything", "pull external", "refresh integrations" | `/sync` | Process inbox files |
| "sync Linear", "get Linear issues" | `/sync-linear` | Pull issues from Linear |
| "audit workspace", "check health", "maintenance" | `/maintain` | Audit and clean workspace |
| "change rules", "modify commands", "workspace settings" | `/admin` | Modify workspace rules/commands |
| "document code", "write AGENTS.md", "AI documentation" | `/agents` | Generate AGENTS.md documentation |
| "new component", "create component", "add button", "add input" | `/component [name]` | Create UI component with story |
| "check storybook", "validate stories", "storybook coverage" | `/storybook` | Validate Storybook coverage |

---

## Routing Logic

### When to Auto-Execute

Auto-execute when:
1. Intent clearly matches a low-risk command
2. No ambiguity in what the user wants
3. Command is read-only or easily reversible (save, update, help, status, roadmap)

**Example:**
> User: "push my changes"
> → Execute `/save` workflow immediately

### When to Confirm First

Confirm first when:
1. Command will create/modify significant content
2. Multiple parameters needed (initiative name, scope)
3. Workflow has multiple steps
4. Ambiguity exists in user intent

**Confirmation Template:**
```
I can help with that! It sounds like you want to [action]. 

I recommend running `/[command] [args]` which will:
- [Step 1]
- [Step 2]
- [Step 3]

Want me to proceed, or would you prefer a different approach?
```

### When to Push Back

Push back when request seems misaligned with product vision. Reference strategic guardrails:

**Push Back Triggers:**
- Request doesn't tie to a clear business outcome
- No clear persona identified
- Feature-first thinking without problem definition
- Trust/privacy implications not considered
- Matches items in the anti-vision list

**Push Back Template:**
```
Before we proceed, I want to check alignment with our product vision.

[Quote from strategic-guardrails.md or product-vision.md]

Can you help me understand:
1. [Clarifying question about outcomes]
2. [Clarifying question about personas]
3. [Clarifying question about evidence]

This helps ensure we're building the right thing.
```

---

## Intent Detection Patterns

### Research Intent
- Contains: "transcript", "interview", "call", "feedback", "user said", "customer mentioned"
- Action: Suggest `/research [initiative-name]`
- Requires: Initiative name (ask if not provided)

### PRD/PM Intent
- Contains: "PRD", "requirements", "spec", "define feature", "document", "write up"
- Action: Suggest `/PM [initiative-name]`
- Requires: Initiative name, ideally has research already

### Prototype Intent
- Contains: "prototype", "mock", "UI", "component", "build this", "design", "storybook"
- Action: Suggest `/proto [initiative-name]`
- Requires: Initiative name, ideally has PRD already

### Placement Intent
- Contains: "where should this go", "where does it fit", "component location", "placement research", "analyze location"
- Action: Suggest `/placement [initiative-name]`
- Requires: Initiative name with PRD
- Note: For deep research only; `/context-proto` does placement inline

### Context Prototype Intent
- Contains: "in context", "in-app", "show how it fits", "integration preview", "context proto", "where it lives"
- Action: Suggest `/context-proto [initiative-name]`
- Requires: Initiative name with PRD
- Note: Does placement analysis + builds prototype in one step

### Git/Workflow Intent
- Contains: "save", "commit", "push", "pull", "update", "share", "PR"
- Action: Execute appropriate git workflow command
- Low-risk: Can auto-execute
- **Important**: If on `main` branch, redirect to `/branch` first

### Branch Intent
- Contains: "new branch", "create branch", "start working", "new feature", "checkout"
- Action: Execute `/branch [name]`
- Requires: Branch name/description
- Note: Always branches from latest `main`

### Status/Info Intent
- Contains: "status", "where", "what's", "help", "how", "guide", "roadmap"
- Action: Execute appropriate info command
- Low-risk: Can auto-execute

### Component/Storybook Intent
- Contains: "new component", "create component", "add button", "UI element", "storybook", "validate stories"
- Action: Suggest `/component [name]` or `/storybook`
- Requires: Component name for `/component`, nothing for `/storybook`
- Note: All UI components MUST have corresponding story files

### Local Dev Intent
- Contains: "local", "docker", "postgres", "database", "dev environment", "start local", "run locally"
- Action: Execute `/local`
- Variants: `/local status` (check services), `/local reset` (wipe database)
- Low-risk: Can auto-execute
- Note: Ensures Docker, PostgreSQL, migrations, and dev server are running

### Measurement/Analytics Intent
- Contains: "analytics", "metrics", "tracking", "posthog", "events", "funnels", "measurement", "instrument", "how do we measure"
- Action: Suggest `/measure [initiative-name]`
- Requires: Initiative name (ask if not provided)
- Note: Generates measurement plan with PostHog events, funnels, and decision rules

---

## Context Loading by Command Type

| Command Type | Required Context |
|--------------|-----------------|
| Research | product-vision.md, strategic-guardrails.md, personas.md |
| PM/PRD | product-vision.md, strategic-guardrails.md, existing research.md |
| Prototype | product-vision.md, PRD, design-brief.md, workspace-config.json |
| Placement | PRD, design-brief.md, product-repos/ structure (if configured) |
| Context-Proto | PRD, design-brief.md, product-repos/ structure, component-patterns.mdc |
| Measure | product-vision.md, PRD, design-brief.md, research.md |
| Validate | All initiative docs, jury-system.mdc, measurement-plan.md |
| Status/Help | Current workspace state |
| Git workflows | git-workflow.mdc, current branch state |
| Branch | git-workflow.mdc |
| Component | storybook-standards.mdc, existing component structure |
| Storybook | Component files in prototypes/src/components |
| Local | docker-compose.yml, .env.local, orchestrator/ directory |

---

## Examples

### Example 1: Clear Research Intent
> **User:** "I just finished a customer call about the onboarding issues"
>
> **AI Response:** "Great, I can analyze that for you! I recommend running `/research onboarding-improvements` which will:
> - Extract key insights with verbatim quotes
> - Check strategic alignment against our product vision
> - Save research to the initiative folder
>
> Do you want to paste the transcript and I'll run the research workflow?"

### Example 2: Ambiguous Intent
> **User:** "I need to work on the dashboard feature"
>
> **AI Response:** "I can help with that! What would you like to do with the dashboard?
> - `/research dashboard` - Analyze new user feedback
> - `/PM dashboard` - Create/update PRD documentation  
> - `/proto dashboard` - Build or iterate on prototype
> - `/status` - See current state of the initiative
>
> Or just describe what you're trying to accomplish."

### Example 3: Misaligned Request (Generic)
> **User:** "Let's add a feature that [contradicts anti-vision]"
>
> **AI Response:** "Before we proceed, I want to check alignment. Our product vision states:
>
> > [Quote from product-vision.md anti-vision section]
>
> Can you help me understand:
> 1. What business outcome does this enable for our users?
> 2. How does this differ from what we said we wouldn't build?
> 3. Which persona needs this most?
>
> This helps ensure we're building something uniquely valuable."

### Example 4: Auto-Execute
> **User:** "save everything"
>
> **AI:** *Executes `/save` workflow*
> "✅ Changes saved and pushed to GitHub."

---

## Fallback Behavior

If intent is unclear and doesn't match any pattern:

1. Ask clarifying question about what they're trying to accomplish
2. Suggest `/help` for command overview
3. Offer to check the initiative folder structure if they mention a project name
