# Plan 04-01: Workspace Creation with Automatic Admin Membership

## Frontmatter

```yaml
plan_id: "04-01"
phase: 4
wave: 1
depends_on: ["03-01", "03-03"]
files_modified:
  - orchestrator/src/app/api/workspaces/route.ts
  - orchestrator/src/lib/db/queries.ts
autonomous: true
estimated_duration: "20 minutes"
```

## Objective

Update workspace creation to require authentication and automatically add the creator as an admin member. This establishes workspace ownership.

## Context

**Existing infrastructure:**
- `workspaceMembers` table exists with `userId`, `workspaceId`, `role` columns
- `createWorkspace` function creates workspace but doesn't add members
- Auth.js configured with JWT sessions
- `auth()` function available for server-side session access

**This plan adds:**
- Authentication requirement for workspace creation
- Automatic admin membership for workspace creator
- User ID tracking on workspace operations

## Tasks

<task id="1" name="Update Workspace API to Require Auth">
<description>
Modify the POST /api/workspaces endpoint to require authentication and create admin membership.
</description>
<files>
- orchestrator/src/app/api/workspaces/route.ts
</files>
<instructions>
1. Import `auth` from "@/auth"
2. In POST handler, call `auth()` to get session
3. Return 401 if no session
4. Pass `userId` to `createWorkspace` function
5. After workspace creation, create workspace member with role "admin"
</instructions>
<verification>
- [ ] Unauthenticated POST returns 401
- [ ] Authenticated POST creates workspace
- [ ] Creator is added as admin member
</verification>
</task>

<task id="2" name="Update createWorkspace Query">
<description>
Update the createWorkspace function to accept userId and create the admin membership.
</description>
<files>
- orchestrator/src/lib/db/queries.ts
</files>
<instructions>
1. Add `userId` parameter to `createWorkspace` function
2. After inserting workspace, insert into `workspaceMembers`:
   - workspaceId: new workspace id
   - userId: creator's user id
   - role: "admin"
3. Return the created workspace with membership info
</instructions>
<verification>
- [ ] Function accepts userId parameter
- [ ] Workspace member record created with admin role
- [ ] No errors on workspace creation
</verification>
</task>

<task id="3" name="Update GET Workspaces to Filter by User">
<description>
Update the GET /api/workspaces endpoint to only return workspaces the user is a member of.
</description>
<files>
- orchestrator/src/app/api/workspaces/route.ts
- orchestrator/src/lib/db/queries.ts
</files>
<instructions>
1. In GET handler, get session and user ID
2. If authenticated, filter workspaces by membership
3. If not authenticated, return empty array (or 401)
4. Create `getWorkspacesForUser(userId)` query function
5. Join workspaces with workspaceMembers where userId matches
</instructions>
<verification>
- [ ] GET returns only user's workspaces
- [ ] Workspaces include user's role
- [ ] Empty array for users with no workspaces
</verification>
</task>

## Verification Criteria

After all tasks complete, verify:

1. **Auth required:**
   - Unauthenticated request to POST /api/workspaces returns 401
   - Unauthenticated request to GET /api/workspaces returns 401 or empty

2. **Membership created:**
   - Create workspace as authenticated user
   - Check database: workspace_members has record with admin role

3. **Filtering works:**
   - User A creates workspace
   - User B should NOT see User A's workspace in their list

## must_haves

- [ ] Workspace creation requires authentication
- [ ] Creator automatically becomes admin member
- [ ] Users only see workspaces they belong to

---
*Plan 04-01 | Phase 4 | Wave 1*
