# Plan 15-02: Signal Processor

**Goal**: Create the signal processing orchestrator that combines extraction and embedding generation
**Wave**: 2
**Execution**: autonomous

## Context

This plan creates the core signal processor that orchestrates LLM extraction and embedding generation. It uses the AI modules from Plan 15-01 and updates signals with processed data.

**Key Decisions from Prior Phases:**
- v1.1 (13-02): Queue-first pattern with after() for async processing
- v1.1 (13-02): Never throw in after() context - log errors for debugging
- Signal schema has: embedding, severity, frequency, userSegment, processedAt fields

**Research Reference:** .planning/phases/15-signal-extraction-and-embedding/15-RESEARCH.md

## Tasks

### Task 1: Add updateSignalProcessing Query Function

**Files:**
- `orchestrator/src/lib/db/queries.ts`

**Action:**
Add new function `updateSignalProcessing` that updates the AI-processed fields:

```typescript
export async function updateSignalProcessing(
  id: string,
  data: {
    severity?: SignalSeverity | null;
    frequency?: SignalFrequency | null;
    userSegment?: string | null;
    interpretation?: string | null;
    embedding?: string | null;
    processedAt?: Date;
  }
) {
  await db
    .update(signals)
    .set({
      ...data,
      updatedAt: new Date(),
    })
    .where(eq(signals.id, id));

  return getSignal(id);
}
```

This is separate from `updateSignal` because:
- It accepts nullable fields (extraction may return nulls)
- It includes `processedAt` timestamp
- It updates `embedding` field (text type for base64)

**Verify:**
- Function compiles without TypeScript errors
- Function exported from queries.ts

**Done:**
- Database update function ready for signal processing

### Task 2: Create Signal Processor Module

**Files:**
- `orchestrator/src/lib/signals/processor.ts`

**Action:**
Create `lib/signals/processor.ts` with:

1. Export `processSignalExtraction(signalId: string): Promise<void>` that:
   - Fetches signal by ID using `getSignal`
   - Returns early if signal not found (log warning)
   - Returns early if `signal.processedAt` already set (idempotency - log info)
   - Sets `processedAt` optimistically BEFORE processing (prevents duplicate processing)
   - Calls `extractSignalFields(signal.verbatim)` to get severity, frequency, userSegment, interpretation
   - Calls `generateEmbedding(signal.verbatim)` to get embedding vector
   - Converts embedding to base64 using `embeddingToBase64`
   - Updates signal with extracted data using `updateSignalProcessing`
   - On ANY error: reset `processedAt` to null (allows retry), then re-throw

2. Export `batchProcessSignals(signalIds: string[]): Promise<{ processed: number; failed: number }>` for future backfill:
   - Process in batches of 10 (conservative for rate limits)
   - Use Promise.all within each batch
   - Track processed/failed counts
   - 100ms delay between batches
   - Never throw - log errors and continue

**Verify:**
- File compiles without TypeScript errors
- Both functions exported

**Done:**
- `processSignalExtraction` processes single signal with idempotency
- `batchProcessSignals` available for bulk backfill operations

### Task 3: Create lib/signals Index File

**Files:**
- `orchestrator/src/lib/signals/index.ts`

**Action:**
Create barrel export file:
```typescript
export * from './processor';
```

**Verify:**
- Can import from `@/lib/signals` in other files

**Done:**
- Clean import path for signal processing utilities

## Acceptance Criteria

- [ ] `updateSignalProcessing` function exists in queries.ts
- [ ] `processSignalExtraction` handles idempotency via processedAt check
- [ ] `processSignalExtraction` resets processedAt on failure (allows retry)
- [ ] `batchProcessSignals` processes in batches with rate limit handling
- [ ] All modules importable from `@/lib/signals`

## Dependencies

**Depends on:**
- Plan 15-01 (AI Infrastructure - extraction.ts, embeddings.ts)
- `getSignal` from lib/db/queries.ts
- Signal schema fields from lib/db/schema.ts

**Enables:**
- Plan 15-03 (/ingest endpoint)
- Future batch processing endpoint
