---
phase: 15-signal-extraction-and-embedding
plan: 15-04
type: gap-closure
title: "Wire Processing to Manual Signal Creation Endpoint"
created: 2026-01-24T07:00:00Z
complexity: trivial
estimated_lines: 10
gap_source: milestone-audit
blocking: critical
---

# Plan 15-04: Wire Processing to Manual Signal Creation Endpoint

**Type:** Gap Closure
**Complexity:** Trivial
**Gap Source:** v1.1 Milestone Audit
**Blocking Severity:** Critical - Breaks primary user workflow

## Problem

The manual signal creation endpoint (`POST /api/signals`) used by the UI paste form creates signals but never calls `processSignalExtraction()`. This breaks the primary user workflow:

1. User creates signal via paste (Phase 12) ✓
2. Signal processed for extraction + embedding (Phase 15) **❌ BROKEN**
3. Signal auto-classified to project (Phase 16) ❌ Depends on step 2
4. User manually links signal to project (Phase 12.5) ✓
5. Signal appears in project provenance (Phase 18) ✓
6. PRD generator cites signal as evidence (Phase 18) ✓

**Impact:**
- No AI extraction (severity, frequency remain null)
- No embedding generation (signals cannot cluster)
- No classification (no AI suggestions appear)
- No automation triggers (suggest mode won't work for manual signals)

**Root Cause:** Plan 15-03 integrated processing into 6 specialized endpoints (ingest, upload, video, webhooks, pylon, slack) but missed the base CRUD endpoint used by the UI.

## Gap Analysis

### What Works (6/7 endpoints)

All these endpoints properly call `processSignalExtraction()` after signal creation:

- ✓ `/api/signals/ingest` (line 67)
- ✓ `/api/signals/upload` (line 161)
- ✓ `/api/signals/video` (line 137)
- ✓ `/api/webhooks/signals` (via processSignalWebhook line 143)
- ✓ Pylon integration (via createSignalFromPylon line 151)
- ✓ Slack integration (via createSignalFromSlack line 118)

### What's Broken (1/7 endpoints)

- ❌ `POST /api/signals` (UI paste form) - NO PROCESSING CALLED

**Evidence:**
- `CreateSignalModal.tsx:67` calls `POST /api/signals`
- Route creates signal at line 103-110
- No `after()` block with processing call
- `processSignalExtraction` imported at top but never used

## Solution

Add processing call to `POST /api/signals` route following the established pattern from other endpoints.

## Tasks

### Task 1: Add Processing Call to Manual Signal Creation

**File:** `orchestrator/src/app/api/signals/route.ts`
**Location:** After line 110 (after signal creation, before response)
**Estimated Lines:** 10

**Changes:**

1. Verify `processSignalExtraction` is imported (should already be imported from Phase 15-03)
2. Add `after()` block calling `processSignalExtraction(signal.id)`
3. Wrap in try/catch following queue-first pattern
4. Add error logging (never throw in after())

**Code to add after line 110:**

```typescript
  // Queue AI extraction and embedding (Phase 15)
  after(async () => {
    try {
      await processSignalExtraction(signal.id);
    } catch (error) {
      console.error(`Failed to process signal ${signal.id}:`, error);
    }
  });
```

**Verification:**
- Import statement exists: `import { processSignalExtraction } from "@/lib/signals"`
- after() imported: `import { after } from "next/server"`
- Pattern matches other endpoints exactly

**Why this works:**
- `after()` allows response to return immediately (200 status)
- Processing happens async in background
- Errors caught and logged, don't crash endpoint
- Follows queue-first pattern from Phase 13

## Verification Criteria

### Must-Have Verification

**Truth 1:** Manual signal creation triggers AI processing
- **Test:** Create signal via UI paste form
- **Check:** Signal has `processedAt` timestamp (not null)
- **Check:** Signal has `severity`, `frequency`, `userSegment` populated
- **Check:** Signal has `embeddingVector` (not null)
- **Location:** Database query or signal detail modal

**Truth 2:** Processing follows queue-first pattern
- **Test:** Create signal via UI, measure response time
- **Check:** Endpoint returns 201 in < 100ms
- **Check:** Signal appears immediately with verbatim
- **Check:** Processing completes within 5 seconds (check processedAt)

**Truth 3:** Classification runs after processing
- **Test:** Create signal via UI that matches existing project
- **Check:** Signal has `classification` populated
- **Check:** Suggestion appears in SignalSuggestionsBanner (Phase 17)

**Truth 4:** No errors in after() block
- **Test:** Create signal via UI
- **Check:** No console errors logged
- **Check:** Signal status not stuck in "new"
- **Check:** Processing completes successfully

### Integration Checks

**E2E Workflow 1: Manual Signal Entry → PRD Citation**
- Step 1: User creates signal via paste ✓
- Step 2: Signal processed for extraction + embedding ✓ (FIXED)
- Step 3: Signal auto-classified to project ✓
- Step 4: User manually links signal to project ✓
- Step 5: Signal appears in project provenance ✓
- Step 6: PRD generator cites signal as evidence ✓

**Automation Workflow:**
- Create 5 manual signals on same topic
- Verify cluster forms (Phase 16)
- Verify automation triggers (Phase 19)
- Verify notification sent (Phase 19)

## Success Criteria

- [ ] Code added to `orchestrator/src/app/api/signals/route.ts`
- [ ] Manual signal creation triggers processing
- [ ] Signals have AI-extracted fields populated
- [ ] Signals have embeddings generated
- [ ] Classification runs and suggestions appear
- [ ] Automation detect clusters of manual signals
- [ ] E2E workflow 1 (Manual Signal Entry → PRD Citation) functional
- [ ] No TypeScript errors
- [ ] No runtime errors in after() block

## Rollback Plan

If this change causes issues:

1. Remove the `after()` block added in this plan
2. Manual signals will create successfully but won't be processed
3. Users can still use other endpoints (upload, video, ingest) for processed signals

**Risk:** Very low - code pattern is identical to 6 other working endpoints

## Dependencies

**Upstream (already satisfied):**
- Phase 15: processSignalExtraction function exists
- Phase 15: after() pattern established
- Phase 12: CreateSignalModal calling POST /api/signals

**Downstream (will be unblocked):**
- Phase 16: Classification for manual signals
- Phase 17: Suggestions for manual signals
- Phase 19: Automation on manual signal clusters
- Full E2E workflow from manual entry to PRD citation

## Notes

**Why this gap existed:**
- Plan 15-03 correctly identified 6 signal sources for integration
- /ingest, /upload, /video are specialized creation endpoints
- Webhooks, Pylon, Slack create signals via utility functions
- The base POST /api/signals used for manual entry was overlooked
- Individual phase verification checked processing worked (it did for 6/7 paths)
- Integration verification found the missing 7th path

**Why this is critical:**
- Manual paste form is the PRIMARY UI entry point for signals
- Most users will create their first signal this way
- Without processing, the entire intelligence layer is disabled
- Breaks the main value proposition: "AI-powered signal analysis"

**Estimated effort:** 5 minutes to add code, 2 minutes to test, 3 minutes to verify E2E

---

*Plan created: 2026-01-24T07:00:00Z*
*Type: Gap closure (critical)*
*Blocking: Primary user workflow*
