# Plan 15-03: /ingest Endpoint and Processing Integration

**Goal**: Create the /ingest command endpoint and wire signal processing into existing creation flows
**Wave**: 2
**Execution**: autonomous

## Context

This plan creates the `/api/signals/ingest` endpoint (INTL-06 requirement) and integrates signal processing into existing signal creation flows using the queue-first async pattern.

**Key Decisions from Prior Phases:**
- v1.1 (13-02): Queue-first pattern - return 200 immediately, process via after()
- v1.1 (13-02): Never throw in after() context - log errors for debugging
- v1.1 (12-01): Default source to "paste" for manual signal entry
- v1.1 (12-01): Viewer access for GET, member access for POST/PATCH/DELETE signals

**Research Reference:** .planning/phases/15-signal-extraction-and-embedding/15-RESEARCH.md

## Tasks

### Task 1: Create /api/signals/ingest Endpoint

**Files:**
- `orchestrator/src/app/api/signals/ingest/route.ts`

**Action:**
Create POST endpoint that:

1. Accepts JSON body:
   ```typescript
   {
     workspaceId: string;      // Required
     rawInput: string;         // Required - the raw feedback text
     source?: SignalSource;    // Optional, defaults to "paste"
     interpretation?: string;  // Optional - user's interpretation
   }
   ```

2. Validation:
   - Return 400 if `workspaceId` missing
   - Return 400 if `rawInput` missing or empty string
   - Trim whitespace from rawInput

3. Permission check:
   - `await requireWorkspaceAccess(workspaceId, "member")`

4. Create signal:
   - Call `createSignal` with verbatim = rawInput.trim()
   - Source defaults to "paste" if not provided
   - Generate sourceRef: `ingest-${Date.now()}-${nanoid(6)}`

5. Queue processing with after():
   ```typescript
   after(async () => {
     try {
       await processSignalExtraction(signal.id);
     } catch (error) {
       console.error(`Failed to process signal ${signal.id}:`, error);
     }
   });
   ```

6. Return 201 response:
   ```typescript
   {
     success: true,
     signal: {
       id: string,
       status: "processing"  // Indicates extraction in progress
     },
     message: "Signal created. Extraction in progress."
   }
   ```

7. Error handling:
   - Handle PermissionError with handlePermissionError
   - Log and return 500 for other errors

**Verify:**
- Endpoint compiles without TypeScript errors
- POST returns 201 on success

**Done:**
- `/ingest` command creates signal and queues AI processing

### Task 2: Add Processing to Upload Endpoint

**Files:**
- `orchestrator/src/app/api/signals/upload/route.ts`

**Action:**
Modify existing upload endpoint to trigger signal processing:

1. Import `processSignalExtraction` from `@/lib/signals`

2. After signal creation (after the existing activity log after() block), add a new after() call:
   ```typescript
   // Queue AI extraction and embedding (Phase 15)
   after(async () => {
     try {
       await processSignalExtraction(signal!.id);
     } catch (error) {
       console.error(`Failed to process uploaded signal ${signal!.id}:`, error);
     }
   });
   ```

Note: Keep existing activity logging after() block separate - they're independent async operations.

**Verify:**
- File still compiles
- Existing tests still pass (if any)

**Done:**
- Uploaded files automatically get AI extraction and embedding

### Task 3: Add Processing to Video Endpoint

**Files:**
- `orchestrator/src/app/api/signals/video/route.ts`

**Action:**
Modify existing video endpoint to trigger signal processing:

1. Import `processSignalExtraction` from `@/lib/signals`

2. After signal creation, add after() call (same pattern as upload):
   ```typescript
   // Queue AI extraction and embedding (Phase 15)
   after(async () => {
     try {
       await processSignalExtraction(signal!.id);
     } catch (error) {
       console.error(`Failed to process video signal ${signal!.id}:`, error);
     }
   });
   ```

**Verify:**
- File still compiles

**Done:**
- Video caption signals automatically get AI extraction and embedding

### Task 4: Add Processing to Webhook Signals Endpoint

**Files:**
- `orchestrator/src/app/api/webhooks/signals/route.ts`

**Action:**
Modify existing webhook endpoint to trigger signal processing:

1. Import `processSignalExtraction` from `@/lib/signals`

2. After signal creation (after existing after() blocks), add:
   ```typescript
   // Queue AI extraction and embedding (Phase 15)
   after(async () => {
     try {
       await processSignalExtraction(signal!.id);
     } catch (error) {
       console.error(`Failed to process webhook signal ${signal!.id}:`, error);
     }
   });
   ```

**Verify:**
- File still compiles

**Done:**
- Webhook-ingested signals automatically get AI extraction and embedding

### Task 5: Add Processing to Pylon and Slack Endpoints

**Files:**
- `orchestrator/src/app/api/webhooks/pylon/route.ts`
- `orchestrator/src/app/api/webhooks/slack/events/route.ts`

**Action:**
For each endpoint that creates signals:

1. Import `processSignalExtraction` from `@/lib/signals`

2. After signal creation, add the same after() pattern:
   ```typescript
   after(async () => {
     try {
       await processSignalExtraction(signal!.id);
     } catch (error) {
       console.error(`Failed to process ${platform} signal ${signal!.id}:`, error);
     }
   });
   ```

**Verify:**
- Both files compile

**Done:**
- Pylon and Slack signals automatically get AI extraction and embedding

## Acceptance Criteria

- [ ] `/api/signals/ingest` endpoint exists and accepts POST
- [ ] `/ingest` creates signal with source defaulting to "paste"
- [ ] `/ingest` queues processing via after() (non-blocking)
- [ ] Upload endpoint triggers signal processing
- [ ] Video endpoint triggers signal processing
- [ ] Webhook signals endpoint triggers signal processing
- [ ] Pylon endpoint triggers signal processing
- [ ] Slack endpoint triggers signal processing
- [ ] All endpoints return immediately (queue-first pattern)

## Dependencies

**Depends on:**
- Plan 15-02 (Signal Processor - processSignalExtraction)
- Existing signal creation flows (upload, video, webhooks)
- Permission utilities from lib/permissions

**Enables:**
- Complete Phase 15 - signals from any source get AI processing
- Phase 16 (Classification & Clustering) - embeddings available for similarity search
