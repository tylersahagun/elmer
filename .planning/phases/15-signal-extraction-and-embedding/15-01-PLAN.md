# Plan 15-01: AI Infrastructure (Extraction & Embeddings)

**Goal**: Create the foundational AI modules for LLM extraction and OpenAI embeddings
**Wave**: 1
**Execution**: autonomous

## Context

This plan establishes the core AI infrastructure that Phase 15 builds upon. It creates two new modules in `lib/ai/`:
- `extraction.ts`: Uses existing Anthropic SDK pattern to extract severity, frequency, and userSegment from verbatim text
- `embeddings.ts`: Uses OpenAI SDK (new dependency) to generate text-embedding-3-small vectors

**Key Decisions from Prior Phases:**
- v1.1 (11-01): Union types for extensible enums (SignalSeverity, SignalFrequency)
- v1.1 (13-02): Never throw in after() context - log errors
- Base64 text embedding storage matches memoryEntries pattern

**Research Reference:** .planning/phases/15-signal-extraction-and-embedding/15-RESEARCH.md

## Tasks

### Task 1: Install OpenAI SDK and Add Environment Variable

**Files:**
- `orchestrator/package.json`
- `orchestrator/.env.example`

**Action:**
1. Install OpenAI SDK: `npm install openai`
2. Add `OPENAI_API_KEY` to `.env.example` under AI CONFIGURATION section with descriptive comment

**Verify:**
- `npm list openai` shows version ^4.x installed
- `.env.example` contains `OPENAI_API_KEY` entry

**Done:**
- OpenAI SDK available for import
- Environment variable pattern documented

### Task 2: Create Extraction Module

**Files:**
- `orchestrator/src/lib/ai/extraction.ts`

**Action:**
Create `lib/ai/extraction.ts` with:

1. Define `ExtractionResult` interface matching signal schema fields:
   ```typescript
   interface ExtractionResult {
     severity: SignalSeverity | null;
     frequency: SignalFrequency | null;
     userSegment: string | null;
     interpretation: string | null;
   }
   ```

2. Export `extractSignalFields(verbatim: string): Promise<ExtractionResult>` that:
   - Instantiates Anthropic client (same pattern as `/api/ai/generate/route.ts`)
   - Uses model `claude-sonnet-4-20250514`
   - System prompt instructs Claude to return ONLY valid JSON with the four fields
   - Includes severity guidance (critical/high/medium/low based on impact language)
   - Includes frequency guidance (common/occasional/rare based on recurrence mentions)
   - Includes userSegment guidance (enterprise/SMB/prosumer based on context clues)
   - Parses response with try/catch, returns all nulls on parse failure

3. Import SignalSeverity and SignalFrequency types from `@/lib/db/schema`

**Verify:**
- File compiles without TypeScript errors
- Function signature matches expected interface

**Done:**
- `extractSignalFields` function extracts structured data from verbatim text
- Returns null for fields that cannot be determined confidently

### Task 3: Create Embeddings Module

**Files:**
- `orchestrator/src/lib/ai/embeddings.ts`

**Action:**
Create `lib/ai/embeddings.ts` with:

1. Export `generateEmbedding(text: string): Promise<number[]>` that:
   - Instantiates OpenAI client with `process.env.OPENAI_API_KEY`
   - Cleans input (replace newlines with spaces, trim, truncate to 30000 chars)
   - Calls `openai.embeddings.create` with model `text-embedding-3-small`
   - Returns the embedding array from `response.data[0].embedding`

2. Export `embeddingToBase64(embedding: number[]): string` that:
   - Creates Float32Array from embedding
   - Converts to Buffer
   - Returns base64 encoded string

3. Export `base64ToEmbedding(base64: string): number[]` that:
   - Decodes base64 to Buffer
   - Creates Float32Array from buffer
   - Returns array of numbers

**Verify:**
- File compiles without TypeScript errors
- All three functions exported

**Done:**
- Embedding generation available via OpenAI text-embedding-3-small
- Base64 conversion utilities match memoryEntries pattern

### Task 4: Create lib/ai Index File

**Files:**
- `orchestrator/src/lib/ai/index.ts`

**Action:**
Create barrel export file:
```typescript
export * from './extraction';
export * from './embeddings';
```

**Verify:**
- Can import from `@/lib/ai` in other files

**Done:**
- Clean import path for AI utilities

## Acceptance Criteria

- [ ] OpenAI SDK installed (verify with `npm list openai`)
- [ ] `OPENAI_API_KEY` documented in `.env.example`
- [ ] `extractSignalFields` function exists and compiles
- [ ] `generateEmbedding` function exists and compiles
- [ ] `embeddingToBase64` and `base64ToEmbedding` functions exist
- [ ] All modules importable from `@/lib/ai`

## Dependencies

**Depends on:**
- Anthropic SDK pattern from `/api/ai/generate/route.ts`
- Signal schema types from `lib/db/schema.ts`

**Enables:**
- Plan 15-02 (Signal Processor)
- Plan 15-03 (/ingest endpoint)
