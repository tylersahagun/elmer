# Plan 01-02: Auth.js Configuration

## Frontmatter

```yaml
wave: 1
depends_on:
  - 01-01
files_modified:
  - orchestrator/src/auth.ts
  - orchestrator/src/app/api/auth/[...nextauth]/route.ts
  - orchestrator/src/types/next-auth.d.ts
  - orchestrator/package.json
  - orchestrator/package-lock.json
  - .env.local
autonomous: true
estimated_duration: 25min
```

## Objective

Configure Auth.js (NextAuth v5) with Drizzle adapter, JWT session strategy, and prepare for Google OAuth and Credentials providers. This establishes the authentication infrastructure used by all subsequent phases.

## Context

Schema extensions from Plan 01-01 provide the database tables. This plan configures Auth.js to use those tables via the Drizzle adapter. We configure JWT strategy (stateless sessions) for Edge compatibility.

## Tasks

<task name="Install Auth.js dependencies">

Install NextAuth v5 and the Drizzle adapter:

```bash
cd orchestrator
npm install next-auth@beta @auth/drizzle-adapter
```

**Verification:**
- [ ] `next-auth` (beta version) appears in package.json
- [ ] `@auth/drizzle-adapter` appears in package.json

</task>

<task name="Create Auth.js configuration file">

Create `orchestrator/src/auth.ts` with the core Auth.js configuration:

```typescript
import NextAuth from "next-auth"
import { DrizzleAdapter } from "@auth/drizzle-adapter"
import Google from "next-auth/providers/google"
import { db } from "@/lib/db"
import {
  users,
  accounts,
  sessions,
  verificationTokens,
} from "@/lib/db/schema"

export const { handlers, auth, signIn, signOut } = NextAuth({
  adapter: DrizzleAdapter(db, {
    usersTable: users,
    accountsTable: accounts,
    sessionsTable: sessions,
    verificationTokensTable: verificationTokens,
  }),
  session: {
    strategy: "jwt",
    maxAge: 30 * 24 * 60 * 60, // 30 days
  },
  providers: [
    Google({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    }),
    // Credentials provider will be added in Phase 2
  ],
  callbacks: {
    jwt: async ({ token, user }) => {
      // On sign in, add user id to token
      if (user) {
        token.id = user.id
      }
      return token
    },
    session: async ({ session, token }) => {
      // Add user id from token to session
      if (token?.id) {
        session.user.id = token.id as string
      }
      return session
    },
  },
  pages: {
    signIn: "/login",
    error: "/login",
  },
  debug: process.env.NODE_ENV === "development",
})
```

**Verification:**
- [ ] File exists at `orchestrator/src/auth.ts`
- [ ] Exports `handlers`, `auth`, `signIn`, `signOut`
- [ ] Uses JWT session strategy
- [ ] Drizzle adapter configured with schema tables
- [ ] Callbacks add user.id to session

</task>

<task name="Create Auth.js route handlers">

Create the Next.js route handlers at `orchestrator/src/app/api/auth/[...nextauth]/route.ts`:

```typescript
import { handlers } from "@/auth"

export const { GET, POST } = handlers
```

**Verification:**
- [ ] File exists at correct path
- [ ] Exports GET and POST handlers
- [ ] Directory structure: `app/api/auth/[...nextauth]/route.ts`

</task>

<task name="Create NextAuth type definitions">

Create `orchestrator/src/types/next-auth.d.ts` to extend session types:

```typescript
import { DefaultSession } from "next-auth"

declare module "next-auth" {
  interface Session {
    user: {
      id: string
    } & DefaultSession["user"]
  }
}

declare module "next-auth/jwt" {
  interface JWT {
    id?: string
  }
}
```

**Verification:**
- [ ] File exists at `orchestrator/src/types/next-auth.d.ts`
- [ ] Session.user.id is typed as string
- [ ] JWT.id is typed

</task>

<task name="Create auth helper functions">

Create `orchestrator/src/lib/auth/helpers.ts` for common auth operations:

```typescript
import { auth } from "@/auth"
import { redirect } from "next/navigation"

/**
 * Get the current authenticated user from the session.
 * Returns null if not authenticated.
 */
export async function getCurrentUser() {
  const session = await auth()
  return session?.user ?? null
}

/**
 * Require authentication. Redirects to login if not authenticated.
 * Use in Server Components and Server Actions.
 */
export async function requireAuth() {
  const session = await auth()
  if (!session?.user) {
    redirect("/login")
  }
  return session.user
}

/**
 * Get session for API routes.
 * Returns null if not authenticated.
 */
export async function getSessionForApi() {
  const session = await auth()
  return session
}
```

**Verification:**
- [ ] File exists at `orchestrator/src/lib/auth/helpers.ts`
- [ ] `getCurrentUser()` returns user or null
- [ ] `requireAuth()` redirects if not authenticated
- [ ] Functions use the `auth()` function from config

</task>

<task name="Set up environment variables">

Add required environment variables to `.env.local`:

```bash
# Auth.js Configuration
AUTH_SECRET=your-generated-secret-here
AUTH_URL=http://localhost:3000

# Google OAuth (placeholders - configure in Phase 2)
GOOGLE_CLIENT_ID=placeholder
GOOGLE_CLIENT_SECRET=placeholder
```

Generate AUTH_SECRET:

```bash
openssl rand -base64 32
```

**Important:** Do not commit `.env.local` to git.

**Verification:**
- [ ] `AUTH_SECRET` is set (not placeholder)
- [ ] `AUTH_URL` is set to `http://localhost:3000`
- [ ] `.env.local` is in `.gitignore`

</task>

<task name="Add environment variable validation">

Create `orchestrator/src/lib/auth/env.ts` for startup validation:

```typescript
/**
 * Validate required auth environment variables.
 * Call this at app startup to fail fast if misconfigured.
 */
export function validateAuthEnv() {
  const required = ["AUTH_SECRET"]
  const missing = required.filter((key) => !process.env[key])

  if (missing.length > 0) {
    throw new Error(
      `Missing required auth environment variables: ${missing.join(", ")}\n` +
        "Generate AUTH_SECRET with: openssl rand -base64 32"
    )
  }
}

// Warn about placeholder OAuth credentials in development
export function warnPlaceholderCredentials() {
  if (process.env.NODE_ENV === "development") {
    if (
      process.env.GOOGLE_CLIENT_ID === "placeholder" ||
      !process.env.GOOGLE_CLIENT_ID
    ) {
      console.warn(
        "[Auth] Google OAuth not configured. OAuth login will fail."
      )
    }
  }
}
```

**Verification:**
- [ ] File exists at `orchestrator/src/lib/auth/env.ts`
- [ ] `validateAuthEnv()` throws if AUTH_SECRET missing
- [ ] Warnings for placeholder credentials in dev

</task>

<task name="Export auth from lib index">

Create or update `orchestrator/src/lib/auth/index.ts`:

```typescript
export { getCurrentUser, requireAuth, getSessionForApi } from "./helpers"
export { validateAuthEnv, warnPlaceholderCredentials } from "./env"
```

**Verification:**
- [ ] All auth helpers exported from single entry point

</task>

<task name="Verify TypeScript compilation">

Ensure the auth configuration compiles without errors:

```bash
cd orchestrator
npx tsc --noEmit
```

Fix any TypeScript errors before proceeding.

**Verification:**
- [ ] TypeScript compilation succeeds
- [ ] No type errors in auth files

</task>

## Verification Criteria

After all tasks complete, verify:

1. **Auth.js config exists:** `src/auth.ts` exports handlers, auth, signIn, signOut
2. **Route handlers work:** `src/app/api/auth/[...nextauth]/route.ts` exists
3. **Types extended:** Session includes user.id
4. **Helpers available:** `getCurrentUser()` and `requireAuth()` exported
5. **TypeScript passes:** `npx tsc --noEmit` succeeds

## Must Haves

- [ ] Auth.js configured with JWT strategy
- [ ] Drizzle adapter connected to schema tables
- [ ] Route handlers at /api/auth/*
- [ ] Session extended with user.id
- [ ] AUTH_SECRET environment variable set
- [ ] TypeScript compilation succeeds

## Testing Auth Configuration

To verify Auth.js is working (without OAuth):

1. Start the dev server: `npm run dev`
2. Visit `http://localhost:3000/api/auth/providers`
3. Should return JSON with `google` provider listed
4. Visit `http://localhost:3000/api/auth/session`
5. Should return `null` (not authenticated)

Full OAuth testing requires Google credentials (Phase 2).

## Notes

- Google OAuth requires credentials from Google Cloud Console (configured in Phase 2)
- Credentials provider (email/password) added in Phase 2
- Protected routes middleware added in Phase 9
- This establishes the foundation; actual login/signup UI comes later

---
*Plan 01-02: Auth.js Configuration*
