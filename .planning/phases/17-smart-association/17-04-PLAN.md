---
phase: 17-smart-association
plan: 04
type: execute
wave: 2
depends_on: ["17-02"]
files_modified:
  - orchestrator/src/components/signals/BulkOperationsToolbar.tsx
  - orchestrator/src/components/signals/BulkLinkModal.tsx
  - orchestrator/src/components/signals/BulkUnlinkModal.tsx
  - orchestrator/src/components/signals/SignalsTable.tsx
  - orchestrator/src/components/signals/SignalRow.tsx
autonomous: true

must_haves:
  truths:
    - "User can select multiple signals using checkboxes"
    - "User can select/deselect all signals with header checkbox"
    - "Toolbar appears when signals are selected"
    - "User can bulk link selected signals to a project"
    - "User can bulk unlink selected signals from a project"
    - "Selection clears after successful bulk operation"
  artifacts:
    - path: "orchestrator/src/components/signals/BulkOperationsToolbar.tsx"
      provides: "Toolbar showing selection count and bulk actions"
      min_lines: 30
    - path: "orchestrator/src/components/signals/BulkLinkModal.tsx"
      provides: "Modal for selecting project to bulk link"
      min_lines: 50
    - path: "orchestrator/src/components/signals/BulkUnlinkModal.tsx"
      provides: "Modal for confirming bulk unlink"
      min_lines: 40
  key_links:
    - from: "BulkLinkModal.tsx"
      to: "/api/signals/bulk"
      via: "POST with action: 'link'"
      pattern: "api/signals/bulk.*link"
    - from: "BulkUnlinkModal.tsx"
      to: "/api/signals/bulk"
      via: "POST with action: 'unlink'"
      pattern: "api/signals/bulk.*unlink"
    - from: "SignalsTable.tsx"
      to: "selectedSignals state"
      via: "Set<string> state management"
      pattern: "selectedSignals"
---

<objective>
Add bulk operations UI to the signals table: checkbox selection, bulk toolbar, and bulk link/unlink modals.

Purpose: Enable efficient bulk association operations directly from the signals list.

Output: Multi-select capability in SignalsTable with BulkOperationsToolbar and modal dialogs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-smart-association/17-RESEARCH.md
@.planning/phases/17-smart-association/17-02-PLAN.md

# Source files
@orchestrator/src/components/signals/SignalsTable.tsx
@orchestrator/src/components/signals/SignalRow.tsx
@orchestrator/src/components/signals/ProjectLinkCombobox.tsx
@orchestrator/src/components/projects/SignalPickerModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BulkOperationsToolbar Component</name>
  <files>orchestrator/src/components/signals/BulkOperationsToolbar.tsx</files>
  <action>
Create `orchestrator/src/components/signals/BulkOperationsToolbar.tsx`:

```typescript
"use client";

import { Link2, Unlink, X } from "lucide-react";
import { Button } from "@/components/ui/button";

interface BulkOperationsToolbarProps {
  selectedCount: number;
  onBulkLink: () => void;
  onBulkUnlink: () => void;
  onClearSelection: () => void;
}

export function BulkOperationsToolbar({
  selectedCount,
  onBulkLink,
  onBulkUnlink,
  onClearSelection,
}: BulkOperationsToolbarProps) {
  return (
    <div className="flex items-center gap-3 px-4 py-2 bg-blue-500/10 border border-blue-500/30 rounded-lg mb-4">
      <span className="text-sm font-medium">
        {selectedCount} signal{selectedCount !== 1 ? "s" : ""} selected
      </span>

      <div className="h-4 w-px bg-border" />

      <Button
        size="sm"
        variant="outline"
        onClick={onBulkLink}
        className="gap-1.5"
      >
        <Link2 className="w-3.5 h-3.5" />
        Link to Project
      </Button>

      <Button
        size="sm"
        variant="outline"
        onClick={onBulkUnlink}
        className="gap-1.5 text-red-400 hover:text-red-300 border-red-500/30 hover:border-red-500/50"
      >
        <Unlink className="w-3.5 h-3.5" />
        Unlink
      </Button>

      <div className="flex-1" />

      <Button
        size="sm"
        variant="ghost"
        onClick={onClearSelection}
        className="gap-1.5 text-muted-foreground"
      >
        <X className="w-3.5 h-3.5" />
        Clear
      </Button>
    </div>
  );
}
```
  </action>
  <verify>
- TypeScript compiles: `cd orchestrator && npx tsc --noEmit`
- File exists: `ls orchestrator/src/components/signals/BulkOperationsToolbar.tsx`
  </verify>
  <done>
- BulkOperationsToolbar component exists
- Shows selection count and action buttons
- Has Link, Unlink, and Clear actions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Bulk Link and Unlink Modals</name>
  <files>
    orchestrator/src/components/signals/BulkLinkModal.tsx
    orchestrator/src/components/signals/BulkUnlinkModal.tsx
  </files>
  <action>
**Create BulkLinkModal.tsx:**

```typescript
"use client";

import { useState } from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { Loader2 } from "lucide-react";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { ProjectLinkCombobox } from "./ProjectLinkCombobox";

interface BulkLinkModalProps {
  isOpen: boolean;
  onClose: () => void;
  selectedSignalIds: string[];
  workspaceId: string;
  onSuccess?: () => void;
}

export function BulkLinkModal({
  isOpen,
  onClose,
  selectedSignalIds,
  workspaceId,
  onSuccess,
}: BulkLinkModalProps) {
  const [projectId, setProjectId] = useState<string | null>(null);
  const queryClient = useQueryClient();

  const bulkLinkMutation = useMutation({
    mutationFn: async () => {
      const res = await fetch("/api/signals/bulk", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "link",
          signalIds: selectedSignalIds,
          projectId,
        }),
      });
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || "Bulk link failed");
      }
      return res.json();
    },
    onSuccess: (data) => {
      queryClient.invalidateQueries({ queryKey: ["signals", workspaceId] });
      queryClient.invalidateQueries({ queryKey: ["signal-suggestions", workspaceId] });
      onSuccess?.();
      onClose();
    },
  });

  const handleClose = () => {
    setProjectId(null);
    onClose();
  };

  return (
    <Dialog open={isOpen} onOpenChange={(open) => !open && handleClose()}>
      <DialogContent className="sm:max-w-[425px]">
        <DialogHeader>
          <DialogTitle>
            Link {selectedSignalIds.length} Signal{selectedSignalIds.length !== 1 ? "s" : ""}
          </DialogTitle>
          <DialogDescription>
            Select a project to link the selected signals to.
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <div className="space-y-2">
            <Label>Select Project</Label>
            <ProjectLinkCombobox
              workspaceId={workspaceId}
              onSelect={setProjectId}
              placeholder="Search projects..."
            />
          </div>

          <p className="text-xs text-muted-foreground">
            Signals already linked to this project will be skipped.
          </p>

          {bulkLinkMutation.isError && (
            <p className="text-xs text-red-400">
              {bulkLinkMutation.error.message}
            </p>
          )}

          {bulkLinkMutation.isSuccess && bulkLinkMutation.data && (
            <p className="text-xs text-green-400">
              {bulkLinkMutation.data.message}
            </p>
          )}
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={handleClose}>
            Cancel
          </Button>
          <Button
            onClick={() => bulkLinkMutation.mutate()}
            disabled={!projectId || bulkLinkMutation.isPending}
          >
            {bulkLinkMutation.isPending && (
              <Loader2 className="w-4 h-4 mr-2 animate-spin" />
            )}
            Link Signals
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

**Create BulkUnlinkModal.tsx:**

```typescript
"use client";

import { useState } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Loader2 } from "lucide-react";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { ProjectLinkCombobox } from "./ProjectLinkCombobox";

interface BulkUnlinkModalProps {
  isOpen: boolean;
  onClose: () => void;
  selectedSignalIds: string[];
  workspaceId: string;
  onSuccess?: () => void;
}

export function BulkUnlinkModal({
  isOpen,
  onClose,
  selectedSignalIds,
  workspaceId,
  onSuccess,
}: BulkUnlinkModalProps) {
  const [projectId, setProjectId] = useState<string | null>(null);
  const queryClient = useQueryClient();

  const bulkUnlinkMutation = useMutation({
    mutationFn: async () => {
      const res = await fetch("/api/signals/bulk", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "unlink",
          signalIds: selectedSignalIds,
          projectId,
        }),
      });
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || "Bulk unlink failed");
      }
      return res.json();
    },
    onSuccess: (data) => {
      queryClient.invalidateQueries({ queryKey: ["signals", workspaceId] });
      queryClient.invalidateQueries({ queryKey: ["project-signals"] });
      onSuccess?.();
      onClose();
    },
  });

  const handleClose = () => {
    setProjectId(null);
    onClose();
  };

  return (
    <Dialog open={isOpen} onOpenChange={(open) => !open && handleClose()}>
      <DialogContent className="sm:max-w-[425px]">
        <DialogHeader>
          <DialogTitle>
            Unlink {selectedSignalIds.length} Signal{selectedSignalIds.length !== 1 ? "s" : ""}
          </DialogTitle>
          <DialogDescription>
            Select a project to unlink the selected signals from.
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <div className="space-y-2">
            <Label>Select Project</Label>
            <ProjectLinkCombobox
              workspaceId={workspaceId}
              onSelect={setProjectId}
              placeholder="Search projects..."
            />
          </div>

          <p className="text-xs text-muted-foreground">
            Only signals currently linked to this project will be unlinked.
            Signals not linked to this project will be skipped.
          </p>

          {bulkUnlinkMutation.isError && (
            <p className="text-xs text-red-400">
              {bulkUnlinkMutation.error.message}
            </p>
          )}

          {bulkUnlinkMutation.isSuccess && bulkUnlinkMutation.data && (
            <p className="text-xs text-green-400">
              {bulkUnlinkMutation.data.message}
            </p>
          )}
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={handleClose}>
            Cancel
          </Button>
          <Button
            variant="destructive"
            onClick={() => bulkUnlinkMutation.mutate()}
            disabled={!projectId || bulkUnlinkMutation.isPending}
          >
            {bulkUnlinkMutation.isPending && (
              <Loader2 className="w-4 h-4 mr-2 animate-spin" />
            )}
            Unlink Signals
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```
  </action>
  <verify>
- TypeScript compiles: `cd orchestrator && npx tsc --noEmit`
- Files exist: `ls orchestrator/src/components/signals/Bulk*.tsx`
  </verify>
  <done>
- BulkLinkModal component exists with project selection
- BulkUnlinkModal component exists with project selection
- Both modals call /api/signals/bulk with appropriate action
- Both modals invalidate queries and call onSuccess callback
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Multi-Select to SignalsTable and SignalRow</name>
  <files>
    orchestrator/src/components/signals/SignalsTable.tsx
    orchestrator/src/components/signals/SignalRow.tsx
  </files>
  <action>
**Update SignalRow.tsx to add checkbox:**

Add a new prop to SignalRow interface:
```typescript
interface SignalRowProps {
  signal: Signal;
  onView: (signal: Signal) => void;
  onDelete: (id: string) => void;
  // Add these new props:
  isSelected?: boolean;
  onToggleSelect?: (id: string) => void;
}
```

Add checkbox as first cell in the row (inside the `<tr>`):
```tsx
{onToggleSelect && (
  <td className="py-3 px-2 w-10">
    <Checkbox
      checked={isSelected}
      onCheckedChange={() => onToggleSelect(signal.id)}
      onClick={(e) => e.stopPropagation()}
    />
  </td>
)}
```

Add import for Checkbox at top:
```typescript
import { Checkbox } from "@/components/ui/checkbox";
```

**Update SignalsTable.tsx to add selection state and toolbar:**

1. Add imports at top:
```typescript
import { Checkbox } from "@/components/ui/checkbox";
import { BulkOperationsToolbar } from "./BulkOperationsToolbar";
import { BulkLinkModal } from "./BulkLinkModal";
import { BulkUnlinkModal } from "./BulkUnlinkModal";
```

2. Add state for selection and modals (after existing state declarations):
```typescript
// Selection state
const [selectedSignals, setSelectedSignals] = useState<Set<string>>(new Set());
const [showBulkLinkModal, setShowBulkLinkModal] = useState(false);
const [showBulkUnlinkModal, setShowBulkUnlinkModal] = useState(false);

// Reset selection when signals change (page change, filter change, etc.)
useEffect(() => {
  setSelectedSignals(new Set());
}, [data?.signals]);
```

3. Add selection handlers:
```typescript
const toggleSignalSelection = (id: string) => {
  setSelectedSignals((prev) => {
    const next = new Set(prev);
    if (next.has(id)) {
      next.delete(id);
    } else {
      next.add(id);
    }
    return next;
  });
};

const toggleAllSelection = () => {
  if (selectedSignals.size === signals.length) {
    setSelectedSignals(new Set());
  } else {
    setSelectedSignals(new Set(signals.map((s) => s.id)));
  }
};

const clearSelection = () => {
  setSelectedSignals(new Set());
};
```

4. Add BulkOperationsToolbar before the table (inside the `{!isLoading && !isError && signals.length > 0 && (` block, before `<div className="border ...`):
```tsx
{/* Bulk Operations Toolbar */}
{selectedSignals.size > 0 && (
  <BulkOperationsToolbar
    selectedCount={selectedSignals.size}
    onBulkLink={() => setShowBulkLinkModal(true)}
    onBulkUnlink={() => setShowBulkUnlinkModal(true)}
    onClearSelection={clearSelection}
  />
)}
```

5. Add checkbox column header in the table thead (as first th):
```tsx
<th className="py-3 px-2 w-10">
  <Checkbox
    checked={selectedSignals.size === signals.length && signals.length > 0}
    // Show indeterminate when some but not all selected
    ref={(el) => {
      if (el) {
        (el as HTMLButtonElement).dataset.state =
          selectedSignals.size > 0 && selectedSignals.size < signals.length
            ? "indeterminate"
            : selectedSignals.size === signals.length && signals.length > 0
              ? "checked"
              : "unchecked";
      }
    }}
    onCheckedChange={toggleAllSelection}
  />
</th>
```

Note: For the indeterminate state, the Checkbox component from shadcn uses data-state attribute. If the above ref approach doesn't work visually, you can simplify to just checked/unchecked:
```tsx
<th className="py-3 px-2 w-10">
  <Checkbox
    checked={selectedSignals.size === signals.length && signals.length > 0}
    onCheckedChange={toggleAllSelection}
  />
</th>
```

6. Update SignalRow rendering to pass selection props:
```tsx
<SignalRow
  key={signal.id}
  signal={signal}
  onView={onViewSignal}
  onDelete={(id) => deleteMutation.mutate(id)}
  isSelected={selectedSignals.has(signal.id)}
  onToggleSelect={toggleSignalSelection}
/>
```

7. Add modals at the end of the component (before the closing `</div>` of the main container):
```tsx
{/* Bulk Modals */}
<BulkLinkModal
  isOpen={showBulkLinkModal}
  onClose={() => setShowBulkLinkModal(false)}
  selectedSignalIds={Array.from(selectedSignals)}
  workspaceId={workspaceId}
  onSuccess={clearSelection}
/>
<BulkUnlinkModal
  isOpen={showBulkUnlinkModal}
  onClose={() => setShowBulkUnlinkModal(false)}
  selectedSignalIds={Array.from(selectedSignals)}
  workspaceId={workspaceId}
  onSuccess={clearSelection}
/>
```
  </action>
  <verify>
- TypeScript compiles: `cd orchestrator && npx tsc --noEmit`
- Grep for selection state: `grep -n "selectedSignals" orchestrator/src/components/signals/SignalsTable.tsx`
- Grep for checkbox in row: `grep -n "Checkbox" orchestrator/src/components/signals/SignalRow.tsx`
  </verify>
  <done>
- SignalRow has optional checkbox controlled by isSelected/onToggleSelect props
- SignalsTable has selectedSignals state (Set<string>)
- Header checkbox toggles all visible signals
- BulkOperationsToolbar shows when signals selected
- BulkLinkModal and BulkUnlinkModal are rendered and functional
- Selection clears on successful bulk operation
  </done>
</task>

</tasks>

<verification>
- [ ] TypeScript compiles without errors
- [ ] BulkOperationsToolbar shows selection count and actions
- [ ] BulkLinkModal allows selecting project and bulk linking
- [ ] BulkUnlinkModal allows selecting project and bulk unlinking
- [ ] SignalsTable has checkbox column for selection
- [ ] Header checkbox toggles all/none selection
- [ ] Individual row checkboxes toggle single selection
- [ ] Toolbar appears when at least one signal is selected
- [ ] Selection clears after successful bulk operation
</verification>

<success_criteria>
- Users can multi-select signals using checkboxes
- Header checkbox selects/deselects all visible signals
- Bulk toolbar appears with selection count when signals selected
- Link to Project opens modal for project selection and bulk links
- Unlink opens modal for project selection and bulk unlinks
- Selection clears automatically after successful operation
- Clicking row checkbox doesn't trigger row click (view detail)
</success_criteria>

<output>
After completion, create `.planning/phases/17-smart-association/17-04-SUMMARY.md`
</output>
