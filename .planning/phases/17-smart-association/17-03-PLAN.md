---
phase: 17-smart-association
plan: 03
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - orchestrator/src/components/signals/SuggestionCard.tsx
  - orchestrator/src/components/signals/SignalSuggestionsBanner.tsx
  - orchestrator/src/app/[workspaceId]/signals/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can see AI suggestions for unlinked signals"
    - "User can accept a suggestion (links signal to suggested project)"
    - "User can reject a suggestion (dismisses it)"
    - "User can modify and accept a suggestion (link to different project)"
    - "Accepted/rejected suggestions disappear from the list"
  artifacts:
    - path: "orchestrator/src/components/signals/SuggestionCard.tsx"
      provides: "Individual suggestion display with accept/reject/modify actions"
      min_lines: 50
    - path: "orchestrator/src/components/signals/SignalSuggestionsBanner.tsx"
      provides: "Collapsible banner showing AI suggestions"
      min_lines: 80
  key_links:
    - from: "SignalSuggestionsBanner.tsx"
      to: "/api/signals/suggestions"
      via: "useQuery fetch"
      pattern: "api/signals/suggestions"
    - from: "SuggestionCard.tsx"
      to: "/api/signals/[id]/projects"
      via: "POST mutation on accept"
      pattern: "api/signals.*projects"
    - from: "SuggestionCard.tsx"
      to: "/api/signals/[id]/suggestions/dismiss"
      via: "POST mutation on reject"
      pattern: "suggestions/dismiss"
---

<objective>
Create the suggestions UI components: a collapsible banner showing AI suggestions with accept/reject/modify actions.

Purpose: Allow users to review and act on AI-suggested signal-to-project associations.

Output: SignalSuggestionsBanner and SuggestionCard components integrated into the signals page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-smart-association/17-RESEARCH.md
@.planning/phases/17-smart-association/17-01-PLAN.md

# Source files
@orchestrator/src/components/signals/SignalsTable.tsx
@orchestrator/src/components/signals/ProjectLinkCombobox.tsx
@orchestrator/src/app/[workspaceId]/signals/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SuggestionCard Component</name>
  <files>orchestrator/src/components/signals/SuggestionCard.tsx</files>
  <action>
Create `orchestrator/src/components/signals/SuggestionCard.tsx`:

```typescript
"use client";

import { useState } from "react";
import { Check, X, Edit2, Loader2 } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { cn } from "@/lib/utils";
import { ProjectLinkCombobox } from "./ProjectLinkCombobox";

interface SuggestionCardProps {
  suggestion: {
    signalId: string;
    verbatim: string;
    source: string;
    projectId: string;
    projectName: string;
    confidence: number;
    reason?: string;
  };
  workspaceId: string;
  onAccept: (signalId: string, projectId: string) => void;
  onReject: (signalId: string) => void;
  isAccepting?: boolean;
  isRejecting?: boolean;
}

const SOURCE_COLORS: Record<string, string> = {
  paste: "bg-purple-500/20 text-purple-300 border-purple-500/30",
  webhook: "bg-teal-500/20 text-teal-300 border-teal-500/30",
  interview: "bg-emerald-500/20 text-emerald-300 border-emerald-500/30",
  slack: "bg-blue-500/20 text-blue-300 border-blue-500/30",
  pylon: "bg-orange-500/20 text-orange-300 border-orange-500/30",
  video: "bg-red-500/20 text-red-300 border-red-500/30",
  email: "bg-cyan-500/20 text-cyan-300 border-cyan-500/30",
  other: "bg-gray-500/20 text-gray-300 border-gray-500/30",
};

export function SuggestionCard({
  suggestion,
  workspaceId,
  onAccept,
  onReject,
  isAccepting = false,
  isRejecting = false,
}: SuggestionCardProps) {
  const [isEditing, setIsEditing] = useState(false);
  const [selectedProjectId, setSelectedProjectId] = useState(suggestion.projectId);

  const confidenceColor =
    suggestion.confidence >= 0.8
      ? "text-green-400"
      : suggestion.confidence >= 0.6
        ? "text-amber-400"
        : "text-slate-400";

  const handleAccept = () => {
    onAccept(suggestion.signalId, selectedProjectId);
  };

  const handleConfirmEdit = () => {
    onAccept(suggestion.signalId, selectedProjectId);
    setIsEditing(false);
  };

  const isPending = isAccepting || isRejecting;

  return (
    <div className="flex items-start gap-3 p-3 rounded-lg bg-muted/30 border border-border/50">
      <div className="flex-1 min-w-0">
        {/* Verbatim */}
        <p className="text-sm line-clamp-2 mb-2">{suggestion.verbatim}</p>

        {/* Metadata row */}
        <div className="flex flex-wrap items-center gap-2 text-xs">
          <Badge
            className={cn(
              "text-[10px]",
              SOURCE_COLORS[suggestion.source] || SOURCE_COLORS.other
            )}
          >
            {suggestion.source}
          </Badge>

          {isEditing ? (
            <div className="flex items-center gap-2">
              <span className="text-muted-foreground">Link to:</span>
              <ProjectLinkCombobox
                workspaceId={workspaceId}
                onSelect={(id) => setSelectedProjectId(id || suggestion.projectId)}
                placeholder="Select project..."
              />
              <Button
                size="sm"
                variant="ghost"
                className="h-6 px-2 text-green-400 hover:text-green-300"
                onClick={handleConfirmEdit}
                disabled={isPending}
              >
                {isAccepting ? (
                  <Loader2 className="w-3 h-3 animate-spin" />
                ) : (
                  <Check className="w-3 h-3" />
                )}
              </Button>
              <Button
                size="sm"
                variant="ghost"
                className="h-6 px-2 text-muted-foreground hover:text-foreground"
                onClick={() => {
                  setIsEditing(false);
                  setSelectedProjectId(suggestion.projectId);
                }}
              >
                Cancel
              </Button>
            </div>
          ) : (
            <>
              <span className="text-muted-foreground">Suggested:</span>
              <Badge className="bg-blue-500/20 text-blue-300 border-blue-500/30">
                {suggestion.projectName}
              </Badge>
              <span className={confidenceColor}>
                {Math.round(suggestion.confidence * 100)}% confident
              </span>
            </>
          )}
        </div>

        {/* Reason if available */}
        {suggestion.reason && !isEditing && (
          <p className="text-[10px] text-muted-foreground mt-1 italic">
            {suggestion.reason}
          </p>
        )}
      </div>

      {/* Actions */}
      {!isEditing && (
        <div className="flex items-center gap-1 flex-shrink-0">
          <Button
            size="sm"
            variant="ghost"
            className="h-7 w-7 p-0 text-green-400 hover:text-green-300 hover:bg-green-500/10"
            onClick={handleAccept}
            disabled={isPending}
            title="Accept suggestion"
          >
            {isAccepting ? (
              <Loader2 className="w-4 h-4 animate-spin" />
            ) : (
              <Check className="w-4 h-4" />
            )}
          </Button>
          <Button
            size="sm"
            variant="ghost"
            className="h-7 w-7 p-0 text-muted-foreground hover:text-foreground hover:bg-muted"
            onClick={() => setIsEditing(true)}
            disabled={isPending}
            title="Edit suggestion"
          >
            <Edit2 className="w-4 h-4" />
          </Button>
          <Button
            size="sm"
            variant="ghost"
            className="h-7 w-7 p-0 text-red-400 hover:text-red-300 hover:bg-red-500/10"
            onClick={() => onReject(suggestion.signalId)}
            disabled={isPending}
            title="Dismiss suggestion"
          >
            {isRejecting ? (
              <Loader2 className="w-4 h-4 animate-spin" />
            ) : (
              <X className="w-4 h-4" />
            )}
          </Button>
        </div>
      )}
    </div>
  );
}
```
  </action>
  <verify>
- TypeScript compiles: `cd orchestrator && npx tsc --noEmit`
- File exists: `ls orchestrator/src/components/signals/SuggestionCard.tsx`
  </verify>
  <done>
- SuggestionCard component exists with accept/reject/edit actions
- Displays verbatim, source badge, suggested project, confidence
- Edit mode allows changing target project before accepting
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SignalSuggestionsBanner Component</name>
  <files>orchestrator/src/components/signals/SignalSuggestionsBanner.tsx</files>
  <action>
Create `orchestrator/src/components/signals/SignalSuggestionsBanner.tsx`:

```typescript
"use client";

import { useState } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Sparkles, ChevronDown, X, Loader2 } from "lucide-react";
import { Button } from "@/components/ui/button";
import { cn } from "@/lib/utils";
import { SuggestionCard } from "./SuggestionCard";

interface Suggestion {
  signalId: string;
  verbatim: string;
  source: string;
  projectId: string;
  projectName: string;
  confidence: number;
  reason?: string;
}

interface SignalSuggestionsBannerProps {
  workspaceId: string;
}

export function SignalSuggestionsBanner({ workspaceId }: SignalSuggestionsBannerProps) {
  const [isExpanded, setIsExpanded] = useState(true);
  const [isDismissedAll, setIsDismissedAll] = useState(false);
  const [pendingAccept, setPendingAccept] = useState<string | null>(null);
  const [pendingReject, setPendingReject] = useState<string | null>(null);
  const queryClient = useQueryClient();

  // Fetch suggestions
  const { data, isLoading } = useQuery({
    queryKey: ["signal-suggestions", workspaceId],
    queryFn: async () => {
      const res = await fetch(`/api/signals/suggestions?workspaceId=${workspaceId}`);
      if (!res.ok) throw new Error("Failed to fetch suggestions");
      return res.json() as Promise<{ suggestions: Suggestion[] }>;
    },
    staleTime: 5 * 60 * 1000, // Cache for 5 minutes
  });

  // Accept suggestion = link signal to project
  const acceptMutation = useMutation({
    mutationFn: async ({ signalId, projectId }: { signalId: string; projectId: string }) => {
      const res = await fetch(`/api/signals/${signalId}/projects`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          projectId,
          linkReason: "AI-suggested association accepted by user",
        }),
      });
      if (!res.ok) throw new Error("Failed to link signal");
      return res.json();
    },
    onMutate: ({ signalId }) => {
      setPendingAccept(signalId);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["signal-suggestions", workspaceId] });
      queryClient.invalidateQueries({ queryKey: ["signals", workspaceId] });
    },
    onSettled: () => {
      setPendingAccept(null);
    },
  });

  // Reject suggestion = dismiss
  const rejectMutation = useMutation({
    mutationFn: async (signalId: string) => {
      const res = await fetch(`/api/signals/${signalId}/suggestions/dismiss`, {
        method: "POST",
      });
      if (!res.ok) throw new Error("Failed to dismiss suggestion");
      return res.json();
    },
    onMutate: (signalId) => {
      setPendingReject(signalId);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["signal-suggestions", workspaceId] });
    },
    onSettled: () => {
      setPendingReject(null);
    },
  });

  const suggestions = data?.suggestions || [];

  // Don't render if no suggestions, dismissed all, or loading
  if (isDismissedAll || (suggestions.length === 0 && !isLoading)) {
    return null;
  }

  const handleAccept = (signalId: string, projectId: string) => {
    acceptMutation.mutate({ signalId, projectId });
  };

  const handleReject = (signalId: string) => {
    rejectMutation.mutate(signalId);
  };

  return (
    <div className="border border-blue-500/30 rounded-lg bg-blue-500/5 mb-4">
      {/* Header */}
      <button
        onClick={() => setIsExpanded(!isExpanded)}
        className="w-full flex items-center justify-between p-3 text-left"
      >
        <div className="flex items-center gap-2">
          <Sparkles className="w-4 h-4 text-blue-400" />
          <span className="font-medium text-sm">
            AI Suggestions
            {!isLoading && suggestions.length > 0 && (
              <span className="ml-1 text-muted-foreground">
                ({suggestions.length})
              </span>
            )}
          </span>
        </div>
        <div className="flex items-center gap-2">
          <Button
            size="sm"
            variant="ghost"
            className="h-6 px-2 text-xs text-muted-foreground hover:text-foreground"
            onClick={(e) => {
              e.stopPropagation();
              setIsDismissedAll(true);
            }}
          >
            <X className="w-3 h-3 mr-1" />
            Dismiss All
          </Button>
          <ChevronDown
            className={cn(
              "w-4 h-4 text-muted-foreground transition-transform",
              isExpanded && "rotate-180"
            )}
          />
        </div>
      </button>

      {/* Content */}
      {isExpanded && (
        <div className="border-t border-blue-500/20 p-3">
          {isLoading ? (
            <div className="flex items-center justify-center py-4">
              <Loader2 className="w-5 h-5 animate-spin text-muted-foreground" />
            </div>
          ) : suggestions.length === 0 ? (
            <p className="text-sm text-muted-foreground text-center py-2">
              No suggestions available
            </p>
          ) : (
            <div className="space-y-2">
              {suggestions.map((suggestion) => (
                <SuggestionCard
                  key={suggestion.signalId}
                  suggestion={suggestion}
                  workspaceId={workspaceId}
                  onAccept={handleAccept}
                  onReject={handleReject}
                  isAccepting={pendingAccept === suggestion.signalId}
                  isRejecting={pendingReject === suggestion.signalId}
                />
              ))}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```
  </action>
  <verify>
- TypeScript compiles: `cd orchestrator && npx tsc --noEmit`
- File exists: `ls orchestrator/src/components/signals/SignalSuggestionsBanner.tsx`
  </verify>
  <done>
- SignalSuggestionsBanner component exists
- Fetches suggestions via React Query
- Displays collapsible list of SuggestionCards
- Handles accept (link) and reject (dismiss) mutations
- Has "Dismiss All" button to hide banner
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate Banner into Signals Page</name>
  <files>orchestrator/src/app/[workspaceId]/signals/page.tsx</files>
  <action>
Update the signals page to include the SignalSuggestionsBanner above the SignalsTable.

1. Add import at top of file:
```typescript
import { SignalSuggestionsBanner } from "@/components/signals/SignalSuggestionsBanner";
```

2. Add the banner component just before the SignalsTable (inside the main content area, after the page header/title but before the table):

```tsx
{/* AI Suggestions Banner */}
<SignalSuggestionsBanner workspaceId={workspaceId} />

{/* Existing SignalsTable */}
<SignalsTable
  workspaceId={workspaceId}
  // ... existing props
/>
```

The banner will auto-hide when there are no suggestions, so it won't take space when not needed.
  </action>
  <verify>
- TypeScript compiles: `cd orchestrator && npx tsc --noEmit`
- Grep for import: `grep -n "SignalSuggestionsBanner" orchestrator/src/app/[workspaceId]/signals/page.tsx`
- Dev server shows banner on signals page when suggestions exist
  </verify>
  <done>
- SignalSuggestionsBanner imported in signals page
- Banner renders above SignalsTable
- Banner shows when suggestions exist, hides when empty
  </done>
</task>

</tasks>

<verification>
- [ ] TypeScript compiles without errors
- [ ] SuggestionCard displays suggestion with confidence and actions
- [ ] SignalSuggestionsBanner fetches and displays suggestions
- [ ] Accept action links signal to suggested project
- [ ] Reject action dismisses suggestion
- [ ] Edit mode allows changing target project
- [ ] Banner integrated into signals page
- [ ] Banner hides when no suggestions available
</verification>

<success_criteria>
- Users can see AI suggestions in a collapsible banner
- Users can accept suggestions (creates link, removes from list)
- Users can reject suggestions (dismisses, removes from list)
- Users can modify suggestion before accepting (different project)
- Banner auto-hides when no suggestions exist
- All mutations invalidate appropriate queries for fresh data
</success_criteria>

<output>
After completion, create `.planning/phases/17-smart-association/17-03-SUMMARY.md`
</output>
