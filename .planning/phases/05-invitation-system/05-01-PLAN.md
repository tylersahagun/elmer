# Plan 05-01: Invitation Service and API Endpoints

## Frontmatter

```yaml
plan_id: "05-01"
phase: 5
wave: 1
depends_on: ["04-01", "04-03"]
files_modified:
  - orchestrator/src/lib/invitations.ts
  - orchestrator/src/app/api/workspaces/[id]/invitations/route.ts
  - orchestrator/src/lib/db/queries.ts
autonomous: true
estimated_duration: "20 minutes"
```

## Objective

Create the invitation service with token generation and API endpoints for creating and listing invitations.

## Context

**Existing infrastructure:**
- `invitations` table exists in schema with token, email, role, expiresAt
- Workspace members table for adding accepted invitations
- Auth system working

**This plan adds:**
- Invitation creation API (POST)
- Invitation listing API (GET)
- Secure token generation
- Expiration handling (7 days)

## Tasks

<task id="1" name="Create Invitation Service">
<description>
Create a service module for invitation logic including token generation and validation.
</description>
<files>
- orchestrator/src/lib/invitations.ts
</files>
<instructions>
1. Create `orchestrator/src/lib/invitations.ts`
2. Add `generateInviteToken()` using crypto.randomUUID or nanoid
3. Add `createInvitation(workspaceId, email, role, invitedBy)` function
4. Add `getInvitationByToken(token)` function
5. Add `acceptInvitation(token, userId)` function
6. Set expiration to 7 days from creation
</instructions>
<verification>
- [ ] Token generation is cryptographically secure
- [ ] Expiration is set correctly
- [ ] Functions handle errors gracefully
</verification>
</task>

<task id="2" name="Add Invitation Query Functions">
<description>
Add database query functions for invitations.
</description>
<files>
- orchestrator/src/lib/db/queries.ts
</files>
<instructions>
1. Add `getWorkspaceInvitations(workspaceId)` - list pending invitations
2. Add `getInvitationByToken(token)` - for accepting
3. Add `deleteInvitation(id)` - for revoking
4. Include workspace and inviter info in results
</instructions>
<verification>
- [ ] Can list invitations for a workspace
- [ ] Can fetch invitation by token
- [ ] Can delete invitation
</verification>
</task>

<task id="3" name="Create Invitation API Routes">
<description>
Create API endpoints for invitation CRUD operations.
</description>
<files>
- orchestrator/src/app/api/workspaces/[id]/invitations/route.ts
</files>
<instructions>
1. Create POST endpoint to create invitation
   - Require admin role
   - Validate email format
   - Generate token and create invitation
   - Return invitation with shareable link
2. Create GET endpoint to list invitations
   - Require admin role
   - Return pending invitations with status
3. Include invitation link in response (for copy/share)
</instructions>
<verification>
- [ ] POST creates invitation with token
- [ ] GET lists workspace invitations
- [ ] Only admins can access
- [ ] Returns shareable link
</verification>
</task>

## Verification Criteria

After all tasks complete, verify:

1. **Invitation creation:**
   - Admin can create invitation via API
   - Token is generated securely
   - Expiration is set to 7 days

2. **Invitation listing:**
   - Admin can see pending invitations
   - Shows email, role, expiration

3. **Security:**
   - Non-admins cannot create invitations
   - Tokens are unique and secure

## must_haves

- [ ] Secure token generation
- [ ] 7-day expiration
- [ ] Admin-only access
- [ ] Shareable invitation link

---
*Plan 05-01 | Phase 5 | Wave 1*
