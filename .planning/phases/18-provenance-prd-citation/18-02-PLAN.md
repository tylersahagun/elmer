---
phase: 18-provenance-prd-citation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - orchestrator/src/lib/execution/stage-executors/prd-executor.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "PRD generation fetches linked signals as evidence"
    - "Generated PRD includes 'Supporting User Evidence' section"
    - "Signals are cited with source and severity"
    - "Maximum 10 signals included to prevent context bloat"
  artifacts:
    - path: "orchestrator/src/lib/execution/stage-executors/prd-executor.ts"
      provides: "PRD generation with signal citations"
      contains: "Supporting User Evidence"
  key_links:
    - from: "prd-executor.ts"
      to: "signalProjects"
      via: "database query"
      pattern: "db.*signalProjects"
---

<objective>
Enhance PRD generation to automatically cite linked signals as evidence.

Purpose: Every PRD should trace back to user evidence, fulfilling Elmer's core value
Output: PRD executor that includes signal citations in generated PRDs
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-provenance-prd-citation/18-RESEARCH.md
@orchestrator/src/lib/execution/stage-executors/prd-executor.ts
@orchestrator/src/lib/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add signal fetching to PRD executor</name>
  <files>orchestrator/src/lib/execution/stage-executors/prd-executor.ts</files>
  <action>
Enhance executePRD to fetch and include linked signals:

1. Add imports at top of file:
   ```typescript
   import { signalProjects, signals as signalsTable } from "@/lib/db/schema";
   import { inArray } from "drizzle-orm";
   ```

2. After loading company context and before generating PRD, fetch linked signals:
   ```typescript
   // Fetch linked signals for evidence section
   callbacks.onProgress(0.15, "Loading signal evidence...");
   const linkedSignals = await db
     .select({
       verbatim: signalsTable.verbatim,
       source: signalsTable.source,
       severity: signalsTable.severity,
       frequency: signalsTable.frequency,
       interpretation: signalsTable.interpretation,
     })
     .from(signalProjects)
     .innerJoin(signalsTable, eq(signalProjects.signalId, signalsTable.id))
     .where(eq(signalProjects.projectId, project.id))
     .orderBy(desc(signalProjects.linkedAt))
     .limit(10); // Top 10 signals to prevent context bloat
   ```

3. Create evidence section formatter function:
   ```typescript
   function formatSignalsForPRD(signals: typeof linkedSignals): string {
     if (signals.length === 0) return '';

     const citations = signals.map((s, i) => {
       const source = s.source.charAt(0).toUpperCase() + s.source.slice(1);
       const severity = s.severity ? ` (${s.severity})` : '';
       const quote = s.verbatim.length > 200
         ? s.verbatim.slice(0, 197) + '...'
         : s.verbatim;

       return `[Signal ${i + 1}] **${source}${severity}**: "${quote}"`;
     });

     return `
## Supporting User Evidence

This PRD is informed by ${signals.length} user feedback signal${signals.length === 1 ? '' : 's'}:

${citations.join('\n\n')}

---
`;
   }
   ```

4. Build evidence section and include in prompt:
   ```typescript
   const evidenceSection = formatSignalsForPRD(linkedSignals);

   if (linkedSignals.length > 0) {
     callbacks.onLog("info", `Including ${linkedSignals.length} signal(s) as evidence`, "prd");
   }
   ```

5. Update PRD system prompt to include citation instructions:
   Add after existing PRD_SYSTEM_PROMPT:
   ```typescript
   const prdSystemPromptWithCitations = `${PRD_SYSTEM_PROMPT}

## Citation Requirements
When writing the PRD, reference the provided user evidence:
- Use signal quotes to support problem statements
- Cite specific signals when defining requirements
- Ensure traceability from user feedback to PRD decisions
`;
   ```

6. Update basePrompt to include evidence:
   ```typescript
   const basePrompt = `Project: ${project.name}
${project.description ? `Description: ${project.description}` : ""}

${companyContext ? `## Company Context\n${companyContext}\n` : ""}

${evidenceSection}

## Research
${researchDoc.content}`;
   ```

7. Use prdSystemPromptWithCitations instead of PRD_SYSTEM_PROMPT when generating PRD
  </action>
  <verify>
1. TypeScript compiles: `cd orchestrator && npx tsc --noEmit`
2. No lint errors: `cd orchestrator && npm run lint`
  </verify>
  <done>
- PRD executor fetches linked signals (up to 10)
- Signals formatted as "Supporting User Evidence" section
- PRD system prompt includes citation instructions
- Evidence section included in PRD generation prompt
  </done>
</task>

<task type="auto">
  <name>Task 2: Add progress logging for signal loading</name>
  <files>orchestrator/src/lib/execution/stage-executors/prd-executor.ts</files>
  <action>
Ensure progress callbacks include signal evidence loading:

1. Update progress percentages to include new step:
   - 0.05: "Loading company context..."
   - 0.10: "Loading research context..."
   - 0.15: "Loading signal evidence..." (NEW)
   - 0.25: "Generating PRD..."
   - (rest unchanged)

2. Add info log when signals found:
   ```typescript
   if (linkedSignals.length > 0) {
     callbacks.onLog("info", `Found ${linkedSignals.length} signal(s) to cite as evidence`, "prd");
   } else {
     callbacks.onLog("info", "No linked signals found - PRD will be generated without user evidence", "prd");
   }
   ```

This provides visibility into the PRD generation process.
  </action>
  <verify>Progress logging appears during PRD generation</verify>
  <done>PRD generation shows signal loading progress and logs signal count</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd orchestrator && npx tsc --noEmit`
2. Lint passes: `cd orchestrator && npm run lint`
3. Manual test: Generate PRD for project with linked signals
4. Generated PRD includes "Supporting User Evidence" section
5. Signals are formatted with source, severity, and quoted verbatim
</verification>

<success_criteria>
- PRD executor loads linked signals during generation
- Generated PRDs include signal citations as evidence
- Maximum 10 signals included to prevent context overflow
- Progress callbacks show signal loading step
- No TypeScript or lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-provenance-prd-citation/18-02-SUMMARY.md`
</output>
