---
phase: 18-provenance-prd-citation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - orchestrator/src/app/api/projects/[id]/signals/route.ts
  - orchestrator/src/lib/db/queries.ts
  - orchestrator/src/components/projects/LinkedSignalsSection.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User sees 'Signals that informed this project' header on project detail"
    - "Each signal shows who linked it and when"
    - "Each signal shows link reason if provided"
    - "AI-linked signals show confidence percentage"
  artifacts:
    - path: "orchestrator/src/app/api/projects/[id]/signals/route.ts"
      provides: "GET endpoint returning signals with full provenance data"
      contains: "linkedBy.*name"
    - path: "orchestrator/src/components/projects/LinkedSignalsSection.tsx"
      provides: "Enhanced section with provenance display"
      contains: "Signals that informed this project"
  key_links:
    - from: "LinkedSignalsSection"
      to: "/api/projects/[id]/signals"
      via: "useQuery fetch"
      pattern: "linkedBy|linkReason|confidence"
---

<objective>
Enhance the LinkedSignalsSection to show full provenance chain for signals.

Purpose: Users need to see who linked signals, when, and why to trust the evidence trail
Output: Enhanced LinkedSignalsSection with provenance metadata display
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-provenance-prd-citation/18-RESEARCH.md
@orchestrator/src/components/projects/LinkedSignalsSection.tsx
@orchestrator/src/app/api/projects/[id]/signals/route.ts
@orchestrator/src/lib/db/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance getSignalsForProject query</name>
  <files>orchestrator/src/lib/db/queries.ts</files>
  <action>
Update getSignalsForProject to return full provenance data:

1. Modify the query to include linkedBy user data via join:
   - linkedBy: { id, name } from users table
   - linkReason from signalProjects
   - confidence from signalProjects

2. Update return mapping to include:
   - linkedAt (already present)
   - linkReason (add)
   - confidence (add)
   - linkedBy: { id, name } (add via join)

Pattern from existing code:
```typescript
const links = await db.query.signalProjects.findMany({
  where: eq(signalProjects.projectId, projectId),
  with: {
    signal: true,
    linkedByUser: true,  // Add this relation
  },
  orderBy: [desc(signalProjects.linkedAt)],
  limit,
  offset,
});

return links.map((link) => ({
  ...link.signal,
  linkedAt: link.linkedAt,
  linkReason: link.linkReason,
  confidence: link.confidence,
  linkedBy: link.linkedByUser ? {
    id: link.linkedByUser.id,
    name: link.linkedByUser.name,
  } : null,
}));
```
  </action>
  <verify>TypeScript compiles without errors: `cd orchestrator && npx tsc --noEmit`</verify>
  <done>getSignalsForProject returns signals with linkedBy, linkReason, and confidence fields</done>
</task>

<task type="auto">
  <name>Task 2: Enhance LinkedSignalsSection component</name>
  <files>orchestrator/src/components/projects/LinkedSignalsSection.tsx</files>
  <action>
Update LinkedSignalsSection to display provenance information:

1. Update LinkedSignal interface to include new fields:
   ```typescript
   interface LinkedSignal {
     id: string;
     verbatim: string;
     source: string;
     severity?: string | null;
     linkedAt: string;
     linkReason?: string | null;
     confidence?: number | null;
     linkedBy?: {
       id: string;
       name: string | null;
     } | null;
   }
   ```

2. Update header text from "Signals ({count})" to:
   "Signals that informed this project ({count})"

3. Enhance signal item display to show provenance:
   - Below existing badges, add provenance line:
     - "Linked {date}" (existing)
     - " by {linkedBy.name}" if linkedBy exists
     - " ({confidence}% AI confidence)" if confidence exists
   - Add linkReason display on a separate line if present:
     - Style: text-[10px] text-muted-foreground italic

4. Use existing color patterns (SOURCE_COLORS, SEVERITY_COLORS)

UI structure for each signal:
```
"verbatim text..."
[source badge] [severity badge] Linked Jan 24 by John Smith (85% AI confidence)
- Reason: AI-suggested association
```
  </action>
  <verify>
1. Dev server shows enhanced section header
2. Linked signals display provenance info
3. `cd orchestrator && npm run lint` passes
  </verify>
  <done>
- Section header reads "Signals that informed this project"
- Each signal shows linkedAt date with optional linkedBy name
- AI-linked signals show confidence percentage
- Link reason displays when present
  </done>
</task>

</tasks>

<verification>
1. Navigate to a project page with linked signals
2. Verify section header shows "Signals that informed this project"
3. Verify provenance details display correctly for each signal
4. TypeScript compiles: `cd orchestrator && npx tsc --noEmit`
5. Lint passes: `cd orchestrator && npm run lint`
</verification>

<success_criteria>
- LinkedSignalsSection shows enhanced header text
- Each signal displays who linked it and when
- AI-linked signals show confidence percentage
- Link reason displays when present
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-provenance-prd-citation/18-01-SUMMARY.md`
</output>
