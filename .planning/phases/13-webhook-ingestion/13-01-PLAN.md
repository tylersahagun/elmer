---
phase: 13-webhook-ingestion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - orchestrator/src/lib/db/schema.ts
  - orchestrator/src/lib/db/index.ts
  - orchestrator/drizzle/0007_*.sql
autonomous: true

must_haves:
  truths:
    - "webhookKeys table exists in database"
    - "Workspace-scoped API keys can be stored"
    - "HMAC secrets can be stored for signature verification"
    - "Keys can be deactivated without deletion"
  artifacts:
    - path: "orchestrator/src/lib/db/schema.ts"
      provides: "webhookKeys table definition with apiKey, secret, isActive fields"
      contains: "webhookKeys = pgTable"
    - path: "orchestrator/drizzle/0007_*.sql"
      provides: "Migration for webhookKeys table"
      contains: "CREATE TABLE"
  key_links:
    - from: "webhookKeys"
      to: "workspaces"
      via: "workspaceId foreign key"
      pattern: "references.*workspaces.*id"
    - from: "webhookKeys"
      to: "users"
      via: "createdBy foreign key"
      pattern: "references.*users.*id"
---

<objective>
Create the webhookKeys database table for storing workspace-scoped webhook credentials.

Purpose: Webhook authentication requires workspace-specific API keys and HMAC secrets. This schema enables multi-tenant webhook security where each workspace has isolated credentials.

Output: webhookKeys table with Drizzle schema, TypeScript types, relations, and database migration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-webhook-ingestion/13-RESEARCH.md
@orchestrator/src/lib/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add webhookKeys table definition</name>
  <files>orchestrator/src/lib/db/schema.ts</files>
  <action>
Add the webhookKeys table definition after the signals section (around line 1248, before relations).

```typescript
// ============================================
// WEBHOOK KEYS (Authentication for External Integrations)
// ============================================

export const webhookKeys = pgTable("webhook_keys", {
  id: text("id").primaryKey().$defaultFn(() => nanoid()),
  workspaceId: text("workspace_id").notNull().references(() => workspaces.id, { onDelete: "cascade" }),
  name: text("name").notNull(),                    // "Ask Elephant", "Zapier", etc.
  apiKey: text("api_key").notNull().unique(),      // For simple X-API-Key auth
  secret: text("secret").notNull(),                // For HMAC signature verification
  isActive: boolean("is_active").default(true),
  lastUsedAt: timestamp("last_used_at"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  createdBy: text("created_by").references(() => users.id, { onDelete: "set null" }),
});

// Relations
export const webhookKeysRelations = relations(webhookKeys, ({ one }) => ({
  workspace: one(workspaces, {
    fields: [webhookKeys.workspaceId],
    references: [workspaces.id],
  }),
  creator: one(users, {
    fields: [webhookKeys.createdBy],
    references: [users.id],
  }),
}));
```

Also add `webhookKeys: many(webhookKeys)` to the existing `workspacesRelations` function.

Pattern: Follow existing table patterns (nanoid for id, cascade on workspace delete, SET NULL for user references).
  </action>
  <verify>TypeScript compiles: `cd orchestrator && npx tsc --noEmit 2>&1 | head -20`</verify>
  <done>webhookKeys table defined with workspace FK, unique apiKey, HMAC secret, isActive flag, and relations</done>
</task>

<task type="auto">
  <name>Task 2: Export types and generate migration</name>
  <files>orchestrator/src/lib/db/index.ts, orchestrator/drizzle/0007_*.sql</files>
  <action>
1. In `orchestrator/src/lib/db/index.ts`, add type exports:

```typescript
// Webhook Keys
export type WebhookKey = typeof schema.webhookKeys.$inferSelect;
export type NewWebhookKey = typeof schema.webhookKeys.$inferInsert;
```

2. Generate database migration:

```bash
cd orchestrator && npm run db:generate
```

This creates a new migration file in `orchestrator/drizzle/` for the webhookKeys table.

Note: Do not run db:push - migration will be applied when database is available.
  </action>
  <verify>
- Types exported: `grep -n "WebhookKey" orchestrator/src/lib/db/index.ts`
- Migration exists: `ls orchestrator/drizzle/*.sql | tail -1`
  </verify>
  <done>WebhookKey and NewWebhookKey types exported, migration file generated</done>
</task>

</tasks>

<verification>
1. Schema compiles: `cd orchestrator && npx tsc --noEmit`
2. webhookKeys table defined: `grep -n "webhookKeys = pgTable" orchestrator/src/lib/db/schema.ts`
3. Relation to workspaces exists: `grep -A5 "webhookKeysRelations" orchestrator/src/lib/db/schema.ts`
4. Types exported: `grep "WebhookKey" orchestrator/src/lib/db/index.ts`
5. Migration file exists: `ls orchestrator/drizzle/0007*.sql`
</verification>

<success_criteria>
- webhookKeys table definition exists with id, workspaceId, name, apiKey, secret, isActive, lastUsedAt, createdAt, createdBy
- Foreign key to workspaces with cascade delete
- Foreign key to users with set null on delete
- Unique constraint on apiKey
- Relations defined (workspace, creator)
- WebhookKey and NewWebhookKey types exported
- Migration file generated
</success_criteria>

<output>
After completion, create `.planning/phases/13-webhook-ingestion/13-01-SUMMARY.md`
</output>
