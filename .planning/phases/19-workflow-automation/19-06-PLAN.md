---
phase: 19-workflow-automation
plan: 06
type: execute
wave: 4
depends_on: ["19-02", "19-03"]
files_modified:
  - orchestrator/src/lib/automation/signal-automation.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Notifications only fire when configurable thresholds are met"
    - "Suggest mode sends notification without taking action"
    - "Auto-create mode sends notification after creating project"
    - "Full-auto mode sends notification after creating project and triggering PRD"
  artifacts:
    - path: "orchestrator/src/lib/automation/signal-automation.ts"
      provides: "Notification wiring to automation engine"
      contains: "notifyClusterDiscovered"
  key_links:
    - from: "orchestrator/src/lib/automation/signal-automation.ts"
      to: "lib/notifications/threshold-filter.ts"
      via: "notifyClusterDiscovered import and calls"
      pattern: "notifyClusterDiscovered"
---

<objective>
Wire notification system into signal automation engine to close AUTO-03 gap.

Purpose: The notification threshold filtering module (19-03) exists but is never called by the automation engine (19-02). This plan adds the missing import and function calls so that:
- Suggest mode: Notifies user when clusters meet thresholds (no actions taken)
- Auto-create mode: Notifies user AFTER creating project automatically
- Full-auto mode: Notifies user AFTER creating project AND triggering PRD

Output: Updated signal-automation.ts with notification wiring.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-workflow-automation/19-VERIFICATION.md

# Modules to wire together
@orchestrator/src/lib/automation/signal-automation.ts
@orchestrator/src/lib/notifications/threshold-filter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire notifyClusterDiscovered into signal-automation.ts</name>
  <files>orchestrator/src/lib/automation/signal-automation.ts</files>
  <action>
Update `orchestrator/src/lib/automation/signal-automation.ts` to import and call the notification module:

**1. Add import at top of file (after existing imports, around line 16):**

```typescript
import { notifyClusterDiscovered } from "@/lib/notifications";
```

**2. Add notification logic for "suggest" mode in checkSignalAutomation function.**

After the early exit for "manual" mode (around line 50) and after the for loop starts (line 55), add handling for "suggest" mode clusters. The suggest mode should ONLY notify, never take action.

Find this block (around line 55-61):
```typescript
  for (const cluster of clusters) {
    const skipReason = await evaluateCluster(cluster, workspaceId, settings);

    if (skipReason) {
      skipped.push({ clusterId: cluster.id, reason: skipReason });
      continue;
    }
```

Replace with (add suggest mode handling before the auto_create/full_auto block):
```typescript
  for (const cluster of clusters) {
    const skipReason = await evaluateCluster(cluster, workspaceId, settings);

    if (skipReason) {
      skipped.push({ clusterId: cluster.id, reason: skipReason });
      continue;
    }

    const now = new Date().toISOString();

    // SUGGEST MODE: Only notify, no actions
    if (settings.automationDepth === "suggest") {
      // Notify user about cluster meeting thresholds
      await notifyClusterDiscovered(
        workspaceId,
        cluster.id,
        cluster.theme,
        cluster.signalCount,
        cluster.severity,
        cluster.signalCount >= 3 ? "new_project" : "review"
      );
      continue; // Don't proceed to auto-actions
    }
```

**3. Add notification after project creation in auto_create/full_auto modes.**

Find the block where project is created (around line 68-83):
```typescript
        const projectId = await createProjectFromClusterAuto(workspaceId, cluster);

        await recordAutomationAction(
          workspaceId,
          cluster.id,
          "initiative_created",
          projectId,
          { clusterTheme: cluster.theme, signalCount: cluster.signalCount }
        );

        actionsTriggered.push({
          clusterId: cluster.id,
          action: "initiative_created",
          projectId,
          timestamp: now,
        });
```

After the `actionsTriggered.push` for "initiative_created" (before the full_auto PRD check), add:
```typescript
        // Notify user of auto-created project
        await notifyClusterDiscovered(
          workspaceId,
          cluster.id,
          cluster.theme,
          cluster.signalCount,
          cluster.severity,
          "new_project" // Project was created, action completed
        );
```

**4. Remove duplicate notification for full_auto PRD trigger.**

The notification after project creation covers both auto_create and full_auto modes. The PRD trigger is a secondary action on the same cluster, so we don't send a second notification (that would be spam). The existing notification message includes the project creation, and users can see PRD status in the project view.

**Complete updated checkSignalAutomation function should look like:**

```typescript
export async function checkSignalAutomation(
  workspaceId: string
): Promise<AutomationCheckResult> {
  const settings = await getWorkspaceAutomationSettings(workspaceId);
  const actionsTriggered: AutoActionRecord[] = [];
  const skipped: SkippedCluster[] = [];

  // Exit early if automation is manual
  if (settings.automationDepth === "manual") {
    return { clustersChecked: 0, actionsTriggered, skipped };
  }

  // Find current clusters (minimum 2 signals)
  const clusters = await findSignalClusters(workspaceId, 2);

  for (const cluster of clusters) {
    const skipReason = await evaluateCluster(cluster, workspaceId, settings);

    if (skipReason) {
      skipped.push({ clusterId: cluster.id, reason: skipReason });
      continue;
    }

    const now = new Date().toISOString();

    // SUGGEST MODE: Only notify, no actions
    if (settings.automationDepth === "suggest") {
      await notifyClusterDiscovered(
        workspaceId,
        cluster.id,
        cluster.theme,
        cluster.signalCount,
        cluster.severity,
        cluster.signalCount >= 3 ? "new_project" : "review"
      );
      continue;
    }

    // AUTO-04: Auto-create initiative from cluster above threshold
    if (settings.automationDepth === "auto_create" || settings.automationDepth === "full_auto") {
      if (cluster.signalCount >= settings.autoInitiativeThreshold) {
        const projectId = await createProjectFromClusterAuto(workspaceId, cluster);

        await recordAutomationAction(
          workspaceId,
          cluster.id,
          "initiative_created",
          projectId,
          { clusterTheme: cluster.theme, signalCount: cluster.signalCount }
        );

        actionsTriggered.push({
          clusterId: cluster.id,
          action: "initiative_created",
          projectId,
          timestamp: now,
        });

        // Notify user of auto-created project
        await notifyClusterDiscovered(
          workspaceId,
          cluster.id,
          cluster.theme,
          cluster.signalCount,
          cluster.severity,
          "new_project"
        );

        // AUTO-02: Auto-trigger PRD if full_auto and threshold met
        if (settings.automationDepth === "full_auto" &&
            cluster.signalCount >= settings.autoPrdThreshold) {
          const jobId = await triggerPrdGeneration(projectId, workspaceId);

          await recordAutomationAction(
            workspaceId,
            cluster.id,
            "prd_triggered",
            projectId,
            { jobId }
          );

          actionsTriggered.push({
            clusterId: cluster.id,
            action: "prd_triggered",
            projectId,
            timestamp: now,
          });
        }
      }
    }
  }

  return {
    clustersChecked: clusters.length,
    actionsTriggered,
    skipped,
  };
}
```
  </action>
  <verify>
1. TypeScript compiles: `cd orchestrator && npx tsc --noEmit`
2. Grep confirms import: `grep -n "notifyClusterDiscovered" orchestrator/src/lib/automation/signal-automation.ts` shows import and calls
3. Grep confirms suggest mode handling: `grep -n "suggest" orchestrator/src/lib/automation/signal-automation.ts` shows the new branch
  </verify>
  <done>
- notifyClusterDiscovered imported from @/lib/notifications
- Suggest mode sends notification when cluster meets thresholds (no action taken)
- Auto-create mode sends notification after creating project
- Full-auto mode sends notification after creating project (PRD is secondary action, no double notification)
- All existing automation logic preserved
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd orchestrator && npx tsc --noEmit` passes
2. Import verification: `grep "notifyClusterDiscovered" orchestrator/src/lib/automation/signal-automation.ts` shows import line
3. Suggest mode branch: `grep -A5 '"suggest"' orchestrator/src/lib/automation/signal-automation.ts` shows notification call
4. Auto-create notification: grep shows notifyClusterDiscovered called after createProjectFromClusterAuto
5. Key link now wired: signal-automation.ts imports from notifications module
</verification>

<success_criteria>
- Suggest mode: Clusters meeting thresholds trigger notification only (no project creation)
- Auto-create mode: Project created AND user notified
- Full-auto mode: Project created, PRD triggered, AND user notified (single notification)
- Notification respects thresholds defined in workspace settings (via notifyClusterDiscovered -> shouldSendNotification)
- Duplicate notifications suppressed by cooldown (existing threshold-filter.ts logic)
- AUTO-03 requirement satisfied: "Notifications only fire when configurable thresholds are met"
</success_criteria>

<output>
After completion, create `.planning/phases/19-workflow-automation/19-06-SUMMARY.md`
</output>
