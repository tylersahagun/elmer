---
phase: 19-workflow-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - orchestrator/src/lib/db/schema.ts
  - orchestrator/src/lib/db/migrations/0020_signal_automation.sql
  - orchestrator/drizzle.config.ts
autonomous: true

must_haves:
  truths:
    - "SignalAutomationSettings interface is exported from schema.ts"
    - "automationActions table exists in database after migration"
    - "DEFAULT_SIGNAL_AUTOMATION provides sensible defaults"
    - "WorkspaceSettings includes optional signalAutomation field"
  artifacts:
    - path: "orchestrator/src/lib/db/schema.ts"
      provides: "SignalAutomationSettings interface, automationActions table, AutomationActionType union"
      contains: "SignalAutomationSettings"
    - path: "orchestrator/src/lib/db/migrations/0020_signal_automation.sql"
      provides: "automationActions table DDL"
      contains: "CREATE TABLE"
  key_links:
    - from: "orchestrator/src/lib/db/schema.ts"
      to: "WorkspaceSettings"
      via: "signalAutomation?: SignalAutomationSettings"
      pattern: "signalAutomation\\?:"
---

<objective>
Add database schema and TypeScript types for signal automation configuration.

Purpose: Establish the data foundation for configurable automation depth, thresholds, and action tracking. This enables per-workspace automation settings and rate-limited action history.

Output: SignalAutomationSettings interface, automationActions table, DEFAULT_SIGNAL_AUTOMATION constant, extended WorkspaceSettings.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-workflow-automation/19-RESEARCH.md

# Existing schema patterns
@orchestrator/src/lib/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SignalAutomationSettings and automationActions to schema</name>
  <files>orchestrator/src/lib/db/schema.ts</files>
  <action>
Add the following to schema.ts:

1. Add `AutomationActionType` union type:
```typescript
export type AutomationActionType = "initiative_created" | "prd_triggered" | "notification_sent";
```

2. Add `SignalAutomationSettings` interface (place after WorkspaceSettings interface):
```typescript
export interface SignalAutomationSettings {
  // Automation depth: how much the system does automatically
  automationDepth: "manual" | "suggest" | "auto_create" | "full_auto";

  // Threshold for auto-PRD trigger (number of signals in cluster)
  autoPrdThreshold: number;  // Default: 5

  // Threshold for auto-initiative creation (cluster size)
  autoInitiativeThreshold: number;  // Default: 3

  // Minimum cluster confidence for automation (0-1)
  minClusterConfidence: number;  // Default: 0.7

  // Severity filter: only auto-act on signals at or above this severity
  minSeverityForAuto: SignalSeverity | null;  // Default: null (any)

  // Notification thresholds
  notifyOnClusterSize: number | null;  // Only notify when cluster >= N signals
  notifyOnSeverity: SignalSeverity | null;  // Only notify when severity >= X
  suppressDuplicateNotifications: boolean;  // Don't notify for same cluster twice

  // Rate limiting
  maxAutoActionsPerDay: number;  // Default: 10
  cooldownMinutes: number;  // Minutes between auto-actions on same cluster
}
```

3. Add `DEFAULT_SIGNAL_AUTOMATION` constant:
```typescript
export const DEFAULT_SIGNAL_AUTOMATION: SignalAutomationSettings = {
  automationDepth: "suggest",
  autoPrdThreshold: 5,
  autoInitiativeThreshold: 3,
  minClusterConfidence: 0.7,
  minSeverityForAuto: null,
  notifyOnClusterSize: 3,
  notifyOnSeverity: null,
  suppressDuplicateNotifications: true,
  maxAutoActionsPerDay: 10,
  cooldownMinutes: 60,
};
```

4. Extend `WorkspaceSettings` interface to include:
```typescript
// Signal Automation Settings (Phase 19)
signalAutomation?: SignalAutomationSettings;
```

5. Add `automationActions` table (place after notifications table):
```typescript
export const automationActions = pgTable("automation_actions", {
  id: text("id").primaryKey().$defaultFn(() => nanoid()),
  workspaceId: text("workspace_id").notNull().references(() => workspaces.id, { onDelete: "cascade" }),
  clusterId: text("cluster_id").notNull(),
  actionType: text("action_type").$type<AutomationActionType>().notNull(),
  projectId: text("project_id").references(() => projects.id, { onDelete: "set null" }),
  triggeredAt: timestamp("triggered_at").defaultNow().notNull(),
  metadata: jsonb("metadata").$type<Record<string, unknown>>(),
});
```

6. Add `automationActionsRelations`:
```typescript
export const automationActionsRelations = relations(automationActions, ({ one }) => ({
  workspace: one(workspaces, {
    fields: [automationActions.workspaceId],
    references: [workspaces.id],
  }),
  project: one(projects, {
    fields: [automationActions.projectId],
    references: [projects.id],
  }),
}));
```

7. Add `automationActions: many(automationActions)` to workspacesRelations.
  </action>
  <verify>TypeScript compiles: `cd orchestrator && npx tsc --noEmit`</verify>
  <done>SignalAutomationSettings interface exported, automationActions table defined, DEFAULT_SIGNAL_AUTOMATION constant exported, WorkspaceSettings extended with signalAutomation field</done>
</task>

<task type="auto">
  <name>Task 2: Generate and apply database migration</name>
  <files>orchestrator/src/lib/db/migrations/0020_signal_automation.sql</files>
  <action>
Generate migration using drizzle-kit:

```bash
cd orchestrator && npx drizzle-kit generate
```

This should create a migration file. If the filename differs from 0020_signal_automation.sql, note the actual filename.

Then apply the migration:

```bash
cd orchestrator && npx drizzle-kit migrate
```

The migration should create the `automation_actions` table with:
- `id` TEXT PRIMARY KEY
- `workspace_id` TEXT NOT NULL (FK to workspaces)
- `cluster_id` TEXT NOT NULL
- `action_type` TEXT NOT NULL
- `project_id` TEXT (FK to projects, nullable)
- `triggered_at` TIMESTAMP NOT NULL DEFAULT NOW()
- `metadata` JSONB

Plus indexes for efficient queries:
- Index on (workspace_id, cluster_id) for cooldown checks
- Index on (workspace_id, triggered_at DESC) for daily rate limit checks
  </action>
  <verify>Migration applies successfully: `cd orchestrator && npx drizzle-kit migrate` returns without errors, and `automation_actions` table exists</verify>
  <done>Database migration created and applied, automation_actions table exists in database</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd orchestrator && npx tsc --noEmit` passes
2. Migration applied: automation_actions table exists
3. Exports work: SignalAutomationSettings, DEFAULT_SIGNAL_AUTOMATION, AutomationActionType are importable
</verification>

<success_criteria>
- SignalAutomationSettings interface is defined and exported
- DEFAULT_SIGNAL_AUTOMATION constant provides sensible defaults
- WorkspaceSettings includes optional signalAutomation field
- automationActions table exists in database
- All types are properly exported and importable
</success_criteria>

<output>
After completion, create `.planning/phases/19-workflow-automation/19-01-SUMMARY.md`
</output>
