# Plan 08-01: Migration Script with Transaction and Idempotency

## Metadata

```yaml
plan_id: "08-01"
phase: 8
wave: 1
depends_on: ["07-03"]
files_modified:
  - orchestrator/src/lib/migrations/assign-workspaces.ts
  - orchestrator/src/app/api/admin/migrate/route.ts
autonomous: true
estimated_duration: "20 minutes"
```

## Goal

Create a migration script that assigns all orphaned workspaces (workspaces without any members) to the first authenticated user as admin. The migration should be idempotent and run in a transaction.

## Tasks

### Task 1: Create migration function

**File**: `orchestrator/src/lib/migrations/assign-workspaces.ts`

Create a migration function that:
- Finds all workspaces without any members
- Finds the first user by createdAt
- Assigns all orphaned workspaces to that user as admin
- Runs in a database transaction
- Returns migration results (count of workspaces assigned)

**Acceptance Criteria**:
- [ ] Function finds orphaned workspaces correctly
- [ ] Function assigns admin role to first user
- [ ] Function is idempotent (safe to run multiple times)
- [ ] Function uses database transaction

### Task 2: Create admin API endpoint

**File**: `orchestrator/src/app/api/admin/migrate/route.ts`

Create an admin-only endpoint to trigger the migration.

**Acceptance Criteria**:
- [ ] POST endpoint triggers migration
- [ ] Requires authentication
- [ ] Returns migration results
