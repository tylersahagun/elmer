# Plan 03-02: Password Reset Flow

## Frontmatter

```yaml
plan_id: "03-02"
phase: 3
wave: 2
depends_on: ["03-01"]
files_modified:
  - orchestrator/src/app/forgot-password/page.tsx
  - orchestrator/src/app/reset-password/page.tsx
  - orchestrator/src/app/api/auth/forgot-password/route.ts
  - orchestrator/src/app/api/auth/reset-password/route.ts
  - orchestrator/src/lib/email.ts
autonomous: false  # Requires email service configuration
estimated_duration: "30 minutes"
```

## Objective

Implement password reset flow allowing users to request a password reset email and set a new password via a secure token link.

## BLOCKER: Email Service Required

⚠️ **This plan requires an email service to be configured.**

Options:
1. **Resend** (recommended) - Simple API, good free tier
2. **SendGrid** - Enterprise option
3. **AWS SES** - If already using AWS
4. **Nodemailer + SMTP** - Self-hosted option

### To proceed:
1. Choose an email service
2. Create account and get API key
3. Add environment variables:
   ```
   EMAIL_FROM=noreply@yourdomain.com
   RESEND_API_KEY=re_xxxxx  # or equivalent
   ```
4. Verify domain (for production)

## Tasks (When Email Service Configured)

<task id="1" name="Create Email Utility">
<description>
Create email sending utility using chosen email service.
</description>
<files>
- orchestrator/src/lib/email.ts
</files>
<instructions>
1. Create `orchestrator/src/lib/email.ts`
2. Export `sendPasswordResetEmail(email: string, token: string)` function
3. Use environment variables for configuration
4. Include branded email template
</instructions>
</task>

<task id="2" name="Create Forgot Password API">
<description>
API endpoint to request password reset email.
</description>
<files>
- orchestrator/src/app/api/auth/forgot-password/route.ts
</files>
<instructions>
1. Accept POST with { email }
2. Look up user by email
3. Generate secure reset token (crypto.randomBytes)
4. Store token with expiry in database (add passwordResetToken, passwordResetExpires to users table)
5. Send email with reset link
6. Return success (even if email not found - security)
</instructions>
</task>

<task id="3" name="Create Reset Password API">
<description>
API endpoint to reset password with valid token.
</description>
<files>
- orchestrator/src/app/api/auth/reset-password/route.ts
</files>
<instructions>
1. Accept POST with { token, password }
2. Validate token exists and not expired
3. Hash new password with bcrypt
4. Update user's passwordHash
5. Clear reset token
6. Return success
</instructions>
</task>

<task id="4" name="Create Forgot Password Page">
<description>
Form to request password reset email.
</description>
<files>
- orchestrator/src/app/forgot-password/page.tsx
</files>
<instructions>
1. Create client component with email input
2. Submit to /api/auth/forgot-password
3. Show success message regardless of email existence
4. Link back to login
</instructions>
</task>

<task id="5" name="Create Reset Password Page">
<description>
Form to set new password using token from email.
</description>
<files>
- orchestrator/src/app/reset-password/page.tsx
</files>
<instructions>
1. Create client component
2. Read token from URL query params
3. New password + confirm password inputs
4. Submit to /api/auth/reset-password
5. On success, redirect to login with message
</instructions>
</task>

## Database Migration Required

Add to users table:
```sql
ALTER TABLE users ADD COLUMN password_reset_token TEXT;
ALTER TABLE users ADD COLUMN password_reset_expires TIMESTAMP;
```

## Status

**PAUSED** - Waiting for email service configuration.

To continue:
1. Configure email service
2. Run database migration
3. Execute tasks 1-5

---
*Plan 03-02 | Phase 3 | Wave 2 | PAUSED*
