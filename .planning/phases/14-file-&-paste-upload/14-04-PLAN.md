---
phase: 14-file-and-paste-upload
plan: 04
type: execute
wave: 4
depends_on: ["14-03"]
files_modified:
  - orchestrator/src/components/signals/CreateSignalModal.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can switch between Paste and Upload tabs in the modal"
    - "User can upload a file and see success feedback"
    - "Existing paste functionality continues to work unchanged"
  artifacts:
    - path: "orchestrator/src/components/signals/CreateSignalModal.tsx"
      provides: "Extended modal with Paste/Upload tabs"
      exports: ["CreateSignalModal"]
  key_links:
    - from: "orchestrator/src/components/signals/CreateSignalModal.tsx"
      to: "orchestrator/src/components/signals/FileUploadTab.tsx"
      via: "FileUploadTab import"
      pattern: "import.*FileUploadTab.*from"
    - from: "orchestrator/src/components/signals/CreateSignalModal.tsx"
      to: "orchestrator/src/components/ui/tabs.tsx"
      via: "Tabs component import"
      pattern: "import.*Tabs.*from.*@/components/ui/tabs"
---

<objective>
Update CreateSignalModal to add tabbed interface with Paste and Upload tabs.

Purpose: Complete the user-facing file upload capability by integrating the FileUploadTab component into the existing CreateSignalModal. Users can now choose between pasting text or uploading a file.

Output: Updated CreateSignalModal.tsx with tabs

Note: This is an ADDITIVE change to existing functionality. The paste form (Phase 12) is preserved intact within a tab. File upload is added as a second tab.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-file-&-paste-upload/14-RESEARCH.md
@.planning/phases/14-file-&-paste-upload/14-03-SUMMARY.md

# CRITICAL: Read these files to understand existing structure
@orchestrator/src/components/signals/CreateSignalModal.tsx
@orchestrator/src/components/signals/FileUploadTab.tsx
@orchestrator/src/components/ui/tabs.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Read and understand existing CreateSignalModal structure</name>
  <files>orchestrator/src/components/signals/CreateSignalModal.tsx</files>
  <action>
FIRST: Read the existing CreateSignalModal.tsx file completely before making changes.

Document the current structure:
1. Props interface (workspaceId, isOpen, onClose, onSuccess)
2. State variables (verbatim, interpretation, source, keepOpen)
3. Mutation setup (createMutation with mutationFn, onSuccess)
4. Event handlers (handleCreate, handleCreateAndAddAnother, handleClose)
5. JSX structure (Dialog, DialogHeader, form fields, DialogFooter)
6. Any other existing functionality to preserve

This read step ensures we understand exactly what functionality must be preserved when adding tabs.

Expected structure (based on Phase 12):
- Uses Dialog from @/components/ui/dialog
- Uses Select for source selection
- Uses Textarea for verbatim and interpretation
- Has "Create & Add Another" button for batch entry
- Resets form state on close
  </action>
  <verify>
Confirm file was read and structure is understood.
List the key elements that must be preserved.
  </verify>
  <done>Existing CreateSignalModal structure documented, ready for modification</done>
</task>

<task type="auto">
  <name>Task 2: Update CreateSignalModal with tabbed interface</name>
  <files>orchestrator/src/components/signals/CreateSignalModal.tsx</files>
  <action>
Update CreateSignalModal.tsx to add Paste/Upload tabs using Radix Tabs.

Changes to make:
1. Add new imports: Tabs, TabsContent, TabsList, TabsTrigger from @/components/ui/tabs
2. Add FileUploadTab import from ./FileUploadTab
3. Add activeTab state: useState("paste")
4. Wrap form content in Tabs component with two TabsContent sections
5. Move existing paste form into TabsContent value="paste"
6. Add FileUploadTab in TabsContent value="upload"
7. Update DialogDescription to mention both paste and upload
8. Widen modal from sm:max-w-[500px] to sm:max-w-[600px] to accommodate tabs
9. Reset activeTab to "paste" in handleClose
10. Move DialogFooter INSIDE the paste TabsContent (upload has its own footer)

PRESERVE all existing functionality:
- Batch entry with "Create & Add Another" button
- Source selection dropdown
- Form state management (verbatim, interpretation, source, keepOpen)
- Query invalidation on success
- Form reset on close

Updated component structure:

```typescript
// orchestrator/src/components/signals/CreateSignalModal.tsx
"use client";

import { useState } from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { Loader2 } from "lucide-react";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { FileUploadTab } from "./FileUploadTab";

interface CreateSignalModalProps {
  workspaceId: string;
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void;
}

// Sources appropriate for manual entry (not automated ingestion sources)
const MANUAL_SOURCES = [
  { value: "paste", label: "Manual Entry" },
  { value: "interview", label: "Interview" },
  { value: "email", label: "Email" },
  { value: "other", label: "Other" },
];

export function CreateSignalModal({
  workspaceId,
  isOpen,
  onClose,
  onSuccess,
}: CreateSignalModalProps) {
  const queryClient = useQueryClient();

  // Tab state
  const [activeTab, setActiveTab] = useState("paste");

  // Paste form state (existing)
  const [verbatim, setVerbatim] = useState("");
  const [interpretation, setInterpretation] = useState("");
  const [source, setSource] = useState("paste");
  const [keepOpen, setKeepOpen] = useState(false);

  // Create mutation (for paste tab - existing)
  const createMutation = useMutation({
    mutationFn: async (data: {
      verbatim: string;
      interpretation?: string;
      source: string;
    }) => {
      const res = await fetch("/api/signals", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ workspaceId, ...data }),
      });
      if (!res.ok) throw new Error("Failed to create signal");
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["signals", workspaceId] });
      if (keepOpen) {
        // Clear form but keep modal open for batch entry
        setVerbatim("");
        setInterpretation("");
        setSource("paste");
      } else {
        onSuccess();
        onClose();
      }
    },
  });

  const handleCreate = () => {
    if (!verbatim.trim()) return;
    setKeepOpen(false);
    createMutation.mutate({
      verbatim,
      interpretation: interpretation || undefined,
      source,
    });
  };

  const handleCreateAndAddAnother = () => {
    if (!verbatim.trim()) return;
    setKeepOpen(true);
    createMutation.mutate({
      verbatim,
      interpretation: interpretation || undefined,
      source,
    });
  };

  const handleClose = () => {
    // Reset all state when closing
    setActiveTab("paste");
    setVerbatim("");
    setInterpretation("");
    setSource("paste");
    setKeepOpen(false);
    onClose();
  };

  return (
    <Dialog open={isOpen} onOpenChange={(open) => !open && handleClose()}>
      <DialogContent className="sm:max-w-[600px]">
        <DialogHeader>
          <DialogTitle>Add Signal</DialogTitle>
          <DialogDescription>
            Add user feedback by pasting text or uploading a file.
          </DialogDescription>
        </DialogHeader>

        <Tabs value={activeTab} onValueChange={setActiveTab}>
          <TabsList className="grid w-full grid-cols-2">
            <TabsTrigger value="paste">Paste Text</TabsTrigger>
            <TabsTrigger value="upload">Upload File</TabsTrigger>
          </TabsList>

          <TabsContent value="paste" className="mt-4">
            <div className="space-y-4">
              {/* Verbatim textarea (required) */}
              <div className="space-y-2">
                <Label htmlFor="verbatim">Feedback (required)</Label>
                <Textarea
                  id="verbatim"
                  placeholder="Paste or type the user feedback verbatim..."
                  value={verbatim}
                  onChange={(e) => setVerbatim(e.target.value)}
                  rows={4}
                  className="resize-none"
                />
              </div>

              {/* Interpretation textarea (optional) */}
              <div className="space-y-2">
                <Label htmlFor="interpretation">Interpretation (optional)</Label>
                <Textarea
                  id="interpretation"
                  placeholder="What does this feedback really mean?"
                  value={interpretation}
                  onChange={(e) => setInterpretation(e.target.value)}
                  rows={2}
                  className="resize-none"
                />
              </div>

              {/* Source select */}
              <div className="space-y-2">
                <Label htmlFor="source">Source</Label>
                <Select value={source} onValueChange={setSource}>
                  <SelectTrigger id="source" className="w-full">
                    <SelectValue placeholder="Select source" />
                  </SelectTrigger>
                  <SelectContent>
                    {MANUAL_SOURCES.map((option) => (
                      <SelectItem key={option.value} value={option.value}>
                        {option.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>

            <DialogFooter className="mt-6 gap-2 sm:gap-0">
              <Button variant="outline" onClick={handleClose}>
                Cancel
              </Button>
              <Button
                variant="outline"
                onClick={handleCreateAndAddAnother}
                disabled={!verbatim.trim() || createMutation.isPending}
              >
                {createMutation.isPending && keepOpen ? (
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                ) : null}
                Create & Add Another
              </Button>
              <Button
                onClick={handleCreate}
                disabled={!verbatim.trim() || createMutation.isPending}
              >
                {createMutation.isPending && !keepOpen ? (
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                ) : null}
                Create Signal
              </Button>
            </DialogFooter>
          </TabsContent>

          <TabsContent value="upload" className="mt-4">
            <FileUploadTab
              workspaceId={workspaceId}
              onSuccess={onSuccess}
              onClose={handleClose}
            />
          </TabsContent>
        </Tabs>
      </DialogContent>
    </Dialog>
  );
}
```

Key changes from existing:
- Added Tabs wrapper with Paste/Upload triggers
- Moved existing paste form into TabsContent value="paste"
- Added FileUploadTab for TabsContent value="upload"
- Widened modal from sm:max-w-[500px] to sm:max-w-[600px]
- Updated description to mention both paste and upload
- Reset activeTab to "paste" on close
- Moved DialogFooter inside paste TabsContent (upload has its own)
  </action>
  <verify>
Run `npx tsc --noEmit` from orchestrator directory to confirm no TypeScript errors.
Run `npm run lint` to check for linting issues.
Verify CreateSignalModal.tsx has been updated with tabs.
  </verify>
  <done>CreateSignalModal updated with Paste/Upload tabs, preserving existing paste functionality</done>
</task>

</tasks>

<verification>
Run from orchestrator directory:

```bash
# Verify TypeScript compiles
npx tsc --noEmit

# Verify lint passes
npm run lint

# Verify file structure
ls -la src/components/signals/

# Expected files:
# - CreateSignalModal.tsx (modified)
# - FileDropZone.tsx (from Plan 03)
# - FileUploadTab.tsx (from Plan 03)
# - SignalDetailModal.tsx (existing)
# - SignalRow.tsx (existing)
# - ...

# Manual verification (requires running app):
# 1. npm run dev
# 2. Navigate to workspace signals page
# 3. Click "Add Signal" button
# 4. Verify modal shows two tabs: "Paste Text" and "Upload File"
# 5. Test paste tab (should work as before)
# 6. Test upload tab:
#    a. Drag a PDF/CSV/TXT file onto dropzone
#    b. See file preview with name and size
#    c. Click X to remove file
#    d. Select file again, add interpretation, click "Upload & Create Signal"
#    e. Verify success and signal appears in list
# 7. Test error states:
#    a. Try uploading >5MB file (should reject)
#    b. Try uploading .jpg file (should reject)
```
</verification>

<success_criteria>
1. CreateSignalModal displays two tabs: "Paste Text" and "Upload File"
2. Paste tab preserves all existing functionality (batch entry, source selection)
3. Upload tab uploads file and creates signal
4. Tab state resets to "paste" when modal closes
5. All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-file-&-paste-upload/14-04-SUMMARY.md`
</output>
