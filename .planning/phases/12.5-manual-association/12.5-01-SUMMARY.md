---
phase: 12.5-manual-association
plan: 01
subsystem: api
tags: [drizzle, rest-api, junction-tables, signal-management]

# Dependency graph
requires:
  - phase: 11-signals-schema
    provides: signals table, signalProjects and signalPersonas junction tables
  - phase: 12-signal-management-ui
    provides: signal API patterns and permission model
provides:
  - Signal-project linking/unlinking API endpoints
  - Signal-persona linking/unlinking API endpoints
  - Project-centric signal fetching endpoint
  - Signal status auto-transition on link/unlink
affects: [12.5-02-signal-modal-association-ui, 12.5-03-project-signal-list-ui]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Junction table CRUD via dedicated subroutes
    - Status invariant enforcement in link/unlink handlers

key-files:
  created:
    - orchestrator/src/app/api/signals/[id]/projects/route.ts
    - orchestrator/src/app/api/signals/[id]/personas/route.ts
    - orchestrator/src/app/api/projects/[id]/signals/route.ts
  modified:
    - orchestrator/src/lib/db/queries.ts

key-decisions:
  - "Signal status auto-updates to 'linked' on first project link"
  - "Signal status reverts to 'reviewed' when last project unlinked"
  - "Persona linking does not affect signal status"
  - "Project signals endpoint ordered by linkedAt DESC"

patterns-established:
  - "Junction table APIs as subroutes of parent resource (/signals/[id]/projects)"
  - "Viewer access for GET, member access for POST/DELETE on associations"

# Metrics
duration: 12min
completed: 2026-01-22
---

# Phase 12.5 Plan 01: Association APIs Summary

**REST API endpoints for bidirectional signal-project and signal-persona linking with automatic status transitions**

## Performance

- **Duration:** 12 min
- **Started:** 2026-01-22T16:35:00Z
- **Completed:** 2026-01-22T16:47:00Z
- **Tasks:** 3
- **Files modified:** 4

## Accomplishments
- Seven new query functions for signal association operations
- Signal-project linking API with status invariant enforcement
- Signal-persona linking API (status-independent)
- Project-centric signal fetching with pagination

## Task Commits

Each task was committed atomically:

1. **Task 1: Add query functions for signal associations** - `2e5cdfb` (feat)
2. **Task 2: Create /api/signals/[id]/projects route** - `e9179e3` (feat)
3. **Task 3: Create /api/signals/[id]/personas and /api/projects/[id]/signals routes** - `83a1ce6` (feat)

## Files Created/Modified

- `orchestrator/src/lib/db/queries.ts` - Added 7 query functions for signal associations
- `orchestrator/src/app/api/signals/[id]/projects/route.ts` - GET/POST/DELETE for signal-project links
- `orchestrator/src/app/api/signals/[id]/personas/route.ts` - GET/POST/DELETE for signal-persona links
- `orchestrator/src/app/api/projects/[id]/signals/route.ts` - GET paginated signals for a project

## Decisions Made

- **Status invariant enforcement:** Signal status auto-transitions to "linked" when first project linked, and reverts to "reviewed" (not "new") when last project unlinked
- **Persona status independence:** Linking/unlinking personas does not affect signal status (only project links do)
- **Ordering:** Project signals returned by linkedAt DESC (recently linked first)
- **Pagination:** Project signals support limit/offset params with 50 default limit

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - all tasks completed without issues.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Association APIs ready for UI integration
- Plan 02 can implement signal modal association comboboxes
- Plan 03 can implement project page signal list with unlink actions

---
*Phase: 12.5-manual-association*
*Completed: 2026-01-22*
