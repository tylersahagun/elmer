# Phase 12.5: Manual Association - Research

**Researched:** 2026-01-22
**Domain:** Signal-to-Project/Persona Linking UI and API
**Confidence:** HIGH

## Summary

This phase implements manual linking between signals and projects/personas. The codebase already has:
1. **Junction tables ready** - `signalProjects` and `signalPersonas` tables exist with correct schema (Phase 11)
2. **UI component library** - shadcn/ui with Radix primitives, including Select, Dialog, Badge, and custom animated Accordion
3. **Permission patterns** - `requireWorkspaceAccess(workspaceId, "member")` pattern for mutations
4. **Inline assignment pattern** - InboxPanel demonstrates inline project/persona assignment with button groups

The main work is extending existing patterns to SignalDetailModal, SignalRow, and ProjectDetailPage. No new UI primitives needed - the existing Select component with custom styling will work for the combobox pattern.

**Primary recommendation:** Follow InboxPanel's inline assignment pattern for signal modal, and use Dialog + checkboxes for project-side bulk signal picker.

## Standard Stack

The codebase already uses these established libraries:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| drizzle-orm | ^0.45.1 | Database ORM | Type-safe queries, relations already defined |
| @tanstack/react-query | ^5.90.18 | Data fetching/caching | Mutation + invalidation patterns established |
| @radix-ui/react-select | ^2.2.6 | Select/combobox primitive | Accessible, composable |
| @radix-ui/react-dialog | ^2.1.16 | Modal dialogs | Already used in SignalDetailModal |
| lucide-react | ^0.562.0 | Icons | Consistent icon library |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| motion/react | ^12.26.2 | Animations | AnimatePresence for enter/exit transitions |
| @radix-ui/react-scroll-area | ^1.2.10 | Scrollable containers | Signal picker list scrolling |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Select | Custom combobox with search | Select is simpler for small lists; combobox needed for 50+ signals |
| Individual badge clicks | Multi-select checkboxes | Badges work for small counts (1-3), checkboxes for bulk (5-50+) |

**Installation:**
No new packages needed. All required libraries already installed.

## Architecture Patterns

### Recommended Project Structure
```
src/
├── components/signals/
│   ├── SignalDetailModal.tsx     # Extend with project/persona linking
│   ├── SignalRow.tsx             # Extend with project/persona badges
│   ├── ProjectLinkCombobox.tsx   # NEW: Inline project picker
│   ├── PersonaLinkCombobox.tsx   # NEW: Inline persona picker
│   └── LinkedTag.tsx             # NEW: Removable tag component
├── components/projects/
│   └── LinkedSignalsSection.tsx  # NEW: Collapsible signals section
├── app/api/signals/
│   └── [id]/
│       ├── projects/route.ts     # NEW: Link/unlink projects
│       └── personas/route.ts     # NEW: Link/unlink personas
└── lib/db/queries.ts             # Extend with junction table queries
```

### Pattern 1: Inline Assignment (Signal Modal)
**What:** Use Select component with searchable dropdown, display as removable tags
**When to use:** Signal -> Project/Persona linking (1-3 selections typical)
**Example:**
```typescript
// From InboxPanel pattern (verified in codebase)
<div className="flex flex-wrap gap-2">
  {linkedProjects.map((project) => (
    <Badge key={project.id} className="gap-1">
      {project.name}
      <button onClick={() => onUnlink(project.id)}>
        <X className="w-3 h-3" />
      </button>
    </Badge>
  ))}
  <Select onValueChange={onLinkProject}>
    <SelectTrigger className="h-7 w-[180px]">
      <SelectValue placeholder="Link to project..." />
    </SelectTrigger>
    <SelectContent>
      {availableProjects.map((p) => (
        <SelectItem key={p.id} value={p.id}>{p.name}</SelectItem>
      ))}
    </SelectContent>
  </Select>
</div>
```

### Pattern 2: Bulk Selection (Project Page)
**What:** Dialog with checkbox list, "Link Selected" action
**When to use:** Project -> Signals linking (5-50 signals typical)
**Example:**
```typescript
// Based on existing Dialog pattern in codebase
<Dialog open={isOpen} onOpenChange={setIsOpen}>
  <DialogContent className="sm:max-w-[600px] max-h-[80vh]">
    <DialogHeader>
      <DialogTitle>Link Signals to {project.name}</DialogTitle>
    </DialogHeader>
    <Input
      placeholder="Search signals..."
      value={search}
      onChange={(e) => setSearch(e.target.value)}
    />
    <ScrollArea className="max-h-[400px]">
      {filteredSignals.map((signal) => (
        <div key={signal.id} className="flex items-center gap-2 p-2">
          <Checkbox
            checked={selected.includes(signal.id)}
            onCheckedChange={(checked) => toggleSelection(signal.id, checked)}
          />
          <span className="line-clamp-2">{signal.verbatim}</span>
        </div>
      ))}
    </ScrollArea>
    <DialogFooter>
      <Button onClick={handleLinkSelected}>
        Link {selected.length} Signals
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

### Pattern 3: Collapsible Section (Project Page)
**What:** Native HTML details/summary or Accordion primitive
**When to use:** Signals section on project page (collapsed by default)
**Example:**
```typescript
// From InboxPanel processed items pattern
<details className="group">
  <summary className="cursor-pointer text-sm flex items-center gap-2 py-2">
    <ChevronRight className="w-4 h-4 group-open:rotate-90 transition-transform" />
    Signals ({linkedSignals.length})
  </summary>
  <div className="mt-2 space-y-2">
    {linkedSignals.map((signal) => (
      <LinkedSignalCard key={signal.id} signal={signal} onUnlink={handleUnlink} />
    ))}
  </div>
</details>
```

### Anti-Patterns to Avoid
- **Nested modals:** Don't open signal detail modal from within project signal picker - use "View" link to open in new context
- **Inline editing in lists:** Don't make signal cards editable in project page - keep read-only with "View" action
- **Confirmation dialogs for unlink:** Low-risk reversible action - direct unlink with optional undo toast

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Searchable dropdown | Custom autocomplete | Select + filtering | Radix handles a11y, keyboard nav |
| Permission checking | Inline session checks | `requireWorkspaceAccess()` | Consistent error handling |
| Data invalidation | Manual refetch | `queryClient.invalidateQueries()` | React Query handles caching |
| Tag removal UI | Custom close button | Badge + X button pattern | InboxPanel has working example |
| Collapsible section | Custom state toggle | HTML `<details>` element | Native, accessible, no JS needed |

**Key insight:** The codebase has established patterns for all required UI interactions. Follow InboxPanel and SignalDetailModal as templates.

## Common Pitfalls

### Pitfall 1: N+1 Queries for Linked Data
**What goes wrong:** Fetching linked projects/personas per signal in list view
**Why it happens:** Naive approach queries junction tables for each row
**How to avoid:** Use Drizzle relations with `with: { projects: true }` in initial query
**Warning signs:** Slow signal list load, many database requests per page

### Pitfall 2: Stale UI After Link/Unlink
**What goes wrong:** Tags don't update after link operation
**Why it happens:** Missing query invalidation or optimistic update
**How to avoid:** Always invalidate `["signals"]` and `["project", projectId]` after mutations
**Warning signs:** User needs to refresh page to see changes

### Pitfall 3: Status Invariant Violation
**What goes wrong:** Signal status = `linked` but no linked projects exist
**Why it happens:** Unlink operation doesn't check if last project was removed
**How to avoid:** API endpoint must auto-update status to `reviewed` when last project unlinked
**Warning signs:** Filters show "linked" signals with empty project lists

### Pitfall 4: Permission Bypass via Direct API
**What goes wrong:** Users can link signals in workspaces they're not members of
**Why it happens:** API route doesn't verify membership via signal's workspaceId
**How to avoid:** Always verify `signal.workspaceId` matches user's workspace membership
**Warning signs:** Cross-workspace data leakage in testing

### Pitfall 5: Persona ID Mismatch
**What goes wrong:** Link fails because personaId doesn't match any archetype
**Why it happens:** Frontend uses display name instead of `archetype_id`
**How to avoid:** Always use `archetype_id` as the value in Select components
**Warning signs:** "Persona not found" errors after persona JSON files change

## Code Examples

Verified patterns from the codebase:

### Junction Table Query (Drizzle)
```typescript
// Source: schema.ts signalProjects relations pattern
export async function getSignalWithLinks(id: string) {
  return db.query.signals.findFirst({
    where: eq(signals.id, id),
    with: {
      projects: {
        with: {
          project: true,  // Get full project details
        },
      },
      personas: true,
    },
  });
}
```

### Link Operation (API Route)
```typescript
// Source: Pattern from InboxPanel assign mutation
export async function POST(request: NextRequest, { params }: RouteContext) {
  const { id: signalId } = await params;
  const { projectId, linkReason } = await request.json();

  // Verify signal exists and get workspaceId
  const signal = await getSignal(signalId);
  if (!signal) {
    return NextResponse.json({ error: "Signal not found" }, { status: 404 });
  }

  // Verify membership
  const membership = await requireWorkspaceAccess(signal.workspaceId, "member");

  // Create link
  await db.insert(signalProjects).values({
    signalId,
    projectId,
    linkedBy: membership.userId,
    linkReason,
  });

  // Update signal status to "linked" if not already
  if (signal.status !== "linked") {
    await updateSignal(signalId, { status: "linked" });
  }

  return NextResponse.json({ success: true });
}
```

### Unlink with Status Update
```typescript
// Pattern for maintaining status invariant
export async function DELETE(request: NextRequest, { params }: RouteContext) {
  const { id: signalId } = await params;
  const { projectId } = await request.json();

  // ... permission checks ...

  // Delete link
  await db.delete(signalProjects)
    .where(and(
      eq(signalProjects.signalId, signalId),
      eq(signalProjects.projectId, projectId)
    ));

  // Check if any projects remain
  const remainingLinks = await db.query.signalProjects.findMany({
    where: eq(signalProjects.signalId, signalId),
  });

  // Update status if no projects linked
  if (remainingLinks.length === 0) {
    const signal = await getSignal(signalId);
    if (signal?.status === "linked") {
      await updateSignal(signalId, { status: "reviewed" });
    }
  }

  return NextResponse.json({ success: true });
}
```

### Mutation Hook Pattern
```typescript
// Source: SignalDetailModal mutation pattern
const linkProjectMutation = useMutation({
  mutationFn: async ({ signalId, projectId }: { signalId: string; projectId: string }) => {
    const res = await fetch(`/api/signals/${signalId}/projects`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ projectId }),
    });
    if (!res.ok) throw new Error("Failed to link");
    return res.json();
  },
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: ["signals"] });
    queryClient.invalidateQueries({ queryKey: ["signal", signalId] });
  },
});
```

### Removable Badge Tag
```typescript
// Source: InboxPanel badge pattern with X button
function LinkedProjectTag({ project, onUnlink, isLoading }: Props) {
  return (
    <Badge className="gap-1 pr-1">
      <span className="truncate max-w-[100px]">{project.name}</span>
      <button
        onClick={() => onUnlink(project.id)}
        disabled={isLoading}
        className="hover:bg-destructive/20 rounded p-0.5"
      >
        {isLoading ? (
          <Loader2 className="w-3 h-3 animate-spin" />
        ) : (
          <X className="w-3 h-3" />
        )}
      </button>
    </Badge>
  );
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Confirmation dialogs for all deletes | Undo toast for reversible actions | 2024 | Lower friction, better UX |
| Full page reload after mutation | React Query invalidation | Already in use | Instant UI updates |
| Custom dropdown menus | Radix primitives | Already in use | Better accessibility |

**Deprecated/outdated:**
- None identified - codebase uses modern patterns

## Open Questions

Things that couldn't be fully resolved:

1. **Checkbox Component Availability**
   - What we know: shadcn/ui is configured but Checkbox wasn't found in `src/components/ui/`
   - What's unclear: Whether to install via `npx shadcn@latest add checkbox` or build custom
   - Recommendation: Install official shadcn/ui checkbox before starting bulk selection work

2. **Persona Display Names vs IDs**
   - What we know: `archetype_id` is the stable identifier, `name` is display text
   - What's unclear: Whether persona names can change over time
   - Recommendation: Store `archetype_id` in `signalPersonas`, display `name` from API

## Sources

### Primary (HIGH confidence)
- `/Users/tylersahagun/Source/elmer/orchestrator/src/lib/db/schema.ts` - Junction table definitions
- `/Users/tylersahagun/Source/elmer/orchestrator/src/components/inbox/InboxPanel.tsx` - Inline assignment pattern
- `/Users/tylersahagun/Source/elmer/orchestrator/src/components/signals/SignalDetailModal.tsx` - Modal structure
- `/Users/tylersahagun/Source/elmer/orchestrator/src/components/signals/SignalRow.tsx` - Badge display pattern
- `/Users/tylersahagun/Source/elmer/orchestrator/src/app/api/signals/[id]/route.ts` - API pattern
- `/Users/tylersahagun/Source/elmer/orchestrator/src/lib/permissions.ts` - Permission checking
- `/Users/tylersahagun/Source/elmer/orchestrator/src/app/api/personas/route.ts` - Persona data source

### Secondary (MEDIUM confidence)
- `/Users/tylersahagun/Source/elmer/orchestrator/drizzle/0006_brave_purifiers.sql` - Migration confirms junction tables exist

### Tertiary (LOW confidence)
- None - all findings verified from codebase

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Verified from package.json and existing components
- Architecture: HIGH - Patterns extracted directly from working code
- Pitfalls: MEDIUM - Based on common patterns but not from production bugs
- Junction table queries: HIGH - Relations defined in schema.ts

**Research date:** 2026-01-22
**Valid until:** 2026-02-22 (30 days - stable codebase patterns)
