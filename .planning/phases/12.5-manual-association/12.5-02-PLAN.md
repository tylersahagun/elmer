---
phase: 12.5-manual-association
plan: 02
type: execute
wave: 2
depends_on: ["12.5-01"]
files_modified:
  - orchestrator/src/components/signals/SignalDetailModal.tsx
  - orchestrator/src/components/signals/ProjectLinkCombobox.tsx
  - orchestrator/src/components/signals/PersonaLinkCombobox.tsx
  - orchestrator/src/components/signals/LinkedTag.tsx
autonomous: true

must_haves:
  truths:
    - "User can see all projects linked to a signal in the detail modal"
    - "User can see all personas linked to a signal in the detail modal"
    - "User can add a project link via combobox dropdown"
    - "User can add a persona link via combobox dropdown"
    - "User can remove a project link by clicking X on the tag"
    - "User can remove a persona link by clicking X on the tag"
  artifacts:
    - path: "orchestrator/src/components/signals/LinkedTag.tsx"
      provides: "Reusable removable tag component"
      min_lines: 30
    - path: "orchestrator/src/components/signals/ProjectLinkCombobox.tsx"
      provides: "Project selection combobox for linking"
      min_lines: 60
    - path: "orchestrator/src/components/signals/PersonaLinkCombobox.tsx"
      provides: "Persona selection combobox for linking"
      min_lines: 60
    - path: "orchestrator/src/components/signals/SignalDetailModal.tsx"
      provides: "Extended modal with association management"
      contains: "ProjectLinkCombobox"
  key_links:
    - from: "orchestrator/src/components/signals/SignalDetailModal.tsx"
      to: "/api/signals/[id]/projects"
      via: "useMutation fetch"
      pattern: "api/signals.*projects"
    - from: "orchestrator/src/components/signals/SignalDetailModal.tsx"
      to: "/api/signals/[id]/personas"
      via: "useMutation fetch"
      pattern: "api/signals.*personas"
---

<objective>
Extend SignalDetailModal with inline project and persona linking using combobox dropdowns and removable tags.

Purpose: Enable users to manage signal associations directly from the signal detail view - the primary workflow for linking signals to projects/personas.

Output: SignalDetailModal displays linked projects/personas as removable tags, with comboboxes to add new associations. Changes persist via API and update UI optimistically.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12.5-manual-association/12.5-CONTEXT.md
@.planning/phases/12.5-manual-association/12.5-RESEARCH.md

Reference files:
@orchestrator/src/components/signals/SignalDetailModal.tsx
@orchestrator/src/components/ui/select.tsx
@orchestrator/src/components/ui/badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LinkedTag reusable component</name>
  <files>orchestrator/src/components/signals/LinkedTag.tsx</files>
  <action>
Create a reusable removable tag component at `orchestrator/src/components/signals/LinkedTag.tsx`:

```typescript
"use client";

import { X, Loader2 } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { cn } from "@/lib/utils";

interface LinkedTagProps {
  label: string;
  onRemove: () => void;
  isLoading?: boolean;
  variant?: "project" | "persona";
  className?: string;
}

const VARIANT_COLORS = {
  project: "bg-blue-500/20 text-blue-300 border-blue-500/30 hover:bg-blue-500/30",
  persona: "bg-violet-500/20 text-violet-300 border-violet-500/30 hover:bg-violet-500/30",
};

export function LinkedTag({
  label,
  onRemove,
  isLoading = false,
  variant = "project",
  className,
}: LinkedTagProps) {
  return (
    <Badge
      className={cn(
        "gap-1 pr-1 transition-colors",
        VARIANT_COLORS[variant],
        className
      )}
    >
      <span className="truncate max-w-[120px]">{label}</span>
      <button
        onClick={(e) => {
          e.stopPropagation();
          onRemove();
        }}
        disabled={isLoading}
        className="hover:bg-destructive/20 rounded p-0.5 ml-1 transition-colors"
        aria-label={`Remove ${label}`}
      >
        {isLoading ? (
          <Loader2 className="w-3 h-3 animate-spin" />
        ) : (
          <X className="w-3 h-3" />
        )}
      </button>
    </Badge>
  );
}
```

This follows the InboxPanel badge pattern from the RESEARCH.md document.
  </action>
  <verify>
Run `cd /Users/tylersahagun/Source/elmer/orchestrator && npm run build` - component compiles.
  </verify>
  <done>
LinkedTag component created with project/persona color variants, loading state, and accessible remove button.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ProjectLinkCombobox and PersonaLinkCombobox components</name>
  <files>
    orchestrator/src/components/signals/ProjectLinkCombobox.tsx
    orchestrator/src/components/signals/PersonaLinkCombobox.tsx
  </files>
  <action>
**File 1: `orchestrator/src/components/signals/ProjectLinkCombobox.tsx`**

```typescript
"use client";

import { useQuery } from "@tanstack/react-query";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Loader2 } from "lucide-react";

interface Project {
  id: string;
  name: string;
}

interface ProjectLinkComboboxProps {
  workspaceId: string;
  excludeProjectIds?: string[];
  onSelect: (projectId: string) => void;
  isLoading?: boolean;
}

export function ProjectLinkCombobox({
  workspaceId,
  excludeProjectIds = [],
  onSelect,
  isLoading = false,
}: ProjectLinkComboboxProps) {
  // Fetch workspace projects
  const { data: projectsData, isLoading: projectsLoading } = useQuery({
    queryKey: ["projects", workspaceId],
    queryFn: async () => {
      const res = await fetch(`/api/workspaces/${workspaceId}`);
      if (!res.ok) throw new Error("Failed to load workspace");
      const workspace = await res.json();
      return workspace.projects as Project[];
    },
  });

  const availableProjects = (projectsData || []).filter(
    (p) => !excludeProjectIds.includes(p.id)
  );

  if (projectsLoading) {
    return (
      <div className="flex items-center gap-2 text-sm text-muted-foreground">
        <Loader2 className="w-3 h-3 animate-spin" />
        Loading projects...
      </div>
    );
  }

  if (availableProjects.length === 0) {
    return (
      <span className="text-xs text-muted-foreground">
        All projects linked
      </span>
    );
  }

  return (
    <Select
      onValueChange={onSelect}
      disabled={isLoading}
    >
      <SelectTrigger className="h-7 w-[180px] text-xs">
        <SelectValue placeholder="Link to project..." />
      </SelectTrigger>
      <SelectContent>
        {availableProjects.map((project) => (
          <SelectItem key={project.id} value={project.id}>
            {project.name}
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  );
}
```

**File 2: `orchestrator/src/components/signals/PersonaLinkCombobox.tsx`**

```typescript
"use client";

import { useQuery } from "@tanstack/react-query";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Loader2 } from "lucide-react";

interface Persona {
  archetype_id: string;
  name: string;
}

interface PersonaLinkComboboxProps {
  excludePersonaIds?: string[];
  onSelect: (personaId: string) => void;
  isLoading?: boolean;
}

export function PersonaLinkCombobox({
  excludePersonaIds = [],
  onSelect,
  isLoading = false,
}: PersonaLinkComboboxProps) {
  // Fetch personas from API
  const { data: personasData, isLoading: personasLoading } = useQuery({
    queryKey: ["personas"],
    queryFn: async () => {
      const res = await fetch("/api/personas");
      if (!res.ok) throw new Error("Failed to load personas");
      const data = await res.json();
      return data.personas as Persona[];
    },
  });

  const availablePersonas = (personasData || []).filter(
    (p) => !excludePersonaIds.includes(p.archetype_id)
  );

  if (personasLoading) {
    return (
      <div className="flex items-center gap-2 text-sm text-muted-foreground">
        <Loader2 className="w-3 h-3 animate-spin" />
        Loading personas...
      </div>
    );
  }

  if (availablePersonas.length === 0) {
    return (
      <span className="text-xs text-muted-foreground">
        All personas linked
      </span>
    );
  }

  return (
    <Select
      onValueChange={onSelect}
      disabled={isLoading}
    >
      <SelectTrigger className="h-7 w-[180px] text-xs">
        <SelectValue placeholder="Link to persona..." />
      </SelectTrigger>
      <SelectContent>
        {availablePersonas.map((persona) => (
          <SelectItem key={persona.archetype_id} value={persona.archetype_id}>
            {persona.name}
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  );
}
```

Note: Uses archetype_id as value (stable identifier), name as display text per RESEARCH.md recommendation.
  </action>
  <verify>
Run `cd /Users/tylersahagun/Source/elmer/orchestrator && npm run build` - both components compile without error.
  </verify>
  <done>
ProjectLinkCombobox fetches workspace projects, filters out already-linked projects, and calls onSelect with projectId. PersonaLinkCombobox fetches personas from /api/personas, uses archetype_id as value.
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend SignalDetailModal with association management</name>
  <files>orchestrator/src/components/signals/SignalDetailModal.tsx</files>
  <action>
Modify SignalDetailModal.tsx to add project and persona linking sections:

1. **Add new imports at top:**
```typescript
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { LinkedTag } from "./LinkedTag";
import { ProjectLinkCombobox } from "./ProjectLinkCombobox";
import { PersonaLinkCombobox } from "./PersonaLinkCombobox";
```

2. **Extend Signal interface** to include linked data:
```typescript
interface Signal {
  // ... existing fields ...
  // Add these:
  linkedProjects?: Array<{
    id: string;
    name: string;
    linkedAt: string;
    linkReason?: string;
  }>;
  linkedPersonas?: Array<{
    personaId: string;
    personaName?: string;
    linkedAt: string;
  }>;
}
```

3. **Add query to fetch linked data** inside the component:
```typescript
// Fetch linked projects and personas
const { data: linkedData, refetch: refetchLinks } = useQuery({
  queryKey: ["signal-links", signal?.id],
  queryFn: async () => {
    if (!signal) return { projects: [], personas: [] };

    const [projectsRes, personasRes] = await Promise.all([
      fetch(`/api/signals/${signal.id}/projects`),
      fetch(`/api/signals/${signal.id}/personas`),
    ]);

    const projects = projectsRes.ok ? (await projectsRes.json()).projects : [];
    const personas = personasRes.ok ? (await personasRes.json()).personas : [];

    return { projects, personas };
  },
  enabled: !!signal && isOpen,
});
```

4. **Add mutations for link/unlink:**
```typescript
const linkProjectMutation = useMutation({
  mutationFn: async (projectId: string) => {
    const res = await fetch(`/api/signals/${signal!.id}/projects`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ projectId }),
    });
    if (!res.ok) throw new Error("Failed to link project");
    return res.json();
  },
  onSuccess: () => {
    refetchLinks();
    queryClient.invalidateQueries({ queryKey: ["signals"] });
  },
});

const unlinkProjectMutation = useMutation({
  mutationFn: async (projectId: string) => {
    const res = await fetch(`/api/signals/${signal!.id}/projects`, {
      method: "DELETE",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ projectId }),
    });
    if (!res.ok) throw new Error("Failed to unlink project");
    return res.json();
  },
  onSuccess: () => {
    refetchLinks();
    queryClient.invalidateQueries({ queryKey: ["signals"] });
  },
});

const linkPersonaMutation = useMutation({
  mutationFn: async (personaId: string) => {
    const res = await fetch(`/api/signals/${signal!.id}/personas`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ personaId }),
    });
    if (!res.ok) throw new Error("Failed to link persona");
    return res.json();
  },
  onSuccess: () => {
    refetchLinks();
    queryClient.invalidateQueries({ queryKey: ["signals"] });
  },
});

const unlinkPersonaMutation = useMutation({
  mutationFn: async (personaId: string) => {
    const res = await fetch(`/api/signals/${signal!.id}/personas`, {
      method: "DELETE",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ personaId }),
    });
    if (!res.ok) throw new Error("Failed to unlink persona");
    return res.json();
  },
  onSuccess: () => {
    refetchLinks();
    queryClient.invalidateQueries({ queryKey: ["signals"] });
  },
});
```

5. **Add UI section in view mode** (after the metadata row, before quick actions):
```tsx
{/* Linked Projects */}
<div className="space-y-2 pt-2 border-t border-border">
  <Label className="text-xs text-muted-foreground">Linked Projects</Label>
  <div className="flex flex-wrap items-center gap-2">
    {(linkedData?.projects || []).map((project) => (
      <LinkedTag
        key={project.id}
        label={project.name}
        variant="project"
        onRemove={() => unlinkProjectMutation.mutate(project.id)}
        isLoading={unlinkProjectMutation.isPending}
      />
    ))}
    <ProjectLinkCombobox
      workspaceId={signal.workspaceId}
      excludeProjectIds={(linkedData?.projects || []).map((p) => p.id)}
      onSelect={(projectId) => linkProjectMutation.mutate(projectId)}
      isLoading={linkProjectMutation.isPending}
    />
  </div>
</div>

{/* Linked Personas */}
<div className="space-y-2 pt-2 border-t border-border">
  <Label className="text-xs text-muted-foreground">Linked Personas</Label>
  <div className="flex flex-wrap items-center gap-2">
    {(linkedData?.personas || []).map((persona) => (
      <LinkedTag
        key={persona.personaId}
        label={persona.personaName || persona.personaId}
        variant="persona"
        onRemove={() => unlinkPersonaMutation.mutate(persona.personaId)}
        isLoading={unlinkPersonaMutation.isPending}
      />
    ))}
    <PersonaLinkCombobox
      excludePersonaIds={(linkedData?.personas || []).map((p) => p.personaId)}
      onSelect={(personaId) => linkPersonaMutation.mutate(personaId)}
      isLoading={linkPersonaMutation.isPending}
    />
  </div>
</div>
```

6. **Add persona names to the query response** - Update the GET personas fetch to also get persona names from the /api/personas endpoint (cache it):
```typescript
// Add query for persona names (used to display names for linked personas)
const { data: personasData } = useQuery({
  queryKey: ["personas"],
  queryFn: async () => {
    const res = await fetch("/api/personas");
    if (!res.ok) return { personas: [] };
    return res.json();
  },
});

// Map persona IDs to names
const personaNameMap = new Map(
  (personasData?.personas || []).map((p) => [p.archetype_id, p.name])
);

// In the render, use: personaNameMap.get(persona.personaId) || persona.personaId
```
  </action>
  <verify>
Run `cd /Users/tylersahagun/Source/elmer/orchestrator && npm run build` - SignalDetailModal compiles without error.
  </verify>
  <done>
SignalDetailModal displays linked projects and personas as removable tags, with comboboxes to add new links. Changes trigger refetch and invalidate signals list cache.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` passes in orchestrator directory
2. LinkedTag, ProjectLinkCombobox, PersonaLinkCombobox components exist
3. SignalDetailModal imports and uses the new components
4. No TypeScript errors
</verification>

<success_criteria>
- User opens signal detail modal and sees existing linked projects as blue tags
- User opens signal detail modal and sees existing linked personas as violet tags
- User can click X on a project tag to unlink (tag disappears after brief loading state)
- User can click X on a persona tag to unlink (tag disappears after brief loading state)
- User can select a project from dropdown to link (new tag appears)
- User can select a persona from dropdown to link (new tag appears)
- Changes persist after closing and reopening modal
</success_criteria>

<output>
After completion, create `.planning/phases/12.5-manual-association/12.5-02-SUMMARY.md`
</output>
