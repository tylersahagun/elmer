---
phase: 12.5-manual-association
plan: 03
type: execute
wave: 2
depends_on: ["12.5-01"]
files_modified:
  - orchestrator/src/components/signals/SignalRow.tsx
  - orchestrator/src/components/signals/SignalsTable.tsx
  - orchestrator/src/lib/db/queries.ts
  - orchestrator/src/app/api/signals/route.ts
autonomous: true

must_haves:
  truths:
    - "User can see project badges in the signal table row"
    - "User can see persona badges in the signal table row"
    - "First badge shown with count if multiple (e.g., [auth] +2)"
    - "Badges are visible at a glance during signal scanning"
  artifacts:
    - path: "orchestrator/src/components/signals/SignalRow.tsx"
      provides: "Signal row with project/persona badge visibility"
      contains: "projectBadge"
    - path: "orchestrator/src/lib/db/queries.ts"
      provides: "Extended getSignals to include linked counts"
      contains: "signalProjects"
  key_links:
    - from: "orchestrator/src/components/signals/SignalRow.tsx"
      to: "signal.linkedProjects"
      via: "map and render"
      pattern: "linkedProjects"
---

<objective>
Add project and persona badge visibility to SignalRow for at-a-glance association status during signal scanning.

Purpose: Enable provenance chain visibility - users need to see which signals are tracked vs. floating unlinked while scanning the signals list.

Output: SignalRow displays minimal indicators showing first project/persona badge plus count if more, clickable badges to open project in new tab.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12.5-manual-association/12.5-CONTEXT.md
@.planning/phases/12.5-manual-association/12.5-RESEARCH.md

Reference files:
@orchestrator/src/components/signals/SignalRow.tsx
@orchestrator/src/components/signals/SignalsTable.tsx
@orchestrator/src/lib/db/queries.ts
@orchestrator/src/app/api/signals/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend getSignals to include linked project/persona data</name>
  <files>
    orchestrator/src/lib/db/queries.ts
    orchestrator/src/app/api/signals/route.ts
  </files>
  <action>
**File 1: queries.ts - Modify getSignals function:**

The current getSignals returns signals without linked data. Modify it to include project and persona counts/first items:

1. Update the query to use Drizzle relations to fetch linked data:
```typescript
export async function getSignals(
  workspaceId: string,
  options: {
    status?: SignalStatus;
    source?: SignalSource;
    search?: string;
    startDate?: string;
    endDate?: string;
    page?: number;
    pageSize?: number;
    sortBy?: string;
    sortOrder?: "asc" | "desc";
    personaId?: string;  // NEW: filter by persona
  } = {}
) {
  // ... existing filter building code ...

  // Modify the query to include linked data
  const results = await db.query.signals.findMany({
    where: and(...conditions),
    with: {
      projects: {
        with: {
          project: {
            columns: {
              id: true,
              name: true,
            },
          },
        },
        limit: 3, // Only need first few for display
      },
      personas: true,
    },
    orderBy: [sortOrder === "desc" ? desc(sortCol) : asc(sortCol)],
    limit: pageSize,
    offset: (page - 1) * pageSize,
  });

  // Transform results to include linkedProjects and linkedPersonas arrays
  return results.map((signal) => ({
    ...signal,
    linkedProjects: signal.projects.map((sp) => ({
      id: sp.project.id,
      name: sp.project.name,
    })),
    linkedPersonas: signal.personas.map((sp) => ({
      personaId: sp.personaId,
    })),
    // Clean up the raw relations from response
    projects: undefined,
    personas: undefined,
  }));
}
```

2. Add personaId filter support (for Phase 12.5 CONTEXT.md persona browsing):
```typescript
// Inside the conditions array building:
if (options.personaId) {
  // Subquery to find signals linked to this persona
  const signalIdsWithPersona = db
    .select({ signalId: signalPersonas.signalId })
    .from(signalPersonas)
    .where(eq(signalPersonas.personaId, options.personaId));

  conditions.push(inArray(signals.id, signalIdsWithPersona));
}
```

Import `inArray` from drizzle-orm if not already imported.

**File 2: route.ts - Pass personaId from query params:**

Update the GET handler in `/api/signals/route.ts` to accept personaId:
```typescript
const personaId = searchParams.get("personaId") || undefined;

const signalsData = await getSignals(workspaceId, {
  // ... existing options ...
  personaId,
});
```
  </action>
  <verify>
Run `cd /Users/tylersahagun/Source/elmer/orchestrator && npm run build` - queries compile without error.
  </verify>
  <done>
getSignals now returns linkedProjects and linkedPersonas arrays with each signal. Supports filtering by personaId for persona-based browsing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend SignalRow with project and persona badges</name>
  <files>orchestrator/src/components/signals/SignalRow.tsx</files>
  <action>
Modify SignalRow.tsx to display linked projects and personas:

1. **Update SignalRowProps interface:**
```typescript
interface SignalRowProps {
  signal: {
    id: string;
    verbatim: string;
    interpretation?: string | null;
    status: "new" | "reviewed" | "linked" | "archived";
    source: string;
    severity?: string | null;
    createdAt: string;
    // NEW:
    linkedProjects?: Array<{ id: string; name: string }>;
    linkedPersonas?: Array<{ personaId: string }>;
  };
  onView: (signal: SignalRowProps["signal"]) => void;
  onDelete: (id: string) => void;
}
```

2. **Add badge colors for projects/personas:**
```typescript
const PROJECT_BADGE_COLOR = "bg-blue-500/20 text-blue-300 border-blue-500/30";
const PERSONA_BADGE_COLOR = "bg-violet-500/20 text-violet-300 border-violet-500/30";
```

3. **Create a helper component for association badges:**
```typescript
function AssociationBadge({
  items,
  variant,
  getLabel,
  getId,
  onNavigate,
}: {
  items: unknown[];
  variant: "project" | "persona";
  getLabel: (item: unknown) => string;
  getId: (item: unknown) => string;
  onNavigate?: (id: string) => void;
}) {
  if (!items || items.length === 0) {
    return <span className="text-muted-foreground text-xs">-</span>;
  }

  const first = items[0];
  const remaining = items.length - 1;
  const colorClass = variant === "project" ? PROJECT_BADGE_COLOR : PERSONA_BADGE_COLOR;

  return (
    <div className="flex items-center gap-1">
      <Badge
        className={cn("text-[10px] cursor-pointer hover:opacity-80", colorClass)}
        onClick={(e) => {
          e.stopPropagation();
          if (onNavigate) {
            onNavigate(getId(first));
          }
        }}
      >
        {truncateText(getLabel(first), 15)}
      </Badge>
      {remaining > 0 && (
        <span className="text-[10px] text-muted-foreground">+{remaining}</span>
      )}
    </div>
  );
}
```

4. **Add new columns to the row** - Insert after Source column, before Created column:
```tsx
{/* Projects */}
<td className="py-3 px-4">
  <AssociationBadge
    items={signal.linkedProjects || []}
    variant="project"
    getLabel={(p: { name: string }) => p.name}
    getId={(p: { id: string }) => p.id}
    onNavigate={(projectId) => {
      window.open(`/projects/${projectId}`, "_blank");
    }}
  />
</td>

{/* Personas */}
<td className="py-3 px-4">
  <AssociationBadge
    items={signal.linkedPersonas || []}
    variant="persona"
    getLabel={(p: { personaId: string }) => p.personaId}
    getId={(p: { personaId: string }) => p.personaId}
  />
</td>
```

Note: The AssociationBadge for personas just shows personaId. A future enhancement could fetch persona names, but for MVP this is sufficient.
  </action>
  <verify>
Run `cd /Users/tylersahagun/Source/elmer/orchestrator && npm run build` - SignalRow compiles without error.
  </verify>
  <done>
SignalRow displays project and persona badges with first item shown and count for additional items. Project badges are clickable to open project page in new tab.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update SignalsTable header to include new columns</name>
  <files>orchestrator/src/components/signals/SignalsTable.tsx</files>
  <action>
Modify SignalsTable.tsx to add Projects and Personas column headers:

1. **Update the table header row** - Add new `<th>` elements after Source, before Created:
```tsx
<thead>
  <tr className="border-b border-border text-left">
    <th className="py-3 px-4 font-medium text-sm">
      <button /* sortable verbatim */> ... </button>
    </th>
    <th className="py-3 px-4 font-medium text-sm">Status</th>
    <th className="py-3 px-4 font-medium text-sm">Source</th>
    {/* NEW columns */}
    <th className="py-3 px-4 font-medium text-sm">Projects</th>
    <th className="py-3 px-4 font-medium text-sm">Personas</th>
    {/* End new */}
    <th className="py-3 px-4 font-medium text-sm">Severity</th>
    <th className="py-3 px-4 font-medium text-sm">
      <button /* sortable createdAt */> ... </button>
    </th>
    <th className="py-3 px-4 font-medium text-sm">Actions</th>
  </tr>
</thead>
```

2. **Verify SignalRow is receiving the new data** - The SignalRow should already receive linkedProjects and linkedPersonas if the API returns them (which Task 1 ensures).

3. **Optional: Add persona filter to SignalFilters** - Add a persona dropdown filter:
```tsx
// In SignalFilters.tsx
const { data: personasData } = useQuery({
  queryKey: ["personas"],
  queryFn: async () => {
    const res = await fetch("/api/personas");
    if (!res.ok) return { personas: [] };
    return res.json();
  },
});

// Add filter control
<Select value={filters.personaId || "all"} onValueChange={(v) => onChange({ personaId: v === "all" ? undefined : v })}>
  <SelectTrigger className="w-[160px]">
    <SelectValue placeholder="All personas" />
  </SelectTrigger>
  <SelectContent>
    <SelectItem value="all">All personas</SelectItem>
    {(personasData?.personas || []).map((p) => (
      <SelectItem key={p.archetype_id} value={p.archetype_id}>
        {p.name}
      </SelectItem>
    ))}
  </SelectContent>
</Select>
```

This implements the "Persona browsing" feature from CONTEXT.md: "Show me all signals for Enterprise Admin".
  </action>
  <verify>
Run `cd /Users/tylersahagun/Source/elmer/orchestrator && npm run build` - SignalsTable compiles without error.
  </verify>
  <done>
SignalsTable has Projects and Personas columns. Optional persona filter allows browsing signals by persona category.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` passes in orchestrator directory
2. Signal list shows Projects and Personas columns
3. API returns linkedProjects and linkedPersonas with each signal
4. Badges display correctly with counts
</verification>

<success_criteria>
- Signals table shows new "Projects" and "Personas" columns
- Each row shows the first linked project name as a blue badge
- If multiple projects linked, shows "+N" count after the badge
- Each row shows the first linked persona as a violet badge
- If multiple personas linked, shows "+N" count after the badge
- Clicking a project badge opens the project page in a new tab
- Empty associations show "-" placeholder
</success_criteria>

<output>
After completion, create `.planning/phases/12.5-manual-association/12.5-03-SUMMARY.md`
</output>
