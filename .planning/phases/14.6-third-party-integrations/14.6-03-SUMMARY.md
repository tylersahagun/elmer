---
phase: 14.6
plan: 03
subsystem: api
tags: [webhooks, pylon, slack, integrations, events-api]
requires:
  - Phase 14.6-01 (integrations table schema)
  - Phase 14.6-02 (integration utilities library)
provides:
  - Pylon webhook endpoint (/api/webhooks/pylon)
  - Slack Events API endpoint (/api/webhooks/slack/events)
  - Platform-specific signature verification
  - Queue-first webhook processing
affects:
  - Future OAuth UI phase
  - Integration management UI
tech-stack:
  added: []
  patterns:
    - Platform-specific webhook endpoints
    - URL verification challenge handling (Slack)
    - integration_id query param mapping (Pylon)
key-files:
  created:
    - orchestrator/src/app/api/webhooks/pylon/route.ts
    - orchestrator/src/app/api/webhooks/slack/events/route.ts
  modified: []
decisions:
  - id: 14.6-03-01
    decision: "Pylon workspace mapping via integration_id query parameter"
    rationale: "Pylon payloads don't include workspace identifier; query param configured when setting up webhook in Pylon"
  - id: 14.6-03-02
    decision: "Slack workspace lookup via team_id from payload"
    rationale: "Slack includes team_id in every event; stored during manual integration configuration"
  - id: 14.6-03-03
    decision: "URL verification challenge handled before signature verification"
    rationale: "Slack sends url_verification during endpoint setup; must respond immediately without auth"
  - id: 14.6-03-04
    decision: "Filter bot messages and message subtypes from Slack signals"
    rationale: "Prevents infinite loops and noise from bot posts, edits, deletes, channel joins"
metrics:
  duration: 3 minutes
  completed: 2026-01-23
---

# Phase 14.6 Plan 03: Webhook Endpoints Summary

**Dedicated webhook endpoints for Pylon tickets and Slack messages with platform-specific auth and async processing**

## Performance

- **Duration:** 3 min
- **Started:** 2026-01-23T19:28:35Z
- **Completed:** 2026-01-23T19:31:42Z
- **Tasks:** 2
- **Files created:** 2

## Accomplishments

- Pylon webhook endpoint with HMAC-SHA256 signature verification
- Slack Events API endpoint with url_verification challenge handling
- Message filtering for bot messages, subtypes, and empty content
- Queue-first pattern with after() for async signal creation
- lastUsedAt tracking for integration usage monitoring

## Task Commits

Each task was committed atomically:

1. **Task 1: Create Pylon webhook endpoint** - `626dc8c` (feat)
2. **Task 2: Create Slack Events API endpoint** - `06c27a8` (feat)

## Files Created

- `orchestrator/src/app/api/webhooks/pylon/route.ts` - Pylon ticket ingestion endpoint
- `orchestrator/src/app/api/webhooks/slack/events/route.ts` - Slack message ingestion endpoint

## Technical Details

### Pylon Endpoint (/api/webhooks/pylon)

- **URL format:** `POST /api/webhooks/pylon?integration_id={id}`
- **Auth headers:** `pylon-webhook-timestamp`, `pylon-webhook-signature`
- **Workspace mapping:** Via `integration_id` query parameter
- **Processing:** Queue-first with after() for signal creation

### Slack Endpoint (/api/webhooks/slack/events)

- **URL format:** `POST /api/webhooks/slack/events`
- **URL verification:** Returns `{ challenge }` for setup
- **Auth headers:** `x-slack-request-timestamp`, `x-slack-signature`
- **Workspace mapping:** Via `team_id` in payload (stored in integration.slackTeamId)
- **Filters:** Bot messages, message subtypes (edits, deletes), empty messages
- **Processing:** Queue-first with after() for signal creation

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Pylon uses integration_id query param | Pylon payloads don't include workspace identifier |
| Slack uses team_id from payload | Slack includes team_id in every event |
| URL verification before signature check | Slack setup requires immediate challenge response |
| Filter bot_id and slackBotUserId | Prevents infinite loops and self-processing |
| Filter message subtypes | Edits, deletes, joins aren't user feedback signals |

## Deviations from Plan

None - plan executed exactly as written.

## User Setup Required

**External services require manual configuration.** For Pylon and Slack webhooks:

### Pylon Setup

1. Go to Pylon Dashboard -> Settings -> Webhooks
2. Add webhook URL: `https://your-domain.com/api/webhooks/pylon?integration_id={id}`
3. Copy the signing secret for Elmer integration configuration

### Slack Setup

1. Create Slack App at https://api.slack.com/apps -> Create New App
2. Enable Events API at Slack App -> Event Subscriptions
3. Set Request URL: `https://your-domain.com/api/webhooks/slack/events`
4. Subscribe to `message.channels` and `message.groups` events
5. Copy Signing Secret from Basic Information
6. Install app to workspace and note team_id

## Verification Results

| Criterion | Status |
|-----------|--------|
| TypeScript compiles | PASSED |
| /api/webhooks/pylon/route.ts exports POST handler | PASSED |
| /api/webhooks/slack/events/route.ts exports POST handler | PASSED |
| Pylon endpoint requires integration_id query parameter | PASSED |
| Slack endpoint handles url_verification challenge | PASSED |
| Slack endpoint filters bot messages and subtypes | PASSED |
| Both endpoints use after() for async processing | PASSED |
| Both endpoints update integration lastUsedAt | PASSED |

## Next Phase Readiness

**Ready for:**
- Integration management UI (Phase 15+)
- Manual integration configuration via database
- Webhook testing with real Pylon/Slack events

**Note:** Run integrations migration before testing: `npx drizzle-kit migrate`

---
*Phase: 14.6-third-party-integrations*
*Completed: 2026-01-23*
