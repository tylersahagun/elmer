---
phase: 14.6-third-party-integrations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - orchestrator/src/lib/db/schema.ts
  - orchestrator/src/lib/db/index.ts
  - orchestrator/drizzle/*.sql
autonomous: true

must_haves:
  truths:
    - "Integrations table exists with platform, workspace association, and credential fields"
    - "Integration types support both Pylon and Slack platforms"
    - "Credentials can be stored per workspace with isActive flag"
  artifacts:
    - path: "orchestrator/src/lib/db/schema.ts"
      provides: "integrations table definition with relations"
      contains: "export const integrations = pgTable"
    - path: "orchestrator/src/lib/db/index.ts"
      provides: "Integration and NewIntegration type exports"
      contains: "Integration"
    - path: "orchestrator/drizzle/"
      provides: "Migration file for integrations table"
  key_links:
    - from: "integrations table"
      to: "workspaces table"
      via: "foreign key with cascade delete"
      pattern: 'references.*workspaces.id.*onDelete: "cascade"'
    - from: "integrations table"
      to: "users table"
      via: "createdBy foreign key with set null"
      pattern: 'references.*users.id.*onDelete: "set null"'
---

<objective>
Create the integrations table for storing third-party integration credentials (Pylon webhook secrets, Slack OAuth tokens) per workspace.

Purpose: Phase 14.6 requires per-workspace credential storage for Pylon and Slack integrations. This follows the established webhookKeys pattern but adds platform-specific fields for OAuth tokens (Slack) and webhook secrets (Pylon).

Output: Database schema with integrations table, TypeScript types, and Drizzle migration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14.6-third-party-integrations/14.6-RESEARCH.md
@orchestrator/src/lib/db/schema.ts
@orchestrator/src/lib/db/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add integrations table to schema</name>
  <files>orchestrator/src/lib/db/schema.ts</files>
  <action>
Add the integrations table definition after the webhookKeys section. Include:

1. **Core fields:**
   - id: text primary key with nanoid default
   - workspaceId: text, required, references workspaces with cascade delete
   - platform: text with union type "pylon" | "slack", required
   - name: text, required (user-friendly name like "Support Channel")

2. **Credential fields:**
   - webhookSecret: text (Pylon webhook secret, Slack signing secret)
   - accessToken: text (Slack xoxb-* bot token, null for Pylon)
   - refreshToken: text (Slack token rotation, null for Pylon)
   - tokenExpiresAt: timestamp (Slack token expiry)

3. **Platform-specific fields:**
   - slackTeamId: text (Slack workspace ID for team_id lookup)
   - slackTeamName: text (display name)
   - slackBotUserId: text (for filtering bot messages)
   - pylonAccountId: text (Pylon account identifier)

4. **Configuration:**
   - isActive: boolean, default true
   - config: jsonb with IntegrationConfig type (channels to listen, events to capture)

5. **Metadata:**
   - lastUsedAt: timestamp
   - createdAt: timestamp with defaultNow
   - createdBy: text, references users with set null

Also add IntegrationPlatform type and IntegrationConfig interface:

```typescript
export type IntegrationPlatform = "pylon" | "slack";

export interface IntegrationConfig {
  // Slack: which channels to listen to
  slackChannels?: Array<{ id: string; name: string }>;
  // Pylon: which ticket events to capture
  pylonEvents?: Array<"issue.created" | "issue.updated" | "issue.closed">;
}
```

Add relations for integrations (to workspace and creator), and update workspacesRelations to include integrations.

Follow the established pattern from webhookKeys for consistent style.
  </action>
  <verify>TypeScript compiles without errors: `cd orchestrator && npx tsc --noEmit`</verify>
  <done>integrations table defined with all required fields, types, and relations</done>
</task>

<task type="auto">
  <name>Task 2: Export types and generate migration</name>
  <files>orchestrator/src/lib/db/index.ts, orchestrator/drizzle/*.sql</files>
  <action>
1. In orchestrator/src/lib/db/index.ts, add exports:
   - Integration type (InferSelectModel)
   - NewIntegration type (InferInsertModel)
   - IntegrationPlatform type
   - IntegrationConfig interface

Add these exports alongside existing WebhookKey exports.

2. Generate Drizzle migration:
```bash
cd orchestrator && npx drizzle-kit generate
```

This will create a new migration file in orchestrator/drizzle/ for the integrations table.

3. Verify migration creates table with all columns and foreign keys.
  </action>
  <verify>
Run `cd orchestrator && npx tsc --noEmit` to verify types compile.
Check that migration file exists in orchestrator/drizzle/ with CREATE TABLE for integrations.
  </verify>
  <done>Integration types exported and migration file generated</done>
</task>

</tasks>

<verification>
- [ ] TypeScript compiles: `cd orchestrator && npx tsc --noEmit`
- [ ] integrations table defined in schema.ts with all fields
- [ ] IntegrationPlatform and IntegrationConfig types defined
- [ ] Relations defined for workspace and creator
- [ ] workspacesRelations includes integrations
- [ ] Migration file exists in drizzle/ directory
- [ ] Types exported from lib/db/index.ts
</verification>

<success_criteria>
1. integrations table schema exists with platform, webhookSecret, accessToken, refreshToken fields
2. TypeScript types (Integration, NewIntegration, IntegrationPlatform, IntegrationConfig) are exported
3. Drizzle migration file generated for integrations table
4. All foreign key relationships properly defined with correct cascade behavior
</success_criteria>

<output>
After completion, create `.planning/phases/14.6-third-party-integrations/14.6-01-SUMMARY.md`
</output>
