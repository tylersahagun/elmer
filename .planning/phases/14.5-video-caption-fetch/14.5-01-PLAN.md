---
phase: 14.5-video-caption-fetch
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - orchestrator/src/lib/video/validators.ts
  - orchestrator/src/lib/video/formatters.ts
  - orchestrator/src/lib/video/extractCaptions.ts
  - orchestrator/src/lib/video/index.ts
  - orchestrator/package.json
autonomous: true

must_haves:
  truths:
    - "YouTube video ID can be extracted from various URL formats"
    - "Timestamps are formatted as MM:SS or HH:MM:SS"
    - "Caption extraction returns text with embedded timestamps"
  artifacts:
    - path: "orchestrator/src/lib/video/validators.ts"
      provides: "parseVideoUrl function for URL validation and ID extraction"
      exports: ["parseVideoUrl", "VideoPlatform", "VideoUrlParseResult"]
    - path: "orchestrator/src/lib/video/formatters.ts"
      provides: "Timestamp formatting utilities"
      exports: ["formatTimestamp", "buildTranscriptWithTimestamps"]
    - path: "orchestrator/src/lib/video/extractCaptions.ts"
      provides: "YouTube caption extraction using youtube-caption-extractor"
      exports: ["extractYouTubeCaptions", "CaptionExtractionResult", "CaptionSegment"]
    - path: "orchestrator/src/lib/video/index.ts"
      provides: "Barrel exports for video module"
  key_links:
    - from: "orchestrator/src/lib/video/extractCaptions.ts"
      to: "youtube-caption-extractor"
      via: "getVideoDetails import"
      pattern: "import.*youtube-caption-extractor"
    - from: "orchestrator/src/lib/video/extractCaptions.ts"
      to: "orchestrator/src/lib/video/formatters.ts"
      via: "formatTimestamp import"
      pattern: "import.*formatTimestamp.*formatters"
---

<objective>
Create video caption extraction infrastructure for YouTube support.

Purpose: Enable the video API endpoint (Plan 02) to extract captions from YouTube videos. This mirrors the Phase 14 pattern of creating lib/files/ for file parsing - here we create lib/video/ for video caption extraction.

Output: lib/video/ module with URL validators, timestamp formatters, and YouTube caption extraction using youtube-caption-extractor library.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14.5-video-caption-fetch/14.5-RESEARCH.md
@orchestrator/src/lib/files/extractText.ts
@orchestrator/src/lib/files/validators.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install youtube-caption-extractor and create video infrastructure</name>
  <files>
    orchestrator/package.json
    orchestrator/src/lib/video/validators.ts
    orchestrator/src/lib/video/formatters.ts
    orchestrator/src/lib/video/extractCaptions.ts
    orchestrator/src/lib/video/index.ts
  </files>
  <action>
1. Install youtube-caption-extractor:
   ```bash
   cd orchestrator && npm install youtube-caption-extractor
   ```

2. Create `lib/video/validators.ts`:
   - Export type `VideoPlatform = "youtube" | "loom" | "unknown"`
   - Export interface `VideoUrlParseResult { platform, videoId, isValid, error? }`
   - Export function `parseVideoUrl(url: string): VideoUrlParseResult`
   - YouTube regex must handle: watch?v=, youtu.be/, embed/, shorts/, youtube-nocookie.com
   - Loom regex: loom.com/share/[32-hex-chars]
   - Return platform-specific result with extracted videoId

3. Create `lib/video/formatters.ts`:
   - Export function `formatTimestamp(seconds: number): string`
     - Return "MM:SS" for < 1 hour, "HH:MM:SS" for >= 1 hour
   - Export function `buildTranscriptWithTimestamps(segments: CaptionSegment[]): string`
     - Format: "[0:15] Caption text here\n[0:22] Next caption..."
   - Export function `buildPlainTranscript(segments: CaptionSegment[]): string`
     - Join segment texts with spaces (no timestamps)

4. Create `lib/video/extractCaptions.ts`:
   - Import { getVideoDetails, Subtitle } from "youtube-caption-extractor"
   - Export interface `CaptionSegment { start: number, duration: number, text: string }`
   - Export interface `CaptionExtractionResult { text, segments, metadata }`
   - Export async function `extractYouTubeCaptions(videoId: string, lang?: string): Promise<CaptionExtractionResult>`
     - Call getVideoDetails({ videoID: videoId, lang: lang || "en" })
     - If no subtitles returned, throw Error("No captions available for this video")
     - Convert Subtitle[] to CaptionSegment[] (parse start/dur to numbers)
     - Build text using buildTranscriptWithTimestamps()
     - Return { text, segments, metadata: { platform, videoId, videoUrl, videoTitle, language, segmentCount, charCount } }

5. Create `lib/video/index.ts` barrel:
   - Export * from validators, formatters, extractCaptions
  </action>
  <verify>
    - `ls orchestrator/src/lib/video/` shows all 4 files
    - `grep "youtube-caption-extractor" orchestrator/package.json` shows dependency
    - `cd orchestrator && npx tsc --noEmit` passes with no type errors
  </verify>
  <done>
    - youtube-caption-extractor installed
    - lib/video/ module complete with validators, formatters, extractCaptions, index
    - All exports typed correctly
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
- [ ] `npm ls youtube-caption-extractor` in orchestrator/ shows package installed
- [ ] `cat orchestrator/src/lib/video/index.ts` shows all exports
- [ ] `npx tsc --noEmit` passes in orchestrator/
</verification>

<success_criteria>
- lib/video/ module provides parseVideoUrl, formatTimestamp, buildTranscriptWithTimestamps, extractYouTubeCaptions exports
- YouTube URLs correctly parsed to extract video IDs
- Loom URLs detected (for future implementation) but return platform="loom"
- CaptionExtractionResult interface matches the pattern from lib/files/extractText.ts
</success_criteria>

<output>
After completion, create `.planning/phases/14.5-video-caption-fetch/14.5-01-SUMMARY.md`
</output>
