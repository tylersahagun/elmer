# Plan 02-02: Google OAuth Provider Configuration

## Frontmatter

```yaml
plan_id: "02-02"
phase: 2
wave: 1
depends_on: []
files_modified:
  - orchestrator/.env.local
  - orchestrator/.env.example
autonomous: false  # Requires user to configure Google Cloud Console
estimated_duration: "15 minutes"
```

## Objective

Configure Google OAuth so users can sign up and sign in with their Google account. This involves setting up Google Cloud Console credentials and updating environment variables.

## Context

**Phase 1 established:**
- Google provider already imported and configured in auth.ts
- Placeholder environment variables referenced

**This plan adds:**
- Documentation for Google Cloud Console setup
- Environment variable configuration
- Verification that OAuth flow works end-to-end

## Prerequisites

User must have:
- Access to Google Cloud Console (https://console.cloud.google.com)
- A Google Cloud project (or ability to create one)

## Tasks

<task id="1" name="Document Google Cloud Console Setup">
<description>
Create clear instructions for the user to configure Google OAuth credentials. This is a manual step that cannot be automated.
</description>
<files>
- orchestrator/.env.example
</files>
<instructions>
1. Update `orchestrator/.env.example` to include Google OAuth variables with comments:

```bash
# Google OAuth (required for "Sign in with Google")
# 1. Go to https://console.cloud.google.com/apis/credentials
# 2. Create OAuth 2.0 Client ID (Web application)
# 3. Add authorized redirect URIs:
#    - http://localhost:3000/api/auth/callback/google (development)
#    - https://your-domain.com/api/auth/callback/google (production)
# 4. Copy Client ID and Client Secret below
GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-client-secret
```

2. Present these instructions to the user as a checkpoint
</instructions>
<verification>
- [ ] .env.example updated with Google OAuth variables
- [ ] Comments explain how to get credentials
- [ ] Redirect URIs documented for both dev and prod
</verification>
</task>

<task id="2" name="Configure Environment Variables">
<description>
Guide user to add Google OAuth credentials to their local environment.
</description>
<files>
- orchestrator/.env.local
</files>
<instructions>
**CHECKPOINT: User Action Required**

Present to user:

---

## Google OAuth Setup Required

To enable "Sign in with Google", you need to configure OAuth credentials:

### Step 1: Create OAuth Credentials

1. Go to [Google Cloud Console](https://console.cloud.google.com/apis/credentials)
2. Select or create a project
3. Click "Create Credentials" â†’ "OAuth client ID"
4. Choose "Web application"
5. Name it (e.g., "Elmer Local Development")
6. Add Authorized redirect URIs:
   - `http://localhost:3000/api/auth/callback/google`
7. Click "Create"

### Step 2: Copy Credentials

Copy the Client ID and Client Secret from Google.

### Step 3: Update .env.local

Add to `orchestrator/.env.local`:

```bash
GOOGLE_CLIENT_ID=paste-your-client-id-here
GOOGLE_CLIENT_SECRET=paste-your-client-secret-here
```

### Step 4: Restart Dev Server

```bash
cd orchestrator
npm run dev
```

---

Wait for user to confirm completion before proceeding.
</instructions>
<verification>
- [ ] User confirms credentials are configured
- [ ] GOOGLE_CLIENT_ID is set in .env.local
- [ ] GOOGLE_CLIENT_SECRET is set in .env.local
</verification>
</task>

<task id="3" name="Verify OAuth Flow">
<description>
Test that Google OAuth works end-to-end by signing in with a Google account.
</description>
<files>
- None (testing only)
</files>
<instructions>
1. Start the development server if not running
2. Navigate to http://localhost:3000/signup
3. Click "Google" button
4. Should redirect to Google consent screen
5. After consent, should redirect back to app
6. User should be logged in with Google profile data

**If errors occur:**
- Check browser console for errors
- Check server logs for Auth.js errors
- Verify redirect URI matches exactly
- Ensure credentials are correct in .env.local
</instructions>
<verification>
- [ ] Google button redirects to Google consent screen
- [ ] After consent, redirects back to app
- [ ] User record created in database with Google profile
- [ ] accounts table has Google provider entry
- [ ] User is logged in (session exists)
</verification>
</task>

## Verification Criteria

After all tasks complete, verify:

1. **OAuth redirect works:**
   - Click Google button on /signup
   - Redirects to accounts.google.com

2. **Callback works:**
   - After Google consent, returns to app
   - No error page shown

3. **User created:**
   ```sql
   SELECT * FROM users WHERE email = 'your-google-email@gmail.com';
   ```
   - User exists with name and image from Google

4. **Account linked:**
   ```sql
   SELECT * FROM accounts WHERE provider = 'google';
   ```
   - Account record exists linking user to Google

## must_haves

These must be TRUE for the plan to be considered complete:

- [ ] User can click "Sign in with Google" and see Google consent screen
- [ ] After Google consent, user is redirected back to app
- [ ] User record created with name, email, avatar from Google profile
- [ ] User is logged in after OAuth flow completes

## Error Handling

### Common Issues

| Error | Cause | Fix |
|-------|-------|-----|
| "redirect_uri_mismatch" | Redirect URI not in Google Console | Add exact URI to authorized redirects |
| "invalid_client" | Wrong client ID/secret | Double-check credentials in .env.local |
| "access_denied" | User cancelled consent | Expected behavior, show login page |
| No redirect | Missing AUTH_URL | Ensure AUTH_URL=http://localhost:3000 in .env.local |

### Debugging

```bash
# Check Auth.js debug logs (enabled in auth.ts for development)
# Look for [auth] prefixed messages in server console
```

## Rollback

If OAuth doesn't work:
1. Google button still shows but redirects to error
2. User can still sign up with email/password (02-01)
3. Fix credentials and retry

---
*Plan 02-02 | Phase 2 | Wave 1*
