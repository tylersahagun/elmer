# Plan 02-01: Signup Page with Email/Password

## Frontmatter

```yaml
plan_id: "02-01"
phase: 2
wave: 1
depends_on: []
files_modified:
  - orchestrator/src/app/api/auth/signup/route.ts
  - orchestrator/src/app/signup/page.tsx
  - orchestrator/src/auth.ts
  - orchestrator/src/components/icons/google.tsx
autonomous: true
estimated_duration: "25 minutes"
```

## Objective

Create a signup page where users can register with email and password. The form creates a user account via API, hashes the password with bcryptjs, and automatically logs the user in after successful registration.

## Context

**Phase 1 established:**
- Users table with `passwordHash` column (nullable for OAuth users)
- Auth.js configuration with JWT strategy
- Drizzle adapter connected to database

**This plan adds:**
- Credentials provider to Auth.js (for login after signup)
- Signup API route (creates user with hashed password)
- Signup page UI (form with validation)
- Google icon component (for OAuth button, used in both plans)

## Tasks

<task id="1" name="Add Credentials Provider to Auth.js">
<description>
Modify `orchestrator/src/auth.ts` to add the Credentials provider. This enables email/password login after users sign up.
</description>
<files>
- orchestrator/src/auth.ts
</files>
<instructions>
1. Import `Credentials` from `next-auth/providers/credentials`
2. Import `bcrypt` from `bcryptjs`
3. Import `eq` from `drizzle-orm`
4. Add Credentials provider to the providers array with:
   - credentials: { email, password }
   - authorize function that:
     - Validates credentials exist
     - Queries user by email
     - Returns null if user not found or no passwordHash
     - Compares password with bcrypt.compare()
     - Returns user object if match, null otherwise
</instructions>
<verification>
- [ ] Credentials provider added to providers array
- [ ] authorize function handles missing credentials
- [ ] authorize function queries database for user
- [ ] authorize function uses bcrypt.compare() for password check
- [ ] No TypeScript errors in auth.ts
</verification>
</task>

<task id="2" name="Create Signup API Route">
<description>
Create the API endpoint that handles user registration. This route validates input, checks for duplicate emails, hashes the password, and creates the user record.
</description>
<files>
- orchestrator/src/app/api/auth/signup/route.ts
</files>
<instructions>
1. Create new file at `orchestrator/src/app/api/auth/signup/route.ts`
2. Import NextRequest, NextResponse from next/server
3. Import bcrypt from bcryptjs
4. Import db from @/lib/db
5. Import users from @/lib/db/schema
6. Import eq from drizzle-orm
7. Import nanoid from nanoid
8. Implement POST handler:
   - Parse JSON body for email, password, name
   - Validate email and password are present (400 if missing)
   - Validate password length >= 8 characters (400 if too short)
   - Check for existing user with same email (409 if exists)
   - Hash password with bcrypt.hash(password, 12)
   - Insert new user with nanoid() for id
   - Default name to email prefix if not provided
   - Return { user: { id, email, name } } with status 201
   - Catch errors and return 500
</instructions>
<verification>
- [ ] File exists at orchestrator/src/app/api/auth/signup/route.ts
- [ ] POST handler validates required fields
- [ ] Password minimum length enforced (8 chars)
- [ ] Duplicate email returns 409 status
- [ ] Password hashed with bcrypt before storage
- [ ] Response does not include passwordHash
- [ ] No TypeScript errors
</verification>
</task>

<task id="3" name="Create Google Icon Component">
<description>
Create a reusable Google icon SVG component for the OAuth button. This will be used on both signup and login pages.
</description>
<files>
- orchestrator/src/components/icons/google.tsx
</files>
<instructions>
1. Create directory `orchestrator/src/components/icons/` if it doesn't exist
2. Create `google.tsx` with:
   - Named export `GoogleIcon`
   - Accept className prop
   - Render Google "G" logo SVG
   - Use proper viewBox and colors (Google brand colors)
</instructions>
<verification>
- [ ] File exists at orchestrator/src/components/icons/google.tsx
- [ ] GoogleIcon component exported
- [ ] Accepts className prop
- [ ] Renders recognizable Google logo
</verification>
</task>

<task id="4" name="Create Signup Page">
<description>
Create the signup page UI with email/password form and Google OAuth button. The form handles validation, error display, and auto-login after successful registration.
</description>
<files>
- orchestrator/src/app/signup/page.tsx
</files>
<instructions>
1. Create `orchestrator/src/app/signup/page.tsx` as client component
2. Import useState, useRouter from React/Next
3. Import signIn from next-auth/react
4. Import Link from next/link
5. Import UI components: Button, Input, Label, Card (all parts), Alert
6. Import GoogleIcon from @/components/icons/google
7. Implement SignupPage component:
   - State: error (string | null), loading (boolean)
   - handleSubmit function:
     - Prevent default, clear error, set loading
     - Extract email, password, name from FormData
     - POST to /api/auth/signup
     - If error, display it
     - If success, call signIn("credentials", { email, password, redirect: false })
     - On login success, router.push("/")
   - Render:
     - Centered card layout (min-h-screen flex items-center justify-center)
     - Card with header (title: "Create an account", description: "Get started with Elmer")
     - Error alert if error state set
     - Form with name, email, password inputs
     - Submit button with loading state
     - Divider with "Or continue with"
     - Google OAuth button (calls signIn("google", { callbackUrl: "/" }))
     - Footer link to /login for existing users
</instructions>
<verification>
- [ ] File exists at orchestrator/src/app/signup/page.tsx
- [ ] "use client" directive at top
- [ ] Form submits to /api/auth/signup
- [ ] Error messages display in Alert component
- [ ] Loading state disables button and shows text
- [ ] Google button calls signIn("google")
- [ ] Link to /login for existing users
- [ ] Auto-login after successful signup
- [ ] No TypeScript errors
</verification>
</task>

## Verification Criteria

After all tasks complete, verify:

1. **Signup API works:**
   ```bash
   curl -X POST http://localhost:3000/api/auth/signup \
     -H "Content-Type: application/json" \
     -d '{"email":"test@example.com","password":"password123","name":"Test User"}'
   ```
   Expected: 201 with user object

2. **Duplicate email rejected:**
   ```bash
   # Run same curl again
   ```
   Expected: 409 with error message

3. **Page renders:**
   - Navigate to http://localhost:3000/signup
   - Form visible with all fields
   - Google button visible

4. **Database record:**
   - User exists in users table
   - passwordHash is NOT the plaintext password
   - passwordHash starts with `$2a$` or `$2b$` (bcrypt prefix)

## must_haves

These must be TRUE for the plan to be considered complete:

- [ ] User can fill signup form and submit
- [ ] Password is hashed with bcryptjs before storage
- [ ] Duplicate email shows clear error message
- [ ] After signup, user is automatically logged in
- [ ] Google OAuth button is present (functionality in 02-02)

## Rollback

If issues occur:
1. Delete `orchestrator/src/app/signup/page.tsx`
2. Delete `orchestrator/src/app/api/auth/signup/route.ts`
3. Delete `orchestrator/src/components/icons/google.tsx`
4. Revert changes to `orchestrator/src/auth.ts`

---
*Plan 02-01 | Phase 2 | Wave 1*
