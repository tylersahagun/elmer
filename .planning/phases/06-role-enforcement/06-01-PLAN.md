# Plan 06-01: Permission Service with requireWorkspaceAccess Helper

## Frontmatter

```yaml
plan_id: "06-01"
phase: 6
wave: 1
depends_on: ["05-01"]
files_modified:
  - orchestrator/src/lib/permissions.ts
autonomous: true
estimated_duration: "15 minutes"
```

## Objective

Create a centralized permission service with a `requireWorkspaceAccess` helper that validates user membership and role for workspace operations.

## Context

**Existing infrastructure:**
- `getWorkspaceMembership(workspaceId, userId)` query exists
- Role checks scattered across API routes
- Three roles: admin, member, viewer

**This plan adds:**
- Centralized permission checking
- Role hierarchy (admin > member > viewer)
- Reusable helper for API routes
- Clear error responses

## Tasks

<task id="1" name="Create Permission Service">
<description>
Create a permission service module with role checking utilities.
</description>
<files>
- orchestrator/src/lib/permissions.ts
</files>
<instructions>
1. Create `orchestrator/src/lib/permissions.ts`
2. Define role hierarchy: admin > member > viewer
3. Create `hasPermission(userRole, requiredRole)` function
4. Create `requireWorkspaceAccess(workspaceId, userId, requiredRole?)` function
   - Returns membership if valid
   - Throws typed error if not authorized
5. Create typed error classes for different failure modes
</instructions>
<verification>
- [ ] Role hierarchy is correct
- [ ] Helper returns membership on success
- [ ] Helper throws on unauthorized
- [ ] Error types are clear
</verification>
</task>

## Verification Criteria

After all tasks complete, verify:

1. **Permission checking:**
   - Admin has access to admin-level operations
   - Member has access to member-level operations
   - Viewer has access to viewer-level operations

2. **Error handling:**
   - Clear error for "not a member"
   - Clear error for "insufficient permissions"

## must_haves

- [ ] Role hierarchy defined
- [ ] requireWorkspaceAccess helper
- [ ] Typed error responses
- [ ] Reusable across API routes

---
*Plan 06-01 | Phase 6 | Wave 1*
