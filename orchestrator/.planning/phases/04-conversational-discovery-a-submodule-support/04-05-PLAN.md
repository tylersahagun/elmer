---
phase: 04-conversational-discovery-a-submodule-support
plan: 05
type: execute
wave: 3
depends_on: [04-01, 04-03]
files_modified:
  - src/components/discovery/ConversationPanel.tsx
  - src/components/discovery/QuestionCard.tsx
  - src/components/discovery/index.ts
autonomous: true

must_haves:
  truths:
    - "User sees clarifying questions in chat-like interface"
    - "User can select answers from options"
    - "User can see previous Q&A history"
    - "User can revise previous answers"
  artifacts:
    - path: "src/components/discovery/ConversationPanel.tsx"
      provides: "Conversation UI panel"
      exports: ["ConversationPanel"]
    - path: "src/components/discovery/QuestionCard.tsx"
      provides: "Question display with options"
      exports: ["QuestionCard"]
  key_links:
    - from: "src/components/discovery/ConversationPanel.tsx"
      to: "src/lib/stores/conversation-store.ts"
      via: "store hook"
      pattern: "useConversationStore"
---

<objective>
Create chat-like UI components for the conversational discovery flow, extending the ChatSidebar pattern.

Purpose: When ambiguities are detected, users need a friendly chat-like interface to answer clarifying questions. This provides a conversational experience (per CONV-02) rather than a form-like interaction.

Output: ConversationPanel component with message history, QuestionCard for displaying options, and answer/revision support.
</objective>

<execution_context>
@/Users/tylersahagun/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylersahagun/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/chat/ChatSidebar.tsx
@src/lib/stores/conversation-store.ts
@src/lib/discovery/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QuestionCard component</name>
  <files>src/components/discovery/QuestionCard.tsx</files>
  <action>
Create a component that displays a question with selectable options:

```typescript
"use client";

import { motion } from "framer-motion";
import { cn } from "@/lib/utils";
import { Check, HelpCircle } from "lucide-react";
import type { AmbiguityOption } from "@/lib/discovery/types";

interface QuestionCardProps {
  question: string;
  options: AmbiguityOption[];
  onSelectOption: (option: AmbiguityOption) => void;
  selectedOptionId?: string;
  disabled?: boolean;
  showRecommended?: boolean;
}

export function QuestionCard({
  question,
  options,
  onSelectOption,
  selectedOptionId,
  disabled = false,
  showRecommended = true,
}: QuestionCardProps) {
  return (
    <div className="space-y-3">
      {/* Question text */}
      <div className="flex items-start gap-2">
        <HelpCircle className="h-4 w-4 text-purple-400 mt-0.5 flex-shrink-0" />
        <p className="text-sm leading-relaxed">{question}</p>
      </div>

      {/* Options */}
      <div className="space-y-2 pl-6">
        {options.map((option, index) => {
          const isSelected = selectedOptionId === option.id;
          const isRecommended = showRecommended && option.recommended;

          return (
            <motion.button
              key={option.id}
              initial={{ opacity: 0, x: -10 }}
              animate={{ opacity: 1, x: 0 }}
              transition={{ delay: index * 0.05 }}
              onClick={() => !disabled && onSelectOption(option)}
              disabled={disabled}
              className={cn(
                "w-full text-left p-3 rounded-lg border transition-all",
                "focus:outline-none focus:ring-2 focus:ring-purple-500/50",
                isSelected
                  ? "border-purple-500 bg-purple-500/10"
                  : "border-white/10 hover:border-white/20 hover:bg-white/5",
                disabled && "opacity-50 cursor-not-allowed",
                !disabled && !isSelected && "cursor-pointer"
              )}
            >
              <div className="flex items-start justify-between gap-3">
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <span className={cn(
                      "font-medium text-sm",
                      isSelected && "text-purple-300"
                    )}>
                      {option.label}
                    </span>
                    {isRecommended && !isSelected && (
                      <span className="text-[10px] px-1.5 py-0.5 rounded-full bg-green-500/20 text-green-400">
                        Recommended
                      </span>
                    )}
                  </div>
                  {option.description && (
                    <p className="text-xs text-muted-foreground mt-0.5">
                      {option.description}
                    </p>
                  )}
                </div>

                {isSelected && (
                  <motion.div
                    initial={{ scale: 0 }}
                    animate={{ scale: 1 }}
                    className="flex-shrink-0"
                  >
                    <Check className="h-4 w-4 text-purple-400" />
                  </motion.div>
                )}
              </div>
            </motion.button>
          );
        })}
      </div>
    </div>
  );
}
```
  </action>
  <verify>Run `npx tsc --noEmit` - component should compile without errors</verify>
  <done>QuestionCard component created</done>
</task>

<task type="auto">
  <name>Task 2: Create ConversationPanel component</name>
  <files>src/components/discovery/ConversationPanel.tsx</files>
  <action>
Create the main conversation panel that displays Q&A history:

```typescript
"use client";

import { useEffect, useRef } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { Bot, User, RotateCcw, MessageSquare } from "lucide-react";
import { Button } from "@/components/ui/button";
import { ScrollArea } from "@/components/ui/scroll-area";
import { cn } from "@/lib/utils";
import { useConversationStore, type ConversationMessage } from "@/lib/stores/conversation-store";
import { useDiscoveryStore } from "@/lib/stores/discovery-store";
import { QuestionCard } from "./QuestionCard";
import type { AmbiguityOption, DiscoveryAmbiguity } from "@/lib/discovery/types";
import { detectAmbiguities, getNextAmbiguity } from "@/lib/discovery";

interface ConversationPanelProps {
  onComplete?: () => void;
  className?: string;
}

export function ConversationPanel({ onComplete, className }: ConversationPanelProps) {
  const scrollRef = useRef<HTMLDivElement>(null);

  // Conversation store
  const {
    messages,
    isWaitingForAnswer,
    isComplete,
    currentAmbiguityId,
    startConversation,
    askQuestion,
    answerQuestion,
    reviseAnswer,
    markComplete,
    canRevise,
    getAnswer,
  } = useConversationStore();

  // Discovery store
  const {
    result,
    ambiguities,
    setAmbiguities,
    resolveAmbiguity,
    applyAmbiguityResolutions,
  } = useDiscoveryStore();

  // Initialize conversation when result is available
  useEffect(() => {
    if (result && messages.length === 0) {
      // Detect ambiguities
      const detected = detectAmbiguities(result);
      setAmbiguities(detected);

      if (detected.length > 0) {
        // Start conversation and ask first question
        startConversation();
        const first = getNextAmbiguity(detected);
        if (first) {
          askQuestion(first);
        }
      } else {
        // No ambiguities - mark complete immediately
        startConversation();
        markComplete();
        onComplete?.();
      }
    }
  }, [result, messages.length, setAmbiguities, startConversation, askQuestion, markComplete, onComplete]);

  // Auto-scroll to bottom on new messages
  useEffect(() => {
    if (scrollRef.current) {
      const scrollElement = scrollRef.current.querySelector('[data-radix-scroll-area-viewport]');
      if (scrollElement) {
        scrollElement.scrollTop = scrollElement.scrollHeight;
      }
    }
  }, [messages]);

  // Handle answer selection
  const handleSelectOption = (option: AmbiguityOption) => {
    if (!currentAmbiguityId) return;

    // Record answer in conversation store
    answerQuestion(currentAmbiguityId, option);

    // Resolve ambiguity in discovery store
    resolveAmbiguity(currentAmbiguityId, option.id);

    // Check for next ambiguity
    const next = getNextAmbiguity(
      ambiguities.map(a =>
        a.id === currentAmbiguityId
          ? { ...a, resolved: true, selectedOptionId: option.id }
          : a
      )
    );

    if (next) {
      // Ask next question
      setTimeout(() => askQuestion(next), 300);
    } else {
      // All questions answered - apply resolutions and complete
      applyAmbiguityResolutions();
      markComplete();
      onComplete?.();
    }
  };

  // Handle revision
  const handleRevise = (ambiguityId: string) => {
    reviseAnswer(ambiguityId);
  };

  // Get the ambiguity for a question message
  const getAmbiguityForMessage = (message: ConversationMessage): DiscoveryAmbiguity | null => {
    if (!message.ambiguityId) return null;
    return ambiguities.find(a => a.id === message.ambiguityId) || null;
  };

  // Don't render if no ambiguities and conversation not started
  if (ambiguities.length === 0 && messages.length === 0) {
    return null;
  }

  return (
    <div className={cn(
      "flex flex-col rounded-lg border border-white/10 bg-white/5 overflow-hidden",
      className
    )}>
      {/* Header */}
      <div className="p-3 border-b border-white/10 flex items-center gap-2">
        <div className="w-7 h-7 rounded-lg bg-gradient-to-br from-purple-500/20 to-pink-500/20 flex items-center justify-center">
          <MessageSquare className="w-3.5 h-3.5 text-purple-400" />
        </div>
        <div>
          <h3 className="text-sm font-medium">Repository Analysis</h3>
          <p className="text-[10px] text-muted-foreground">
            {isComplete
              ? "Analysis complete"
              : isWaitingForAnswer
              ? "Please answer the question below"
              : "Analyzing..."}
          </p>
        </div>
      </div>

      {/* Messages */}
      <ScrollArea className="flex-1 max-h-[400px]" ref={scrollRef}>
        <div className="p-4 space-y-4">
          <AnimatePresence mode="popLayout">
            {messages.map((message) => (
              <motion.div
                key={message.id}
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -10 }}
                className={cn(
                  "flex gap-3",
                  message.type === "answer" && "flex-row-reverse"
                )}
              >
                {/* Avatar */}
                {(message.type === "system" || message.type === "question" || message.type === "info") && (
                  <div className="w-7 h-7 rounded-lg bg-gradient-to-br from-teal-500/20 to-purple-500/20 flex items-center justify-center flex-shrink-0">
                    <Bot className="w-3.5 h-3.5 text-teal-400" />
                  </div>
                )}

                {message.type === "answer" && (
                  <div className="w-7 h-7 rounded-lg bg-purple-500/20 flex items-center justify-center flex-shrink-0">
                    <User className="w-3.5 h-3.5 text-purple-400" />
                  </div>
                )}

                {/* Content */}
                <div className={cn(
                  "flex-1",
                  message.type === "answer" && "text-right"
                )}>
                  {/* System/Info messages */}
                  {(message.type === "system" || message.type === "info") && (
                    <div className="p-3 rounded-lg bg-white/5 inline-block max-w-[300px]">
                      <p className="text-sm text-muted-foreground">{message.content}</p>
                    </div>
                  )}

                  {/* Question messages */}
                  {message.type === "question" && message.options && (
                    <div className="p-3 rounded-lg bg-white/5 max-w-[350px]">
                      <QuestionCard
                        question={message.content}
                        options={message.options}
                        onSelectOption={handleSelectOption}
                        selectedOptionId={
                          message.ambiguityId
                            ? getAnswer(message.ambiguityId)?.selectedOptionId
                            : undefined
                        }
                        disabled={
                          message.ambiguityId !== currentAmbiguityId ||
                          !isWaitingForAnswer
                        }
                      />
                    </div>
                  )}

                  {/* Answer messages */}
                  {message.type === "answer" && (
                    <div className="inline-flex flex-col items-end gap-1">
                      <div className="p-3 rounded-lg bg-purple-500/10 inline-block max-w-[250px]">
                        <p className="text-sm">{message.content}</p>
                      </div>
                      {message.canRevise && message.ambiguityId && canRevise(message.ambiguityId) && (
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => handleRevise(message.ambiguityId!)}
                          className="h-6 px-2 text-[10px] text-muted-foreground hover:text-foreground"
                        >
                          <RotateCcw className="h-3 w-3 mr-1" />
                          Revise
                        </Button>
                      )}
                    </div>
                  )}

                  {/* Timestamp */}
                  <p className="text-[10px] text-muted-foreground mt-1">
                    {message.timestamp.toLocaleTimeString([], {
                      hour: "2-digit",
                      minute: "2-digit",
                    })}
                  </p>
                </div>
              </motion.div>
            ))}
          </AnimatePresence>
        </div>
      </ScrollArea>

      {/* Footer showing progress */}
      {ambiguities.length > 0 && (
        <div className="px-4 py-2 border-t border-white/10 text-center">
          <p className="text-[10px] text-muted-foreground">
            {isComplete
              ? `All ${ambiguities.length} question${ambiguities.length === 1 ? "" : "s"} answered`
              : `Question ${ambiguities.filter(a => a.resolved).length + 1} of ${ambiguities.length}`}
          </p>
        </div>
      )}
    </div>
  );
}
```
  </action>
  <verify>Run `npx tsc --noEmit` - component should compile without errors</verify>
  <done>ConversationPanel component created</done>
</task>

<task type="auto">
  <name>Task 3: Export components from barrel file</name>
  <files>src/components/discovery/index.ts</files>
  <action>
Add exports for the new components to the discovery components barrel file:

```typescript
export { QuestionCard } from './QuestionCard';
export { ConversationPanel } from './ConversationPanel';
```

Add these after the existing exports. Do NOT remove any existing exports.
  </action>
  <verify>Run `npx tsc --noEmit` - barrel file should compile without errors</verify>
  <done>Components exported from barrel file</done>
</task>

</tasks>

<verification>
- TypeScript compiles: `npx tsc --noEmit`
- Components import correctly: `import { ConversationPanel, QuestionCard } from '@/components/discovery'`
- QuestionCard renders options with selection state
- ConversationPanel shows message history with Q&A flow
</verification>

<success_criteria>
- QuestionCard displays question with selectable options
- Selected option shows checkmark and highlighted state
- Recommended options have badge
- ConversationPanel shows chat-like message history
- System, question, answer, and info messages render correctly
- Revision button appears on answered questions
- Progress indicator shows current question number
- Auto-scrolls to new messages
- Components exported from barrel file
</success_criteria>

<output>
After completion, create `.planning/phases/04-conversational-discovery-a-submodule-support/04-05-SUMMARY.md`
</output>
