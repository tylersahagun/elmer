---
phase: 01-onboarding-foundation-a-repository-connection
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/onboarding/steps/ConnectGitHubStep.tsx
  - src/components/onboarding/steps/SelectRepoStep.tsx
  - src/app/api/github/permissions/route.ts
  - src/app/api/github/rate-limit/route.ts
  - src/components/onboarding/steps/index.ts

autonomous: true

must_haves:
  truths:
    - "User authenticates with GitHub via OAuth with one click"
    - "User selects repository from searchable list with org/repo filtering"
    - "User selects which branch to scan for workspace structure"
    - "System validates user has sufficient GitHub permissions (repo scope)"
    - "System checks GitHub API rate limits before starting discovery"
    - "System auto-detects sensible defaults (main branch, common folder paths)"
  artifacts:
    - path: "src/components/onboarding/steps/ConnectGitHubStep.tsx"
      provides: "GitHub OAuth connection step"
      exports: ["ConnectGitHubStep"]
    - path: "src/components/onboarding/steps/SelectRepoStep.tsx"
      provides: "Repository and branch selection step"
      exports: ["SelectRepoStep"]
    - path: "src/app/api/github/permissions/route.ts"
      provides: "Endpoint to validate GitHub token scopes"
      exports: ["GET"]
    - path: "src/app/api/github/rate-limit/route.ts"
      provides: "Endpoint to check GitHub API rate limits"
      exports: ["GET"]
  key_links:
    - from: "src/components/onboarding/steps/ConnectGitHubStep.tsx"
      to: "/api/github/status"
      via: "useQuery for connection check"
      pattern: "fetch.*github/status"
    - from: "src/components/onboarding/steps/SelectRepoStep.tsx"
      to: "src/components/settings/GithubRepoSelector.tsx"
      via: "Reuses existing repo selector pattern"
      pattern: "GithubRepoSelector|CommandItem"
    - from: "src/components/onboarding/steps/SelectRepoStep.tsx"
      to: "src/components/settings/BranchSelector.tsx"
      via: "Reuses existing branch selector"
      pattern: "BranchSelector"
---

<objective>
Create the GitHub connection and repository selection onboarding steps, including OAuth authentication, searchable repository list, branch selection, and validation of permissions and rate limits.

Purpose: Enable users to connect their GitHub account (REPO-01), select a repository with filtering (REPO-02), choose a branch (REPO-03), validate permissions (REPO-04), check rate limits (REPO-05), and get sensible defaults (FOUND-04).

Output: Two onboarding step components ready to be wired into the wizard, plus supporting API endpoints.
</objective>

<execution_context>
@/Users/tylersahagun/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylersahagun/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-onboarding-foundation-a-repository-connection/01-CONTEXT.md

# Existing GitHub integration to reuse/extend
@src/components/settings/GithubRepoSelector.tsx
@src/components/settings/BranchSelector.tsx
@src/app/api/github/status/route.ts
@src/app/api/github/repos/route.ts
@src/lib/github/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Permissions and Rate Limit API Endpoints</name>
  <files>
    src/app/api/github/permissions/route.ts
    src/app/api/github/rate-limit/route.ts
  </files>
  <action>
Create two API endpoints for validating GitHub connection before proceeding.

**Permissions endpoint (/api/github/permissions):**
```typescript
// GET - Check if user's GitHub token has required scopes
// Returns: { valid: boolean, scopes: string[], missing: string[], message?: string }
```
- Use getGitHubClient from @/lib/github/auth
- Check OAuth scopes via Octokit (octokit.users.getAuthenticated() includes scopes in response headers)
- Required scopes: 'repo' (for private repos), 'read:user' (for user info)
- If scopes insufficient, return { valid: false, missing: ['repo'], message: "Re-authenticate with additional permissions" }

**Rate limit endpoint (/api/github/rate-limit):**
```typescript
// GET - Check remaining GitHub API rate limit
// Returns: { limit: number, remaining: number, reset: string, sufficient: boolean }
```
- Use octokit.rateLimit.get()
- 'sufficient' is true if remaining > 100 (buffer for discovery operations)
- Include reset timestamp formatted as ISO string
- If not sufficient, return guidance: "Rate limit low. Discovery will resume automatically at {reset time}"

**Follow existing API patterns:**
- Use auth() for session validation
- Return 401 if not authenticated
- Proper error handling with try/catch and logging
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles without errors.
  </verify>
  <done>
Both endpoints exist, validate GitHub connection, and return structured responses. Permissions endpoint checks scopes, rate limit endpoint returns remaining calls with sufficiency flag.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Connect GitHub Step Component</name>
  <files>src/components/onboarding/steps/ConnectGitHubStep.tsx</files>
  <action>
Create the first real step where users connect their GitHub account.

**Component requirements:**
- Check connection status on mount via /api/github/status
- If not connected: Show "Connect GitHub" button that triggers OAuth via signIn('github')
- If connected: Show connected user info (avatar, username) with success state
- After connection: Validate permissions via /api/github/permissions
- If permissions insufficient: Show warning and "Re-authenticate" button
- If permissions valid: Enable "Continue" (handled by parent wrapper's onNext)

**UX from CONTEXT.md:**
- Permission errors trigger re-auth button (OAuth flow with correct scopes)

**Component interface:**
```typescript
interface ConnectGitHubStepProps {
  onComplete: () => void;  // Called when connection validated
}
```

**States to handle:**
1. Loading (checking status)
2. Not connected (show connect button)
3. Connected but insufficient permissions (show re-auth)
4. Connected and valid (show success, enable continue)

**Styling:**
- Center content in step
- Use existing Button, Badge components
- GitHub icon from lucide-react
- Success state: green checkmark badge
  </action>
  <verify>
Verify component imports correctly and TypeScript compiles with `npx tsc --noEmit`.
  </verify>
  <done>
ConnectGitHubStep component checks connection status, shows appropriate UI for each state, validates permissions, and calls onComplete when ready.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Select Repository Step Component</name>
  <files>
    src/components/onboarding/steps/SelectRepoStep.tsx
    src/components/onboarding/steps/index.ts
  </files>
  <action>
Create the repository and branch selection step.

**Component requirements:**
- Display searchable repository list (reuse patterns from GithubRepoSelector)
- Search matches repo name + description + topics (from CONTEXT.md)
- Show "Recently Used" section at top if user has previous workspaces
- Show repo name + description (minimal display from CONTEXT.md)
- After repo selected: Show branch selector (use BranchSelector component)
- Auto-select default branch initially (FOUND-04: sensible defaults)
- Check rate limits via /api/github/rate-limit before allowing continue
- If rate limit low: Show warning but don't block (queue-based from CONTEXT.md)

**UX from CONTEXT.md:**
- Flat list with org prefix format ("acme/frontend", "personal/blog")
- Special sections at top: "Recently Used" and "Favorites" before full list
- Rate limit handling: Queue work and auto-resume when limit resets

**Component interface:**
```typescript
interface SelectRepoStepProps {
  onComplete: (repo: GitHubRepo, branch: string) => void;
}
```

**Layout:**
1. Repository selector (primary)
2. Branch selector (appears after repo selected)
3. Rate limit status indicator (subtle, bottom)

**Barrel file (steps/index.ts):**
Export all step components for clean imports.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles. Check that index.ts exports ConnectGitHubStep and SelectRepoStep.
  </verify>
  <done>
SelectRepoStep allows searching/filtering repos, selecting a repository, choosing a branch with sensible defaults, and validates rate limits. Index barrel exports all step components.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` passes without errors
2. API endpoints exist at specified paths and return expected response shapes
3. `grep -l "signIn" src/components/onboarding/steps/ConnectGitHubStep.tsx` confirms OAuth integration
4. `grep -l "BranchSelector" src/components/onboarding/steps/SelectRepoStep.tsx` confirms branch selector integration
5. Index file exports both step components
</verification>

<success_criteria>
- User can connect GitHub with one-click OAuth
- User sees searchable repository list with org filtering
- User can select branch with default pre-selected
- System validates GitHub permissions and shows re-auth if insufficient
- System checks rate limits and shows status indicator
- Step components follow existing patterns (useQuery, Radix components, Tailwind)
</success_criteria>

<output>
After completion, create `.planning/phases/01-onboarding-foundation-a-repository-connection/01-02-SUMMARY.md`
</output>
