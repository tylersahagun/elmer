---
phase: 01-onboarding-foundation-a-repository-connection
plan: 07
type: execute
wave: 2
depends_on: ["01-04", "01-05"]
files_modified:
  - src/lib/stores/tour-store.ts
  - src/components/onboarding/tour/TourProvider.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "After onboarding completes, tour prompt modal is fully interactive"
    - "Tour prompt appears above any overlay, not behind it"
    - "User can click Start Tour, Maybe Later, or X button without obstruction"
  artifacts:
    - path: "src/lib/stores/tour-store.ts"
      provides: "Mutual exclusivity in showPrompt()"
      contains: "currentStep: null"
    - path: "src/components/onboarding/tour/TourProvider.tsx"
      provides: "Defensive rendering check"
      contains: "!showTourPrompt"
  key_links:
    - from: "showPrompt() action"
      to: "currentStep state"
      via: "set() call resets currentStep to null"
      pattern: "set\\(\\{[^}]*showTourPrompt:\\s*true[^}]*currentStep:\\s*null"
---

<objective>
Fix z-index conflict where TourSpotlight (z-9999) renders on top of TourPromptModal (z-50), blocking all user interaction after onboarding completes.

Purpose: UAT Test 12 reported a blocker - "welcome tour pops up but is behind a black transparent layer that I cannot click through". This blocks all navigation after onboarding.

Output: Tour prompt modal fully interactive after onboarding, with states guaranteed mutually exclusive.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/tour-modal-blocked-by-overlay.md
@.planning/phases/01-onboarding-foundation-a-repository-connection/01-UAT.md

# Tour system files
@src/lib/stores/tour-store.ts
@src/components/onboarding/tour/TourProvider.tsx
@src/components/onboarding/tour/TourSpotlight.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Ensure mutual exclusivity in showPrompt()</name>
  <files>src/lib/stores/tour-store.ts</files>
  <action>
Modify the showPrompt() function (lines 174-180) to reset currentStep when showing the prompt.

Current code:
```typescript
showPrompt: () => {
  const { hasSeenTour, hasDeclinedTour } = get();
  if (!hasSeenTour && !hasDeclinedTour) {
    set({ showTourPrompt: true });
  }
},
```

Change to:
```typescript
showPrompt: () => {
  const { hasSeenTour, hasDeclinedTour } = get();
  if (!hasSeenTour && !hasDeclinedTour) {
    set({
      showTourPrompt: true,
      currentStep: null  // Ensure spotlight doesn't render when prompt is showing
    });
  }
},
```

This ensures that when showPrompt() is called (after onboarding completes), any lingering currentStep value from localStorage is cleared, preventing TourSpotlight from rendering.
  </action>
  <verify>
1. Read the updated tour-store.ts and confirm showPrompt() now sets currentStep: null
2. Run `npm run build` to verify no TypeScript errors
  </verify>
  <done>showPrompt() sets both showTourPrompt: true AND currentStep: null in a single set() call</done>
</task>

<task type="auto">
  <name>Task 2: Add defensive rendering check in TourProvider</name>
  <files>src/components/onboarding/tour/TourProvider.tsx</files>
  <action>
Add a defensive check to prevent TourSpotlight from rendering when the tour prompt modal is showing. This is belt-and-suspenders protection.

Find the tour overlay rendering section (around line 95-114):
```tsx
{/* Tour Overlay (spotlight + step content) */}
<AnimatePresence>
  {isTourActive && (
    <>
      <TourSpotlight />
      ...
    </>
  )}
</AnimatePresence>
```

Change the condition to:
```tsx
{/* Tour Overlay (spotlight + step content) */}
<AnimatePresence>
  {isTourActive && !showTourPrompt && (
    <>
      <TourSpotlight />
      ...
    </>
  )}
</AnimatePresence>
```

This ensures that even if both states somehow become true (edge case), the spotlight will not render while the prompt modal is visible.
  </action>
  <verify>
1. Read the updated TourProvider.tsx and confirm the condition includes `!showTourPrompt`
2. Run `npm run build` to verify no TypeScript errors
3. Run `npm run lint` to verify no linting issues
  </verify>
  <done>TourProvider only renders TourSpotlight when isTourActive AND !showTourPrompt</done>
</task>

<task type="auto">
  <name>Task 3: Verify the fix works end-to-end</name>
  <files></files>
  <action>
Clear localStorage to simulate fresh user and verify the fix:

1. Start the dev server: `npm run dev`
2. Open browser DevTools Console and run: `localStorage.removeItem('elmer-tour')`
3. Navigate to a workspace's onboarding wizard
4. Complete the onboarding flow (connect GitHub, select repo, select branch, complete)
5. Observe tour prompt modal appears
6. Verify: Modal is fully interactive - can click "Start Tour", "Maybe Later", or X button
7. Verify: No black overlay blocking the modal

If starting tour: verify spotlight appears correctly and tour progresses normally.
  </action>
  <verify>
Manual verification in browser:
1. Tour prompt modal appears after onboarding completes
2. Modal is NOT blocked by any overlay
3. All three buttons are clickable: Start Tour, Maybe Later, X
4. If "Start Tour" clicked, tour begins normally with spotlight
5. If "Maybe Later" clicked, modal dismisses and page is fully usable
  </verify>
  <done>User can interact with tour prompt modal without obstruction after onboarding completes</done>
</task>

</tasks>

<verification>
All verification criteria from debug session:
- [ ] showPrompt() resets currentStep to null
- [ ] TourProvider has defensive !showTourPrompt check on spotlight rendering
- [ ] Build passes without errors
- [ ] Tour prompt modal is interactive after onboarding
- [ ] No black overlay blocks the modal
</verification>

<success_criteria>
1. User completes onboarding and sees tour prompt modal
2. Modal is fully interactive (not blocked by overlay)
3. User can click any button (Start Tour, Maybe Later, X) to proceed
4. If tour started, spotlight appears correctly
5. If tour dismissed, all pages are navigable without obstruction
</success_criteria>

<output>
After completion, create `.planning/phases/01-onboarding-foundation-a-repository-connection/01-07-SUMMARY.md`
</output>
