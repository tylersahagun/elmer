---
phase: 01-onboarding-foundation-a-repository-connection
plan: 06
type: execute
wave: 2
depends_on: ["01-01", "01-05"]
files_modified:
  - src/lib/stores/onboarding-store.ts
  - src/components/onboarding/OnboardingWizard.tsx
  - src/components/onboarding/OnboardingProgress.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Wizard page loads showing welcome step with progress bar at 0%"
    - "Progress bar shows valid percentage (0-100) at all steps"
    - "User can navigate through all wizard steps without errors"
  artifacts:
    - path: "src/lib/stores/onboarding-store.ts"
      provides: "Step order without configure step"
      contains: "STEP_ORDER"
    - path: "src/components/onboarding/OnboardingWizard.tsx"
      provides: "Step completion without configure"
    - path: "src/components/onboarding/OnboardingProgress.tsx"
      provides: "Defensive progress calculation"
  key_links:
    - from: "OnboardingWizard.tsx STEP_CONFIGS"
      to: "onboarding-store.ts STEP_ORDER"
      via: "matching step arrays"
      pattern: "welcome.*connect-github.*select-repo.*complete"
---

<objective>
Fix step configuration mismatch causing -33% progress value

Purpose: UAT revealed a blocker where STEP_CONFIGS in the wizard excludes 'configure' but STEP_ORDER in the store includes it. When completeStep('configure') is called, the store advances to 'configure', but OnboardingProgress cannot find it in STEP_CONFIGS, causing findIndex to return -1 and producing an invalid -33% progress value.

Output: Synchronized step configuration across store and wizard components, with defensive progress calculation
</objective>

<execution_context>
@/Users/tylersahagun/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylersahagun/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/01-onboarding-foundation-a-repository-connection/01-UAT.md

# Prior plan summaries (this plan modifies files created by 01 and 05)
@.planning/phases/01-onboarding-foundation-a-repository-connection/01-01-SUMMARY.md
@.planning/phases/01-onboarding-foundation-a-repository-connection/01-05-SUMMARY.md

# Source files with the issue
@src/lib/stores/onboarding-store.ts
@src/components/onboarding/OnboardingWizard.tsx
@src/components/onboarding/OnboardingProgress.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Synchronize step configuration</name>
  <files>
    src/lib/stores/onboarding-store.ts
    src/components/onboarding/OnboardingWizard.tsx
  </files>
  <action>
    1. In src/lib/stores/onboarding-store.ts:
       - Remove 'configure' from the OnboardingStep type union (line 11)
       - Remove 'configure' from STEP_ORDER array (line 21)
       - The type should be: 'welcome' | 'connect-github' | 'select-repo' | 'complete'
       - STEP_ORDER should be: ['welcome', 'connect-github', 'select-repo', 'complete']

    2. In src/components/onboarding/OnboardingWizard.tsx:
       - Remove line 109: completeStep("configure")
       - Remove the entire case "configure" block (lines 217-221) from renderStepContent()
       - The handleRepoSelected callback should only call:
         - setRepo(storeRepo, branch)
         - completeStep("select-repo")
       - Completing "select-repo" will automatically advance to "complete" step

    Why: STEP_CONFIGS in OnboardingWizard has 4 steps (excludes configure), but STEP_ORDER has 5 (includes configure). This mismatch causes the progress calculation to fail when currentStep is 'configure' because findIndex returns -1.
  </action>
  <verify>
    1. Run TypeScript check: `npx tsc --noEmit`
       Should have no errors related to OnboardingStep type

    2. Verify STEP_ORDER has exactly 4 steps:
       `grep -A 5 "STEP_ORDER" src/lib/stores/onboarding-store.ts | grep -c "'"`
       Should return 4 (one per step)

    3. Verify STEP_CONFIGS alignment in wizard:
       `grep -E "id:\s*['\"]" src/components/onboarding/OnboardingWizard.tsx | grep -c "id:"`
       Should return 4 (matching STEP_ORDER count)

    4. Verify no 'configure' references remain:
       `grep -c "configure" src/lib/stores/onboarding-store.ts`
       Should return 0
  </verify>
  <done>
    OnboardingStep type excludes 'configure', STEP_ORDER has 4 steps matching STEP_CONFIGS (both contain: welcome, connect-github, select-repo, complete), no completeStep('configure') call exists
  </done>
</task>

<task type="auto">
  <name>Task 2: Add defensive progress calculation</name>
  <files>src/components/onboarding/OnboardingProgress.tsx</files>
  <action>
    In OnboardingProgress.tsx, add a defensive check for when currentStep is not found in steps:

    1. After line 41 (currentIndex calculation), add:
       ```typescript
       // Defensive: if currentStep not in steps array, default to 0
       const safeCurrentIndex = currentIndex === -1 ? 0 : currentIndex;
       ```

    2. Update line 46-47 to use safeCurrentIndex:
       ```typescript
       const percentage = totalSteps > 1
         ? Math.round((safeCurrentIndex / (totalSteps - 1)) * 100)
         : 0;
       ```

    3. Also update the style calculation on line 65 to ensure percentage is clamped:
       ```typescript
       style={{
         left: `${Math.max(0, Math.min(percentage, 95))}%`,
         transform: 'translateX(-50%)'
       }}
       ```

    Why: Even with synchronized configs, this defensive check prevents negative percentages if:
    - sessionStorage has stale step value from older version
    - Future code changes accidentally create mismatches
    - Edge cases during hydration
  </action>
  <verify>
    1. Run TypeScript check: `npx tsc --noEmit`
    2. Run tests: `npm test -- --grep Progress` (if tests exist)
  </verify>
  <done>
    OnboardingProgress handles findIndex returning -1 gracefully, always produces percentage in 0-100 range
  </done>
</task>

<task type="auto">
  <name>Task 3: Clear stale sessionStorage and verify fix</name>
  <files>None (verification only)</files>
  <action>
    1. Start the dev server if not running: `npm run dev`

    2. Open browser console and clear the stale onboarding state:
       ```javascript
       sessionStorage.removeItem('elmer-onboarding')
       ```

    3. Navigate to an onboarding page: /workspace/[id]/onboarding

    4. Verify:
       - Page loads without blank screen
       - Progress bar shows 0% on welcome step
       - No console errors about invalid Progress value
       - Complete full wizard flow to verify each step works

    Why: Existing users may have 'configure' step stored in sessionStorage. While the defensive check handles this, clearing during testing ensures we see the intended behavior.
  </action>
  <verify>
    Manual verification in browser:
    - No "-33" or negative percentage errors in console
    - Progress bar displays correctly (0%, 33%, 66%, 100% through steps)
    - Wizard navigation works through all steps
  </verify>
  <done>
    Wizard renders correctly, progress shows valid percentages, user can complete full onboarding flow
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. No console errors when loading onboarding page
3. Progress value is always 0-100 (never negative)
4. Wizard flow works: welcome -> connect-github -> select-repo -> complete
5. STEP_ORDER in store matches STEP_CONFIGS in wizard (both have 4 steps):
   - `grep -c "'" src/lib/stores/onboarding-store.ts | grep STEP_ORDER` shows 4 steps
   - `grep -E "id:\s*['\"]" src/components/onboarding/OnboardingWizard.tsx | wc -l` shows 4 steps
</verification>

<success_criteria>
- [ ] OnboardingStep type has 4 values (no 'configure')
- [ ] STEP_ORDER array has 4 elements matching STEP_CONFIGS
- [ ] No completeStep('configure') call in wizard
- [ ] OnboardingProgress has defensive check for invalid step
- [ ] Manual test confirms wizard loads and works correctly
- [ ] No hydration mismatch errors
- [ ] Progress bar shows valid percentages (0-100)
</success_criteria>

<output>
After completion, create `.planning/phases/01-onboarding-foundation-a-repository-connection/01-06-SUMMARY.md`
</output>
