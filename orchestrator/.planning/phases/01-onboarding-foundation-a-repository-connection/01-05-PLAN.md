---
phase: 01-onboarding-foundation-a-repository-connection
plan: 05
type: execute
wave: 2
depends_on: ["01-01", "01-02", "01-04"]
files_modified:
  - src/app/(dashboard)/workspace/[id]/onboarding/page.tsx
  - src/components/onboarding/OnboardingWizard.tsx
  - src/app/api/workspaces/[id]/onboarding/route.ts
  - src/lib/db/schema.ts
  - src/app/layout.tsx  # TourProvider wrapping

# autonomous: false because Task 4 is a checkpoint:human-verify requiring user to test the end-to-end flow
autonomous: false

must_haves:
  truths:
    - "User navigates to onboarding page and sees full wizard flow"
    - "Wizard displays progress indicator and step content"
    - "User can complete Connect GitHub -> Select Repository flow end-to-end"
    - "Workspace is updated with selected repository and branch on completion"
    - "Session state persists across page refreshes during onboarding"
  artifacts:
    - path: "src/app/(dashboard)/workspace/[id]/onboarding/page.tsx"
      provides: "Onboarding page route within workspace"
      exports: ["default"]
    - path: "src/components/onboarding/OnboardingWizard.tsx"
      provides: "Main wizard container orchestrating all steps"
      exports: ["OnboardingWizard"]
    - path: "src/app/api/workspaces/[id]/onboarding/route.ts"
      provides: "API endpoint to finalize onboarding and update workspace"
      exports: ["POST"]
  key_links:
    - from: "src/components/onboarding/OnboardingWizard.tsx"
      to: "src/lib/stores/onboarding-store.ts"
      via: "useOnboardingStore for step management"
      pattern: "useOnboardingStore\\(\\)"
    - from: "src/components/onboarding/OnboardingWizard.tsx"
      to: "src/components/onboarding/steps/*"
      via: "renders step components based on current step"
      pattern: "ConnectGitHubStep|SelectRepoStep"
    - from: "src/app/api/workspaces/[id]/onboarding/route.ts"
      to: "src/lib/db/queries.ts"
      via: "updates workspace with onboarding data"
      pattern: "updateWorkspace|db\\.update"
    - from: "src/components/onboarding/OnboardingWizard.tsx"
      to: "src/lib/stores/tour-store.ts"
      via: "triggers tour prompt on completion"
      pattern: "useTourStore\\(\\).*showPrompt"
---

<objective>
Wire together the wizard foundation (Plan 01) and step components (Plan 02) into a complete onboarding flow, create the onboarding page route, and add the API endpoint to finalize onboarding.

Purpose: Create a functional end-to-end onboarding experience where users can connect GitHub, select a repository, and have their workspace updated. This validates that all foundation components work together.

Output: Working onboarding wizard accessible at /workspace/[id]/onboarding with complete flow from start to finish.
</objective>

<execution_context>
@/Users/tylersahagun/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylersahagun/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-onboarding-foundation-a-repository-connection/01-CONTEXT.md

# From Plan 01 - wizard foundation
@src/lib/stores/onboarding-store.ts
@src/components/onboarding/OnboardingProgress.tsx
@src/components/onboarding/OnboardingStepWrapper.tsx
@src/components/onboarding/OnboardingErrorBoundary.tsx

# From Plan 02 - step components
@src/components/onboarding/steps/ConnectGitHubStep.tsx
@src/components/onboarding/steps/SelectRepoStep.tsx

# From Plan 04 - tour system
@src/lib/stores/tour-store.ts
@src/components/onboarding/tour/TourProvider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Onboarding Fields to Database Schema</name>
  <files>src/lib/db/schema.ts</files>
  <action>
Add onboarding-related fields to the workspaces table schema.

**Fields to add to workspaces table:**
```typescript
// In workspaces table definition, add:
onboardingCompletedAt: timestamp("onboarding_completed_at"),
onboardingData: jsonb("onboarding_data"),  // Stores import summary
```

**onboardingData structure (for reference, stored as JSONB):**
```typescript
interface OnboardingData {
  completedAt: string;
  importedProjects: number;
  importedPersonas: number;
  importedKnowledge: number;
  selectedBranch: string;
  // Will be expanded in Phase 2 with discovery data
}
```

**Important:**
- These fields are nullable (existing workspaces won't have them)
- Do NOT run migrations yet - just update schema.ts
- Export any new types if needed

**Migration (execute after schema changes):**
```bash
npx drizzle-kit generate  # Creates migration file
npx drizzle-kit migrate   # Applies migration to database
```
  </action>
  <verify>
1. Run `npx tsc --noEmit` to verify schema compiles without TypeScript errors.
2. Run `npx drizzle-kit generate` to create migration file.
3. Run `npx drizzle-kit migrate` to apply migration.
4. Verify migration applied: `psql $DATABASE_URL -c "SELECT column_name FROM information_schema.columns WHERE table_name='workspaces' AND column_name IN ('onboarding_completed_at', 'onboarding_data');"` should return both columns.
  </verify>
  <done>
Workspaces schema includes onboardingCompletedAt and onboardingData fields. Migration generated and applied. Columns verified in database.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Onboarding API Endpoint</name>
  <files>src/app/api/workspaces/[id]/onboarding/route.ts</files>
  <action>
Create API endpoint to finalize onboarding and update workspace with repository/branch selection.

**POST /api/workspaces/[id]/onboarding:**
```typescript
// Request body:
{
  repo: string;        // Full repo path (owner/name)
  branch: string;      // Selected branch
  repoDetails?: {      // Optional full repo details
    id: number;
    fullName: string;
    defaultBranch: string;
    // ... other fields from GitHubRepo type
  }
}

// Response:
{
  success: boolean;
  workspace: Workspace;  // Updated workspace
  message?: string;
}
```

**Implementation:**
1. Validate session and workspace access (requireWorkspaceAccess)
2. Validate request body (repo and branch required)
3. Update workspace with:
   - githubRepo: repo path
   - defaultBranch: branch (add field if not exists, or use existing contextBranch)
   - onboardingCompletedAt: new Date()
   - onboardingData: { completedAt: ISO string, selectedBranch: branch, ... }
4. Return updated workspace

**Error handling:**
- 401 if not authenticated
- 403 if not workspace member
- 400 if missing required fields
- 500 for database errors with logging

**Follow existing API patterns from:**
@src/app/api/workspaces/[id]/route.ts
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles.
  </verify>
  <done>
POST endpoint validates input, updates workspace with repo/branch/onboarding status, and returns updated workspace.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Onboarding Wizard Container and Page</name>
  <files>
    src/components/onboarding/OnboardingWizard.tsx
    src/app/(dashboard)/workspace/[id]/onboarding/page.tsx
  </files>
  <action>
Create the main wizard container that orchestrates steps and the page route that renders it.

**OnboardingWizard component:**
- Uses useOnboardingStore for current step and navigation
- Renders OnboardingProgress at top
- Wraps content in OnboardingErrorBoundary
- Maps currentStep to appropriate step component:
  - 'welcome': Welcome content (simple, can be inline)
  - 'connect-github': <ConnectGitHubStep />
  - 'select-repo': <SelectRepoStep />
  - 'complete': Completion screen with "Go to Workspace" button
- Each step wrapped in OnboardingStepWrapper with appropriate props
- On final step completion: Call POST /api/workspaces/[id]/onboarding

**Welcome step content (inline):**
- "Let's set up your workspace"
- Brief explanation of what onboarding does
- "Connect your GitHub repository to import existing projects"
- Continue button

**Complete step content (inline):**
- "You're all set!"
- Summary of what was configured (repo, branch)
- "Your workspace is ready. In the next step, we'll discover your existing work." (Phase 2 teaser)
- "Go to Workspace" button -> navigates to /workspace/[id]

**Tour integration (REQUIRED - from Plan 04):**
When rendering the complete step:
```typescript
import { useTourStore } from '@/lib/stores/tour-store';

// In complete step render or useEffect when step === 'complete':
const { showPrompt, hasSeenTour, hasDeclinedTour } = useTourStore();

// Trigger tour prompt if user hasn't seen or declined tour
useEffect(() => {
  if (currentStep === 'complete' && !hasSeenTour && !hasDeclinedTour) {
    showPrompt();
  }
}, [currentStep, hasSeenTour, hasDeclinedTour, showPrompt]);
```
This triggers the TourProvider's prompt modal (built in Plan 04) asking "Take a Tour?"

**Props:**
```typescript
interface OnboardingWizardProps {
  workspaceId: string;
  workspaceName: string;
}
```

**Onboarding page (page.tsx):**
- Fetch workspace data
- If workspace.onboardingCompletedAt exists, redirect to /workspace/[id]
- Otherwise render <OnboardingWizard workspaceId={id} workspaceName={workspace.name} />
- Full-page layout (no sidebar) for focused experience

**TourProvider integration:**
Ensure TourProvider from Plan 04 wraps the app (in layout.tsx or _app.tsx) so tour prompt modal can render when showPrompt() is called.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles. Verify page route is accessible.
Verify tour integration: `grep -l "useTourStore" src/components/onboarding/OnboardingWizard.tsx` confirms import.
Verify TourProvider wrapped: `grep -l "TourProvider" src/app/layout.tsx` confirms app-level wrapping.
  </verify>
  <done>
OnboardingWizard orchestrates step flow with progress and error handling. Onboarding page renders wizard and redirects if already completed. Tour prompt triggers on completion step via useTourStore().showPrompt(). TourProvider wraps app for modal rendering.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete onboarding wizard flow with:
- Session-persisted state
- Progress indicator
- GitHub connection step
- Repository selection step
- API endpoint to save configuration
- Database schema updates for onboarding tracking
- Tour prompt integration on completion
  </what-built>
  <how-to-verify>
1. Navigate to http://localhost:3000/workspace/[workspace-id]/onboarding
2. Verify progress indicator shows "Step 1 of 4: Welcome"
3. Click Continue to advance to GitHub connection step
4. Connect GitHub (if not connected) or verify connected state shows
5. Advance to repository selection step
6. Select a repository and branch
7. Complete onboarding and verify:
   a. POST to /api/workspaces/[id]/onboarding succeeds (check network tab)
   b. Tour prompt modal appears asking "Take a Tour?"
   c. Clicking "Maybe Later" or "X" dismisses prompt and redirects to workspace
8. Refresh page mid-flow to verify state persists
9. Database check: Verify onboarding_completed_at and onboarding_data columns exist
  </how-to-verify>
  <rollback-guidance>
If verification fails:
- **Schema issues:** Columns missing = re-run `npx drizzle-kit migrate`. If migration fails, check drizzle/meta for conflicts.
- **API errors:** Check server logs, verify schema fields match API expectations.
- **Tour prompt not appearing:** Verify TourProvider wraps app in layout.tsx. Check console for useTourStore errors.
- **State not persisting:** Check sessionStorage for onboarding keys, verify store persist middleware config.
  </rollback-guidance>
  <resume-signal>Type "approved" if flow works end-to-end including tour prompt, or describe issues encountered</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` passes without errors
2. Database schema includes onboarding fields (migration applied)
3. API endpoint exists and handles POST requests
4. Wizard page is accessible at /workspace/[id]/onboarding
5. Tour integration wired: `grep "useTourStore" src/components/onboarding/OnboardingWizard.tsx` returns match
6. TourProvider wrapping: `grep "TourProvider" src/app/layout.tsx` returns match
7. Human verification confirms end-to-end flow works including tour prompt
</verification>

<success_criteria>
- User can navigate through complete onboarding wizard (welcome -> connect -> select repo -> complete)
- Progress indicator updates at each step
- State persists across page refreshes
- Workspace is updated with repository selection on completion
- Already-onboarded workspaces redirect away from onboarding page
- Error boundary catches and displays errors with retry option
- Tour prompt appears after completing onboarding (TOUR-01 requirement)
- TourProvider wraps app to enable tour prompt modal rendering
</success_criteria>

<output>
After completion, create `.planning/phases/01-onboarding-foundation-a-repository-connection/01-05-SUMMARY.md`
</output>
