---
phase: 02-structure-discovery-a-workspace-population
plan: 05
type: execute
wave: 3
depends_on: ["02-03", "02-04"]
files_modified:
  - src/components/discovery/SelectionControls.tsx
  - src/components/discovery/FilterBar.tsx
  - src/lib/stores/discovery-store.ts
autonomous: true

must_haves:
  truths:
    - "User can select/deselect individual initiatives via checkboxes"
    - "User can bulk select/deselect with Select All / Deselect All"
    - "User can filter discovered items by status and archived state"
    - "Default behavior is all items selected"
  artifacts:
    - path: "src/components/discovery/SelectionControls.tsx"
      provides: "Bulk selection toggle buttons"
      exports: ["SelectionControls"]
    - path: "src/components/discovery/FilterBar.tsx"
      provides: "Filter controls for status and archived"
      exports: ["FilterBar"]
    - path: "src/lib/stores/discovery-store.ts"
      provides: "Zustand store for discovery selection state"
      exports: ["useDiscoveryStore"]
  key_links:
    - from: "src/components/discovery/SelectionControls.tsx"
      to: "src/lib/stores/discovery-store.ts"
      via: "Uses store for selection state"
      pattern: "useDiscoveryStore"
---

<objective>
Create selection and filtering controls for the discovery preview.

Purpose: Enable users to select which initiatives to import, with bulk operations and filtering capabilities for complex repositories.

Output: Selection controls, filter bar, and Zustand store for managing selection state.
</objective>

<execution_context>
@/Users/tylersahagun/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylersahagun/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-structure-discovery-a-workspace-population/02-CONTEXT.md

# Store pattern from Phase 1
@src/lib/stores/onboarding-store.ts (Zustand store pattern)

# Types to use
@src/lib/discovery/types.ts

# Prior plan outputs
@.planning/phases/02-structure-discovery-a-workspace-population/02-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create discovery selection store</name>
  <files>src/lib/stores/discovery-store.ts</files>
  <action>
Create Zustand store for managing discovery selection and filter state.

Implementation:

```typescript
import { create } from 'zustand';
import type { DiscoveryResult, DiscoveredInitiative, ImportSelection } from '@/lib/discovery/types';

interface FilterState {
  showArchived: boolean;
  columnFilter: string | null;  // null = all columns
  sourceFilter: string | null;  // null = all source folders
}

interface DiscoveryState {
  // Discovery result
  result: DiscoveryResult | null;
  isLoading: boolean;
  error: string | null;

  // Selection state
  selectedInitiatives: Set<string>;
  selectedContextPaths: Set<string>;
  selectedAgents: Set<string>;

  // Filter state
  filters: FilterState;

  // Actions
  setResult: (result: DiscoveryResult) => void;
  setLoading: (loading: boolean) => void;
  setError: (error: string | null) => void;

  // Selection actions
  toggleInitiative: (id: string) => void;
  selectAllInitiatives: () => void;
  deselectAllInitiatives: () => void;
  toggleContextPath: (path: string) => void;
  toggleAgent: (path: string) => void;

  // Filter actions
  setColumnFilter: (column: string | null) => void;
  setSourceFilter: (source: string | null) => void;
  toggleShowArchived: () => void;

  // Getters
  getFilteredInitiatives: () => DiscoveredInitiative[];
  getImportSelection: () => ImportSelection;

  // Reset
  reset: () => void;
}

const initialFilters: FilterState = {
  showArchived: true,
  columnFilter: null,
  sourceFilter: null,
};

export const useDiscoveryStore = create<DiscoveryState>((set, get) => ({
  result: null,
  isLoading: false,
  error: null,
  selectedInitiatives: new Set(),
  selectedContextPaths: new Set(),
  selectedAgents: new Set(),
  filters: initialFilters,

  setResult: (result) => {
    // Per CONTEXT.md: "Default selection state: All items selected by default"
    const allInitiativeIds = new Set(result.initiatives.map(i => i.id));
    const allContextPaths = new Set(result.contextPaths.map(cp => cp.path));
    const allAgents = new Set(result.agents.map(a => a.path));

    set({
      result,
      selectedInitiatives: allInitiativeIds,
      selectedContextPaths: allContextPaths,
      selectedAgents: allAgents,
      error: null,
    });
  },

  setLoading: (isLoading) => set({ isLoading }),

  setError: (error) => set({ error, isLoading: false }),

  toggleInitiative: (id) => {
    set((state) => {
      const newSet = new Set(state.selectedInitiatives);
      if (newSet.has(id)) {
        newSet.delete(id);
      } else {
        newSet.add(id);
      }
      return { selectedInitiatives: newSet };
    });
  },

  selectAllInitiatives: () => {
    const { result, filters } = get();
    if (!result) return;

    // Select all filtered initiatives
    const filtered = get().getFilteredInitiatives();
    const ids = new Set(filtered.map(i => i.id));

    set((state) => ({
      selectedInitiatives: new Set([...state.selectedInitiatives, ...ids])
    }));
  },

  deselectAllInitiatives: () => {
    const { result, filters } = get();
    if (!result) return;

    // Deselect all filtered initiatives
    const filtered = get().getFilteredInitiatives();
    const idsToRemove = new Set(filtered.map(i => i.id));

    set((state) => {
      const newSet = new Set(state.selectedInitiatives);
      idsToRemove.forEach(id => newSet.delete(id));
      return { selectedInitiatives: newSet };
    });
  },

  toggleContextPath: (path) => {
    set((state) => {
      const newSet = new Set(state.selectedContextPaths);
      if (newSet.has(path)) {
        newSet.delete(path);
      } else {
        newSet.add(path);
      }
      return { selectedContextPaths: newSet };
    });
  },

  toggleAgent: (path) => {
    set((state) => {
      const newSet = new Set(state.selectedAgents);
      if (newSet.has(path)) {
        newSet.delete(path);
      } else {
        newSet.add(path);
      }
      return { selectedAgents: newSet };
    });
  },

  setColumnFilter: (columnFilter) => {
    set((state) => ({
      filters: { ...state.filters, columnFilter }
    }));
  },

  setSourceFilter: (sourceFilter) => {
    set((state) => ({
      filters: { ...state.filters, sourceFilter }
    }));
  },

  toggleShowArchived: () => {
    set((state) => ({
      filters: { ...state.filters, showArchived: !state.filters.showArchived }
    }));
  },

  getFilteredInitiatives: () => {
    const { result, filters } = get();
    if (!result) return [];

    return result.initiatives.filter((initiative) => {
      // Archived filter
      if (!filters.showArchived && initiative.archived) {
        return false;
      }

      // Column filter
      if (filters.columnFilter && initiative.mappedColumn !== filters.columnFilter) {
        return false;
      }

      // Source folder filter
      if (filters.sourceFilter && initiative.sourceFolder !== filters.sourceFilter) {
        return false;
      }

      return true;
    });
  },

  getImportSelection: () => {
    const { selectedInitiatives, selectedContextPaths, selectedAgents } = get();
    return {
      initiatives: Array.from(selectedInitiatives),
      contextPaths: Array.from(selectedContextPaths),
      agents: Array.from(selectedAgents),
      createDynamicColumns: true,
    };
  },

  reset: () => {
    set({
      result: null,
      isLoading: false,
      error: null,
      selectedInitiatives: new Set(),
      selectedContextPaths: new Set(),
      selectedAgents: new Set(),
      filters: initialFilters,
    });
  },
}));
```
  </action>
  <verify>
Create src/lib/stores/__tests__/discovery-store.test.ts with:
- Test setResult selects all items by default
- Test toggleInitiative toggles selection
- Test selectAll/deselectAll work with filters
- Test getFilteredInitiatives applies filters
Run: npm test -- src/lib/stores/__tests__/discovery-store.test.ts
  </verify>
  <done>Discovery store manages selection and filter state with all-selected default</done>
</task>

<task type="auto">
  <name>Task 2: Create SelectionControls component</name>
  <files>src/components/discovery/SelectionControls.tsx</files>
  <action>
Create bulk selection toggle buttons.

Implementation:

```typescript
"use client";

import { CheckSquare, Square, SquareMinus } from "lucide-react";
import { useDiscoveryStore } from "@/lib/stores/discovery-store";

export function SelectionControls() {
  const {
    result,
    selectedInitiatives,
    selectAllInitiatives,
    deselectAllInitiatives,
    getFilteredInitiatives
  } = useDiscoveryStore();

  if (!result) return null;

  const filtered = getFilteredInitiatives();
  const filteredIds = new Set(filtered.map(i => i.id));
  const selectedInFilter = Array.from(selectedInitiatives).filter(id => filteredIds.has(id));

  const allSelected = selectedInFilter.length === filtered.length && filtered.length > 0;
  const someSelected = selectedInFilter.length > 0 && selectedInFilter.length < filtered.length;
  const noneSelected = selectedInFilter.length === 0;

  return (
    <div className="flex items-center gap-4">
      {/* Selection count */}
      <span className="text-sm text-muted-foreground">
        {selectedInFilter.length} of {filtered.length} selected
      </span>

      {/* Toggle buttons - per CONTEXT.md: "Simple toggle buttons" */}
      <div className="flex items-center gap-2">
        <button
          onClick={selectAllInitiatives}
          disabled={allSelected}
          className={`
            flex items-center gap-1.5 px-3 py-1.5 text-sm rounded-md
            border transition-colors
            ${allSelected
              ? 'bg-muted text-muted-foreground cursor-not-allowed'
              : 'hover:bg-accent hover:text-accent-foreground'
            }
          `}
        >
          <CheckSquare className="h-4 w-4" />
          Select All
        </button>

        <button
          onClick={deselectAllInitiatives}
          disabled={noneSelected}
          className={`
            flex items-center gap-1.5 px-3 py-1.5 text-sm rounded-md
            border transition-colors
            ${noneSelected
              ? 'bg-muted text-muted-foreground cursor-not-allowed'
              : 'hover:bg-accent hover:text-accent-foreground'
            }
          `}
        >
          <Square className="h-4 w-4" />
          Deselect All
        </button>
      </div>
    </div>
  );
}
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>SelectionControls provides Select All / Deselect All buttons with count display</done>
</task>

<task type="auto">
  <name>Task 3: Create FilterBar component</name>
  <files>src/components/discovery/FilterBar.tsx</files>
  <action>
Create filter controls for status/column and archived toggle.

Implementation:

```typescript
"use client";

import { useMemo } from "react";
import { Filter, Archive, Columns } from "lucide-react";
import { useDiscoveryStore } from "@/lib/stores/discovery-store";

export function FilterBar() {
  const {
    result,
    filters,
    setColumnFilter,
    setSourceFilter,
    toggleShowArchived
  } = useDiscoveryStore();

  // Get unique columns and source folders from result
  const { columns, sourceFolders, archivedCount } = useMemo(() => {
    if (!result) return { columns: [], sourceFolders: [], archivedCount: 0 };

    const columnSet = new Set<string>();
    const sourceSet = new Set<string>();
    let archived = 0;

    result.initiatives.forEach((initiative) => {
      columnSet.add(initiative.mappedColumn);
      sourceSet.add(initiative.sourceFolder);
      if (initiative.archived) archived++;
    });

    return {
      columns: Array.from(columnSet).sort(),
      sourceFolders: Array.from(sourceSet).sort(),
      archivedCount: archived
    };
  }, [result]);

  if (!result) return null;

  return (
    <div className="flex flex-wrap items-center gap-4 p-3 rounded-lg bg-muted/30 border">
      <div className="flex items-center gap-2 text-sm text-muted-foreground">
        <Filter className="h-4 w-4" />
        <span>Filters:</span>
      </div>

      {/* Column filter */}
      <div className="flex items-center gap-2">
        <Columns className="h-4 w-4 text-muted-foreground" />
        <select
          value={filters.columnFilter || ''}
          onChange={(e) => setColumnFilter(e.target.value || null)}
          className="text-sm px-2 py-1 rounded border bg-background"
        >
          <option value="">All columns</option>
          {columns.map((column) => (
            <option key={column} value={column}>
              {column.charAt(0).toUpperCase() + column.slice(1)}
            </option>
          ))}
        </select>
      </div>

      {/* Source folder filter */}
      {sourceFolders.length > 1 && (
        <div className="flex items-center gap-2">
          <span className="text-sm text-muted-foreground">Source:</span>
          <select
            value={filters.sourceFilter || ''}
            onChange={(e) => setSourceFilter(e.target.value || null)}
            className="text-sm px-2 py-1 rounded border bg-background"
          >
            <option value="">All folders</option>
            {sourceFolders.map((folder) => (
              <option key={folder} value={folder}>
                {folder}
              </option>
            ))}
          </select>
        </div>
      )}

      {/* Archived toggle */}
      {archivedCount > 0 && (
        <button
          onClick={toggleShowArchived}
          className={`
            flex items-center gap-1.5 px-2 py-1 text-sm rounded
            transition-colors
            ${filters.showArchived
              ? 'bg-muted text-foreground'
              : 'bg-transparent text-muted-foreground hover:text-foreground'
            }
          `}
        >
          <Archive className="h-4 w-4" />
          {filters.showArchived ? 'Hide' : 'Show'} archived ({archivedCount})
        </button>
      )}
    </div>
  );
}
```

Update barrel file src/components/discovery/index.ts to include new exports:
```typescript
export { DiscoveryPreview } from './DiscoveryPreview';
export { InitiativeItem } from './InitiativeItem';
export { ColumnGroup } from './ColumnGroup';
export { SelectionControls } from './SelectionControls';
export { FilterBar } from './FilterBar';
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Barrel file updated with new exports
  </verify>
  <done>FilterBar provides column, source folder, and archived filters</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. TypeScript compiles: `npx tsc --noEmit`
2. Store test passes: `npm test -- src/lib/stores/__tests__/discovery-store.test.ts`
3. All components export from barrel file
</verification>

<success_criteria>
- Checkboxes allow individual initiative selection (IMPRT-01)
- Select All / Deselect All buttons work (IMPRT-02)
- Filter by column, source folder, and archived state (IMPRT-03)
- All items selected by default (IMPRT-04)
- Store correctly manages selection across filters
</success_criteria>

<output>
After completion, create `.planning/phases/02-structure-discovery-a-workspace-population/02-05-SUMMARY.md`
</output>
