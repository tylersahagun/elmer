---
phase: 02-structure-discovery-a-workspace-population
plan: 08
type: execute
wave: 4
depends_on: ["02-04", "02-05", "02-06", "02-07"]
files_modified:
  - src/components/onboarding/steps/DiscoveryStep.tsx
  - src/components/onboarding/OnboardingWizard.tsx
  - src/lib/stores/onboarding-store.ts
autonomous: true

must_haves:
  truths:
    - "Discovery step appears in wizard after branch selection"
    - "User sees discovery preview with selection controls in wizard"
    - "User can confirm import or skip within wizard flow"
    - "Wizard completes after successful import"
  artifacts:
    - path: "src/components/onboarding/steps/DiscoveryStep.tsx"
      provides: "Discovery wizard step component"
      exports: ["DiscoveryStep"]
    - path: "src/components/onboarding/OnboardingWizard.tsx"
      provides: "Updated wizard with discovery step"
    - path: "src/lib/stores/onboarding-store.ts"
      provides: "Updated store with discovery step"
  key_links:
    - from: "src/components/onboarding/steps/DiscoveryStep.tsx"
      to: "src/lib/stores/discovery-store.ts"
      via: "Uses discovery store for state"
      pattern: "useDiscoveryStore"
    - from: "src/components/onboarding/steps/DiscoveryStep.tsx"
      to: "src/app/api/discovery/route.ts"
      via: "Fetches discovery results"
      pattern: "fetch.*api/discovery"
---

<objective>
Integrate the discovery flow into the onboarding wizard.

Purpose: Connect the discovery UI components to the wizard infrastructure from Phase 1, creating a seamless flow from repository selection to workspace population.

Output: DiscoveryStep component wired into OnboardingWizard with proper state management.
</objective>

<execution_context>
@/Users/tylersahagun/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylersahagun/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-structure-discovery-a-workspace-population/02-CONTEXT.md

# Wizard infrastructure from Phase 1
@src/lib/stores/onboarding-store.ts
@src/components/onboarding/OnboardingWizard.tsx
@src/components/onboarding/OnboardingStepWrapper.tsx

# Discovery components and store
@src/components/discovery/index.ts
@src/lib/stores/discovery-store.ts

# Prior plan outputs
@.planning/phases/02-structure-discovery-a-workspace-population/02-07-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update onboarding store with discovery step</name>
  <files>src/lib/stores/onboarding-store.ts</files>
  <action>
Add 'discover' step to the onboarding wizard flow.

Update the OnboardingStep type and STEP_ORDER:

```typescript
export type OnboardingStep =
  | 'welcome'
  | 'connect-github'
  | 'select-repo'
  | 'discover'      // NEW: Discovery and import step
  | 'complete';

const STEP_ORDER: OnboardingStep[] = [
  'welcome',
  'connect-github',
  'select-repo',
  'discover',       // NEW: After repo selection, before complete
  'complete',
];
```

The rest of the store logic remains unchanged - it already handles dynamic step navigation.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
STEP_ORDER includes 'discover' between 'select-repo' and 'complete'
  </verify>
  <done>Onboarding store updated with discovery step in wizard flow</done>
</task>

<task type="auto">
  <name>Task 2: Create DiscoveryStep component</name>
  <files>src/components/onboarding/steps/DiscoveryStep.tsx</files>
  <action>
Create the discovery wizard step that integrates all discovery UI components.

Implementation:

```typescript
"use client";

import { useEffect, useState } from "react";
import { useParams } from "next/navigation";
import { Loader2, AlertCircle, RefreshCw } from "lucide-react";
import {
  DiscoveryPreview,
  SelectionControls,
  FilterBar,
  ValidationSummary,
} from "@/components/discovery";
import { useDiscoveryStore } from "@/lib/stores/discovery-store";
import { useOnboardingStore } from "@/lib/stores/onboarding-store";

interface DiscoveryStepProps {
  onComplete: () => void;
  onSkip: () => void;
}

export function DiscoveryStep({ onComplete, onSkip }: DiscoveryStepProps) {
  const params = useParams();
  const workspaceId = params.id as string;

  const { selectedRepo, selectedBranch } = useOnboardingStore();
  const {
    result,
    isLoading,
    error,
    setResult,
    setLoading,
    setError,
    selectedInitiatives,
    toggleInitiative,
    getImportSelection,
    reset: resetDiscovery,
  } = useDiscoveryStore();

  const [isImporting, setIsImporting] = useState(false);
  const [importError, setImportError] = useState<string | null>(null);

  // Fetch discovery results on mount
  useEffect(() => {
    async function runDiscovery() {
      if (!workspaceId) return;

      setLoading(true);
      setError(null);

      try {
        const response = await fetch(
          `/api/discovery?workspaceId=${encodeURIComponent(workspaceId)}`
        );

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || "Discovery failed");
        }

        const discoveryResult = await response.json();
        setResult(discoveryResult);
      } catch (err) {
        setError(err instanceof Error ? err.message : "Discovery failed");
      }
    }

    runDiscovery();

    // Cleanup on unmount
    return () => {
      resetDiscovery();
    };
  }, [workspaceId, setLoading, setError, setResult, resetDiscovery]);

  // Handle import confirmation
  const handleImport = async () => {
    if (!result || selectedInitiatives.size === 0) return;

    setIsImporting(true);
    setImportError(null);

    try {
      const selection = getImportSelection();

      const response = await fetch("/api/discovery/import", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          workspaceId,
          result,
          selection,
        }),
      });

      const importResult = await response.json();

      if (!response.ok || !importResult.success) {
        throw new Error(importResult.errors?.[0] || "Import failed");
      }

      // Success - proceed to completion
      onComplete();
    } catch (err) {
      setImportError(err instanceof Error ? err.message : "Import failed");
    } finally {
      setIsImporting(false);
    }
  };

  // Handle skip
  const handleSkip = () => {
    resetDiscovery();
    onSkip();
  };

  // Handle retry
  const handleRetry = () => {
    setError(null);
    // Re-trigger effect by forcing remount via key
    resetDiscovery();
    // Small delay then retry
    setTimeout(() => {
      setLoading(true);
      fetch(`/api/discovery?workspaceId=${encodeURIComponent(workspaceId)}`)
        .then((res) => res.json())
        .then(setResult)
        .catch((err) => setError(err.message));
    }, 100);
  };

  // Loading state
  if (isLoading) {
    return (
      <div className="flex flex-col items-center justify-center py-12 space-y-4">
        <Loader2 className="h-8 w-8 animate-spin text-primary" />
        <div className="text-center">
          <h3 className="font-medium">Scanning repository...</h3>
          <p className="text-sm text-muted-foreground mt-1">
            Looking for initiatives, knowledge, and agents
          </p>
        </div>
      </div>
    );
  }

  // Error state
  if (error) {
    return (
      <div className="flex flex-col items-center justify-center py-12 space-y-4">
        <AlertCircle className="h-8 w-8 text-destructive" />
        <div className="text-center">
          <h3 className="font-medium">Discovery failed</h3>
          <p className="text-sm text-muted-foreground mt-1">{error}</p>
        </div>
        <div className="flex gap-3">
          <button
            onClick={handleRetry}
            className="flex items-center gap-2 px-4 py-2 rounded-md bg-primary text-primary-foreground hover:bg-primary/90"
          >
            <RefreshCw className="h-4 w-4" />
            Retry
          </button>
          <button
            onClick={handleSkip}
            className="px-4 py-2 rounded-md border hover:bg-accent"
          >
            Skip
          </button>
        </div>
      </div>
    );
  }

  // No result yet
  if (!result) {
    return null;
  }

  // Empty state - no initiatives found
  if (result.initiatives.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center py-12 space-y-4">
        <div className="text-center">
          <h3 className="font-medium">No initiatives found</h3>
          <p className="text-sm text-muted-foreground mt-1 max-w-md">
            We couldn't find any initiative folders (initiatives/, features/, projects/, etc.)
            in this repository. You can skip this step and configure manually later.
          </p>
        </div>
        <div className="flex gap-3">
          <button
            onClick={handleSkip}
            className="px-4 py-2 rounded-md bg-primary text-primary-foreground hover:bg-primary/90"
          >
            Continue to workspace
          </button>
        </div>
      </div>
    );
  }

  // Main discovery preview
  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h2 className="text-xl font-semibold">Populate your workspace</h2>
        <p className="text-muted-foreground mt-1">
          We found {result.initiatives.length} initiative
          {result.initiatives.length === 1 ? '' : 's'} in {selectedRepo?.name || 'your repository'}.
          Select what you'd like to import.
        </p>
      </div>

      {/* Summary at top per CONTEXT.md */}
      <ValidationSummary />

      {/* Filter bar */}
      <FilterBar />

      {/* Selection controls */}
      <SelectionControls />

      {/* Preview with checkboxes */}
      <DiscoveryPreview
        result={result}
        selectedIds={selectedInitiatives}
        onToggleInitiative={toggleInitiative}
        showCheckboxes={true}
      />

      {/* Import error */}
      {importError && (
        <div className="p-4 rounded-lg bg-destructive/10 border border-destructive/20 text-destructive">
          {importError}
        </div>
      )}

      {/* Action buttons */}
      <div className="flex items-center justify-between pt-4 border-t">
        <button
          onClick={handleSkip}
          disabled={isImporting}
          className="text-sm text-muted-foreground hover:text-foreground"
        >
          Skip, I'll configure manually
        </button>

        <button
          onClick={handleImport}
          disabled={selectedInitiatives.size === 0 || isImporting}
          className={`
            flex items-center gap-2 px-6 py-2 rounded-md font-medium
            ${selectedInitiatives.size > 0 && !isImporting
              ? 'bg-primary text-primary-foreground hover:bg-primary/90'
              : 'bg-muted text-muted-foreground cursor-not-allowed'
            }
          `}
        >
          {isImporting ? (
            <>
              <Loader2 className="h-4 w-4 animate-spin" />
              Importing...
            </>
          ) : (
            `Import ${selectedInitiatives.size} project${selectedInitiatives.size === 1 ? '' : 's'}`
          )}
        </button>
      </div>
    </div>
  );
}
```

Update steps barrel file (src/components/onboarding/steps/index.ts):
```typescript
export { ConnectGitHubStep } from './ConnectGitHubStep';
export { SelectRepoStep } from './SelectRepoStep';
export { DiscoveryStep } from './DiscoveryStep';  // NEW
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
DiscoveryStep exports from barrel file
  </verify>
  <done>DiscoveryStep integrates all discovery UI with loading, error, and import states</done>
</task>

<task type="auto">
  <name>Task 3: Wire DiscoveryStep into OnboardingWizard</name>
  <files>src/components/onboarding/OnboardingWizard.tsx</files>
  <action>
Add DiscoveryStep to the wizard's step rendering.

Find the step rendering logic in OnboardingWizard.tsx and add the discover case:

```typescript
import { DiscoveryStep } from './steps';

// In the step rendering logic (likely in STEP_CONFIGS or a switch statement):

// Add config for discovery step
{
  id: 'discover',
  title: 'Populate Workspace',
  description: 'Import your projects from GitHub',
}

// Add step content rendering
case 'discover':
  return (
    <DiscoveryStep
      onComplete={() => completeStep('discover')}
      onSkip={() => {
        skipStep('discover');
      }}
    />
  );
```

The exact location depends on how OnboardingWizard is structured.
Follow the pattern used for other steps like 'connect-github' and 'select-repo'.

Key integration points:
1. Add 'discover' to STEP_CONFIGS array with title/description
2. Add rendering case for 'discover' step
3. Wire onComplete to completeStep('discover')
4. Wire onSkip to skipStep('discover')
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Navigate to /workspace/{id}/onboarding and verify:
1. After selecting repo/branch, wizard shows discover step
2. Discover step shows discovery preview
3. Can import or skip
  </verify>
  <done>DiscoveryStep wired into wizard flow between repo selection and completion</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. TypeScript compiles: `npx tsc --noEmit`
2. Wizard flow includes discover step
3. Discovery fetches and displays results
4. Import triggers population API
</verification>

<success_criteria>
- Discovery step appears in wizard after branch selection
- User sees preview with selection controls
- Import button triggers population
- Skip option available and works
- Wizard completes after successful import
</success_criteria>

<output>
After completion, create `.planning/phases/02-structure-discovery-a-workspace-population/02-08-SUMMARY.md`
</output>
