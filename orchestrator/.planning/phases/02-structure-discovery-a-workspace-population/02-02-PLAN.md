---
phase: 02-structure-discovery-a-workspace-population
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/discovery/types.ts
  - src/lib/discovery/id-generator.ts
  - src/lib/discovery/index.ts
autonomous: true

must_haves:
  truths:
    - "Discovery results have typed structure for initiatives, context paths, and agents"
    - "Deterministic IDs prevent duplicate projects on re-onboarding"
    - "Discovery types are exported from barrel file for consumer use"
  artifacts:
    - path: "src/lib/discovery/types.ts"
      provides: "Shared TypeScript types for discovery results"
      exports: ["DiscoveryResult", "DiscoveredInitiative", "DiscoveredContextPath", "DiscoveredAgent", "ImportSelection"]
    - path: "src/lib/discovery/id-generator.ts"
      provides: "Deterministic ID generation for idempotency"
      exports: ["generateProjectId", "generateDeterministicId"]
    - path: "src/lib/discovery/index.ts"
      provides: "Barrel file exporting all discovery modules"
      exports: ["*"]
  key_links:
    - from: "src/lib/discovery/id-generator.ts"
      to: "src/lib/discovery/types.ts"
      via: "DiscoveredInitiative.id uses generateProjectId"
      pattern: "generateProjectId\\("
---

<objective>
Define TypeScript types and ID generation for the discovery system.

Purpose: Establish shared type definitions that enable type-safe communication between discovery engine, API, UI preview, and population engine. Deterministic IDs ensure re-onboarding is idempotent.

Output: Type definitions, ID generator, and barrel file for the discovery module.
</objective>

<execution_context>
@/Users/tylersahagun/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylersahagun/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-structure-discovery-a-workspace-population/02-CONTEXT.md

# Existing types to align with
@src/lib/db/schema.ts (ProjectStage, ProjectMetadata, WorkspaceSettings)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create discovery types module</name>
  <files>src/lib/discovery/types.ts</files>
  <action>
Create comprehensive TypeScript types for the discovery system.

Implementation:

```typescript
import type { ProjectStage } from "@/lib/db/schema";

/**
 * Discovery result from scanning a GitHub repository
 */
export interface DiscoveryResult {
  // Metadata
  repoOwner: string;
  repoName: string;
  branch: string;
  scannedAt: string;

  // Discovered items
  initiatives: DiscoveredInitiative[];
  contextPaths: DiscoveredContextPath[];
  agents: DiscoveredAgent[];

  // Statistics
  stats: DiscoveryStats;

  // Errors/warnings encountered
  warnings: DiscoveryWarning[];
}

export interface DiscoveryStats {
  foldersScanned: number;
  initiativesFound: number;
  contextPathsFound: number;
  agentsFound: number;
  metaJsonParsed: number;
  metaJsonErrors: number;
}

export interface DiscoveryWarning {
  type: 'meta_parse_error' | 'ambiguous_status' | 'missing_meta' | 'api_error';
  path: string;
  message: string;
}

/**
 * A discovered initiative (maps to a project)
 */
export interface DiscoveredInitiative {
  // Deterministic ID for idempotency (DISC-09)
  id: string;

  // Source information
  sourcePath: string;           // e.g., "initiatives/feature-a"
  sourceFolder: string;         // e.g., "initiatives"
  name: string;                 // Derived from folder name or _meta.json

  // Status mapping
  status: string | null;        // Raw status from _meta.json
  mappedColumn: string;         // Column to place in (may be dynamic)
  statusConfidence: number;     // 0-1 confidence in mapping
  isStatusAmbiguous: boolean;   // Needs user review

  // Metadata from _meta.json
  description: string | null;
  archived: boolean;
  tags: string[];
  rawMeta: Record<string, unknown> | null;

  // Discovery metadata
  patternMatch: {
    pattern: string;
    matchType: 'exact' | 'plural' | 'partial';
    confidence: number;
  };

  // Selection state (for import UI)
  selected: boolean;
}

/**
 * A discovered context path (knowledge, personas, signals)
 */
export interface DiscoveredContextPath {
  type: 'knowledge' | 'personas' | 'signals' | 'prototypes';
  path: string;
  confidence: number;
  fileCount: number;
  selected: boolean;
}

/**
 * A discovered agent definition
 */
export interface DiscoveredAgent {
  type: 'agents_md' | 'skill' | 'command' | 'subagent' | 'rule';
  name: string;
  path: string;
  description: string | null;
  selected: boolean;
}

/**
 * User's import selections
 */
export interface ImportSelection {
  initiatives: string[];        // IDs of selected initiatives
  contextPaths: string[];       // Paths of selected context paths
  agents: string[];             // Paths of selected agents
  createDynamicColumns: boolean;
}

/**
 * Import result after population
 */
export interface ImportResult {
  success: boolean;
  projectsCreated: number;
  projectsUpdated: number;
  columnsCreated: string[];
  knowledgeSynced: number;
  personasSynced: number;
  signalsSynced: number;
  agentsImported: number;
  errors: string[];
}

/**
 * Preview grouping for UI display
 * Per CONTEXT.md: "Group discovered items by target column"
 */
export interface PreviewGroup {
  column: string;
  isDynamic: boolean;  // Column doesn't exist yet
  initiatives: DiscoveredInitiative[];
}
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/lib/discovery/types.ts`
All types are exported and importable
  </verify>
  <done>Discovery types defined with comprehensive structure for initiatives, context paths, and agents</done>
</task>

<task type="auto">
  <name>Task 2: Create deterministic ID generator</name>
  <files>src/lib/discovery/id-generator.ts</files>
  <action>
Create deterministic ID generation for idempotent imports (DISC-09).

Implementation:
1. Import crypto from node:crypto for hashing

2. Create generateDeterministicId(parts: string[]): string
   - Join parts with delimiter (|)
   - Create SHA-256 hash
   - Return first 16 characters (collision-resistant for this use case)

3. Create generateProjectId(workspaceId: string, repoSlug: string, initiativePath: string): string
   - Uses generateDeterministicId with [workspaceId, repoSlug, initiativePath]
   - Prefix with 'proj_' for readability
   - Example output: 'proj_a1b2c3d4e5f6g7h8'

4. Document why deterministic IDs matter:
   - Re-running onboarding updates existing projects instead of creating duplicates
   - Same initiative in same repo always gets same ID
   - Enables "merge" vs "replace" behavior

```typescript
import { createHash } from 'node:crypto';

export function generateDeterministicId(parts: string[]): string {
  const input = parts.join('|');
  const hash = createHash('sha256').update(input).digest('hex');
  return hash.substring(0, 16);
}

export function generateProjectId(
  workspaceId: string,
  repoSlug: string,
  initiativePath: string
): string {
  const id = generateDeterministicId([workspaceId, repoSlug, initiativePath]);
  return `proj_${id}`;
}
```
  </action>
  <verify>
Create src/lib/discovery/__tests__/id-generator.test.ts with:
- Test same inputs produce same ID (deterministic)
- Test different inputs produce different IDs
- Test ID format: starts with 'proj_', 21 chars total
- Test ID is stable across multiple calls
Run: npm test -- src/lib/discovery/__tests__/id-generator.test.ts
  </verify>
  <done>Deterministic IDs generated from workspace, repo, and path for idempotent imports</done>
</task>

<task type="auto">
  <name>Task 3: Create barrel file and verify exports</name>
  <files>src/lib/discovery/index.ts</files>
  <action>
Create barrel file that exports all discovery modules.

Implementation:
```typescript
// Types
export * from './types';

// Core discovery modules
export * from './patterns';
export * from './meta-parser';
export * from './status-mapper';
export * from './id-generator';
```

Note: patterns.ts, meta-parser.ts, and status-mapper.ts are created in plan 02-01 (parallel wave 1).
The barrel file should be created with the exports, and will work once 02-01 completes.

Verify all exports are accessible:
```typescript
// This should work after both plans complete:
import {
  // Types
  DiscoveryResult,
  DiscoveredInitiative,

  // Patterns
  matchFolderPattern,
  INITIATIVE_PATTERNS,

  // Meta parser
  parseMetaJson,
  extractStatus,

  // Status mapper
  mapStatusToColumn,

  // ID generator
  generateProjectId,
} from '@/lib/discovery';
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Barrel file exists with all exports
  </verify>
  <done>Barrel file exports all discovery modules for clean imports</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Tests pass: `npm test -- src/lib/discovery/__tests__/id-generator.test.ts`
3. Types are importable from barrel file
</verification>

<success_criteria>
- DiscoveryResult type captures all discovered items with metadata
- DiscoveredInitiative includes deterministic ID, status mapping, and selection state
- ID generator produces consistent IDs for same inputs
- Barrel file cleanly exports all modules
</success_criteria>

<output>
After completion, create `.planning/phases/02-structure-discovery-a-workspace-population/02-02-SUMMARY.md`
</output>
