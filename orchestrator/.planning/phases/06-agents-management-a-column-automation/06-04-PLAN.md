---
phase: 06-agents-management-a-column-automation
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/lib/db/queries.ts
  - src/app/api/agents/[id]/executions/route.ts
  - src/components/agents/AgentExecutionHistory.tsx
  - src/components/agents/AgentCard.tsx
autonomous: true

must_haves:
  truths:
    - "User can see execution history for each agent"
    - "History shows job status, timestamp, context used"
    - "Can navigate to job details from history"
  artifacts:
    - path: "src/app/api/agents/[id]/executions/route.ts"
      provides: "Agent execution history endpoint"
      exports: ["GET"]
    - path: "src/components/agents/AgentExecutionHistory.tsx"
      provides: "Execution history list component"
      exports: ["AgentExecutionHistory"]
  key_links:
    - from: "src/components/agents/AgentExecutionHistory.tsx"
      to: "/api/agents/[id]/executions"
      via: "useQuery fetch"
      pattern: "fetch.*executions"
---

<objective>
Add execution history display for each agent showing past runs with status and context.

Purpose: Users need to see what happened when agents were executed (AGUI-05).

Output: Execution history component integrated into agent cards.
</objective>

<execution_context>
@/Users/tylersahagun/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylersahagun/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing patterns
@src/lib/db/schema.ts (agentExecutions table)
@src/lib/db/queries.ts (createAgentExecution, updateAgentExecution)
@src/components/projects/ProjectCommitHistory.tsx (history display pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add execution history query</name>
  <files>src/lib/db/queries.ts</files>
  <action>
Add query function for agent execution history:

```typescript
export async function getAgentExecutionHistory(
  agentDefinitionId: string,
  limit: number = 20
) {
  return db.query.agentExecutions.findMany({
    where: eq(agentExecutions.agentDefinitionId, agentDefinitionId),
    orderBy: [desc(agentExecutions.createdAt)],
    limit,
    with: {
      project: {
        columns: { id: true, name: true }
      },
      job: {
        columns: { id: true, status: true }
      }
    }
  });
}
```

Also add relation for agentExecutions to include project and job if not already present.
  </action>
  <verify>Query executes without error</verify>
  <done>Database query for execution history exists</done>
</task>

<task type="auto">
  <name>Task 2: Create execution history API endpoint</name>
  <files>src/app/api/agents/[id]/executions/route.ts</files>
  <action>
Create API endpoint for fetching execution history:

```typescript
import { NextRequest, NextResponse } from "next/server";
import { getAgentExecutionHistory, getAgentDefinitionById } from "@/lib/db/queries";
import { requireWorkspaceAccess, handlePermissionError, PermissionError } from "@/lib/permissions";

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await params;
    const agent = await getAgentDefinitionById(id);
    if (!agent) {
      return NextResponse.json({ error: "Agent not found" }, { status: 404 });
    }

    await requireWorkspaceAccess(agent.workspaceId, "viewer");

    const { searchParams } = new URL(request.url);
    const limit = parseInt(searchParams.get("limit") || "20");

    const executions = await getAgentExecutionHistory(id, limit);
    return NextResponse.json({ executions });
  } catch (error) {
    if (error instanceof PermissionError) {
      const { error: message, status } = handlePermissionError(error);
      return NextResponse.json({ error: message }, { status });
    }
    console.error("Failed to fetch executions:", error);
    return NextResponse.json({ error: "Failed to fetch executions" }, { status: 500 });
  }
}
```
  </action>
  <verify>GET /api/agents/[id]/executions returns execution list</verify>
  <done>Execution history API endpoint exists</done>
</task>

<task type="auto">
  <name>Task 3: Create AgentExecutionHistory component</name>
  <files>
    src/components/agents/AgentExecutionHistory.tsx
    src/components/agents/index.ts
  </files>
  <action>
Create execution history display component:

Props:
- agentId: string
- workspaceId: string

Features:
1. Fetch history from /api/agents/{agentId}/executions
2. Display list of executions with:
   - Status badge (from job.status: queued, running, succeeded, failed)
   - Timestamp (relative time using date-fns formatDistanceToNow)
   - Context: project name if projectId, "No context" otherwise
   - Duration (if completedAt exists)
3. Click on execution opens job logs drawer (use existing useJobLogsStore)
4. Empty state: "No executions yet"
5. Loading state with skeleton

Style similar to ProjectCommitHistory component.

Update index.ts to export.
  </action>
  <verify>Component renders execution history with status badges</verify>
  <done>Execution history component displays past runs</done>
</task>

</tasks>

<verification>
1. Agent card shows execution history section
2. History shows status, timestamp, context
3. Click on history item opens job logs
4. New executions appear in history after running agent
</verification>

<success_criteria>
- AGUI-05: User can see execution history for each agent
- History shows job status, timestamp, context
- Can navigate to job details
</success_criteria>

<output>
After completion, create `.planning/phases/06-agents-management-a-column-automation/06-04-SUMMARY.md`
</output>
