---
phase: 06-agents-management-a-column-automation
plan: 05
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/lib/db/schema.ts
  - src/lib/db/queries.ts
  - src/app/api/agents/[id]/route.ts
  - src/components/agents/AgentCard.tsx
autonomous: true

must_haves:
  truths:
    - "User can enable/disable individual agents"
    - "Disabled agents show visual indication"
    - "Disabled agents cannot be executed"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "enabled field on agentDefinitions"
      contains: "enabled.*boolean"
    - path: "src/app/api/agents/[id]/route.ts"
      provides: "PATCH endpoint for updating agent"
      exports: ["PATCH"]
  key_links:
    - from: "src/components/agents/AgentCard.tsx"
      to: "/api/agents/[id]"
      via: "PATCH request to toggle enabled"
      pattern: "fetch.*PATCH"
---

<objective>
Add the ability to enable/disable individual agents, preventing disabled agents from being executed.

Purpose: Users need control over which agents are active in their workspace (AGUI-06).

Output: Toggle control on agent cards with database persistence.
</objective>

<execution_context>
@/Users/tylersahagun/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylersahagun/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing patterns
@src/lib/db/schema.ts (agentDefinitions table)
@src/app/api/agents/[id]/route.ts (existing endpoint)
@src/components/ui/switch.tsx (toggle component)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add enabled field to schema</name>
  <files>src/lib/db/schema.ts</files>
  <action>
Add enabled field to agentDefinitions table:

Find the agentDefinitions table definition and add:
```typescript
enabled: boolean("enabled").default(true),
```

Add after the `metadata` field.

This allows agents to be disabled without deleting them.
  </action>
  <verify>Schema builds without type errors</verify>
  <done>agentDefinitions table has enabled field</done>
</task>

<task type="auto">
  <name>Task 2: Add update query and PATCH endpoint</name>
  <files>
    src/lib/db/queries.ts
    src/app/api/agents/[id]/route.ts
  </files>
  <action>
**queries.ts - Add update function:**
```typescript
export async function updateAgentDefinition(
  id: string,
  data: Partial<{ enabled: boolean }>
) {
  await db.update(agentDefinitions).set(data).where(eq(agentDefinitions.id, id));
  return db.query.agentDefinitions.findFirst({ where: eq(agentDefinitions.id, id) });
}
```

**route.ts - Add PATCH handler:**
```typescript
export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await params;
    const agent = await getAgentDefinitionById(id);
    if (!agent) {
      return NextResponse.json({ error: "Agent not found" }, { status: 404 });
    }

    await requireWorkspaceAccess(agent.workspaceId, "editor");

    const body = await request.json();
    const { enabled } = body;

    if (typeof enabled !== "boolean") {
      return NextResponse.json({ error: "enabled must be a boolean" }, { status: 400 });
    }

    const updated = await updateAgentDefinition(id, { enabled });
    return NextResponse.json(updated);
  } catch (error) {
    if (error instanceof PermissionError) {
      const { error: message, status } = handlePermissionError(error);
      return NextResponse.json({ error: message }, { status });
    }
    console.error("Failed to update agent:", error);
    return NextResponse.json({ error: "Failed to update agent" }, { status: 500 });
  }
}
```
  </action>
  <verify>PATCH /api/agents/[id] with { enabled: false } updates agent</verify>
  <done>API endpoint for updating agent enabled status exists</done>
</task>

<task type="auto">
  <name>Task 3: Add toggle to AgentCard</name>
  <files>src/components/agents/AgentCard.tsx</files>
  <action>
Add enable/disable toggle to AgentCard:

1. Add Switch component from @/components/ui/switch
2. Position toggle in card header next to type badge
3. On toggle change:
   - Optimistically update local state
   - PATCH to /api/agents/{id} with { enabled: newValue }
   - Invalidate agents query on success
   - Revert on error, show error toast

4. When disabled:
   - Card has reduced opacity (opacity-50)
   - Execute button is disabled
   - Tooltip on execute button: "Agent is disabled"

5. Visual indication: "Disabled" label next to toggle when off
  </action>
  <verify>Toggle switch appears, clicking it updates agent status</verify>
  <done>Agent cards have enable/disable toggle</done>
</task>

</tasks>

<verification>
1. Agent cards show toggle switch
2. Click toggle - agent becomes disabled (reduced opacity)
3. Disabled agents have "Execute" button disabled
4. Refresh page - disabled state persists
5. Toggle back on - agent fully functional again
</verification>

<success_criteria>
- AGUI-06: User can enable/disable individual agents or commands
- Visual indication of disabled state
- Disabled agents cannot be executed
- State persists to database
</success_criteria>

<output>
After completion, create `.planning/phases/06-agents-management-a-column-automation/06-05-SUMMARY.md`
</output>
