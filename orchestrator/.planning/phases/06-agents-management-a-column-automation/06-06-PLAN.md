---
phase: 06-agents-management-a-column-automation
plan: 06
type: execute
wave: 3
depends_on: ["06-01"]
files_modified:
  - src/components/settings/ColumnAutomationCard.tsx
  - src/components/settings/AutomationRuleEditor.tsx
  - src/lib/db/schema.ts
  - src/app/api/columns/[id]/automation/route.ts
autonomous: true

must_haves:
  truths:
    - "Each Kanban column has configurable automation rules"
    - "User can view and edit which agents/automations run for each column"
    - "Automation rules are stored per column"
  artifacts:
    - path: "src/components/settings/ColumnAutomationCard.tsx"
      provides: "Column automation configuration UI"
      exports: ["ColumnAutomationCard"]
    - path: "src/app/api/columns/[id]/automation/route.ts"
      provides: "Column automation rules endpoint"
      exports: ["GET", "PUT"]
  key_links:
    - from: "src/components/settings/ColumnAutomationCard.tsx"
      to: "/api/columns/[id]/automation"
      via: "fetch for automation rules"
      pattern: "fetch.*automation"
---

<objective>
Create column automation configuration UI that allows users to configure which agents run when projects are dragged to each column.

Purpose: Users need to set up automation rules for Kanban columns (AUTO-01, AUTO-03, AUTO-04).

Output: Settings card for configuring column automation with agent selection.
</objective>

<execution_context>
@/Users/tylersahagun/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylersahagun/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing patterns
@src/lib/db/schema.ts (columnConfigs.agentTriggers field)
@src/app/api/columns/[id]/route.ts (existing column endpoint)
@src/components/settings/ColumnsSettingsCard.tsx (existing column settings)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AutomationRuleEditor component</name>
  <files>src/components/settings/AutomationRuleEditor.tsx</files>
  <action>
Create a component for editing automation rules for a single column:

Props:
- workspaceId: string
- columnId: string
- columnName: string
- agentTriggers: Array<{ agentDefinitionId: string; priority: number; enabled: boolean }> | null
- onChange: (triggers: Array<{ agentDefinitionId: string; priority: number; enabled: boolean }>) => void

Features:
1. Fetch available agents from /api/agents?workspaceId={id}
2. Show list of current triggers with:
   - Agent name and type badge
   - Priority number input (1-10)
   - Enabled toggle
   - Remove button
3. "Add Agent" button opens select dropdown with available agents
4. Drag to reorder (updates priority based on order)
5. "Clear All" button to remove all triggers

Use dnd-kit for reordering, existing UI components for inputs.
  </action>
  <verify>Component renders, can add/remove/reorder triggers</verify>
  <done>AutomationRuleEditor allows configuring column triggers</done>
</task>

<task type="auto">
  <name>Task 2: Create ColumnAutomationCard component</name>
  <files>src/components/settings/ColumnAutomationCard.tsx</files>
  <action>
Create settings card for column automation:

Props:
- workspaceId: string

Features:
1. Fetch columns from /api/columns?workspaceId={id}
2. Display accordion/tabs for each column
3. Each column section contains AutomationRuleEditor
4. Save button per column (or auto-save on change)
5. PATCH to /api/columns/{id} with updated agentTriggers
6. Success/error toasts

Card structure:
```
Column Automation
[Description text explaining automation behavior]

[Discovery Column]
  - PRD Generator (Priority 1) [x]
  - [Add Agent +]

[PRD Column]
  - Design Brief Generator (Priority 1) [x]
  - [Add Agent +]

[Save Changes]
```

Style as a Card matching other settings cards.
  </action>
  <verify>Card displays columns with automation editors</verify>
  <done>ColumnAutomationCard shows automation config for all columns</done>
</task>

<task type="auto">
  <name>Task 3: Create automation API endpoint</name>
  <files>src/app/api/columns/[id]/automation/route.ts</files>
  <action>
Create dedicated endpoint for column automation:

**GET:** Return current automation config for column
```typescript
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  const column = await getColumnConfigById(id);
  if (!column) {
    return NextResponse.json({ error: "Column not found" }, { status: 404 });
  }
  await requireWorkspaceAccess(column.workspaceId, "viewer");
  return NextResponse.json({
    agentTriggers: column.agentTriggers || [],
    autoTriggerJobs: column.autoTriggerJobs || []
  });
}
```

**PUT:** Update automation rules
```typescript
export async function PUT(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  const column = await getColumnConfigById(id);
  if (!column) {
    return NextResponse.json({ error: "Column not found" }, { status: 404 });
  }
  await requireWorkspaceAccess(column.workspaceId, "editor");

  const { agentTriggers, autoTriggerJobs } = await request.json();
  await updateColumnConfig(id, { agentTriggers, autoTriggerJobs });

  return NextResponse.json({ ok: true });
}
```

Add getColumnConfigById query if not exists.
  </action>
  <verify>GET returns automation config, PUT updates it</verify>
  <done>Column automation API endpoint exists</done>
</task>

</tasks>

<verification>
1. Navigate to workspace settings
2. See Column Automation card
3. Expand a column - see automation rules
4. Add an agent as trigger - shows in list
5. Save changes - persists to database
6. Reload page - automation rules still there
</verification>

<success_criteria>
- AUTO-01: Each Kanban column has configurable automation rules
- AUTO-03: Automation configuration is based on pm-workspace patterns
- AUTO-04: User can view and edit which agents/automations run for each column
- Rules persist to database
</success_criteria>

<output>
After completion, create `.planning/phases/06-agents-management-a-column-automation/06-06-SUMMARY.md`
</output>
