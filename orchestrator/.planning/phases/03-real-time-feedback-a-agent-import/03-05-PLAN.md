---
phase: 03-real-time-feedback-a-agent-import
plan: 05
type: execute
wave: 3
depends_on: ["03-03", "03-04"]
files_modified:
  - src/hooks/useStreamingDiscovery.ts
  - src/hooks/index.ts
  - src/components/onboarding/steps/DiscoveryStep.tsx
  - src/components/discovery/DiscoveryProgress.tsx
autonomous: true

must_haves:
  truths:
    - "User sees live progress updates during discovery scan"
    - "User sees discovered items appear incrementally"
    - "User sees elapsed time and estimated remaining time"
    - "User can cancel long-running discovery"
  artifacts:
    - path: "src/hooks/useStreamingDiscovery.ts"
      provides: "React hook for streaming discovery with SSE"
      exports: ["useStreamingDiscovery"]
    - path: "src/components/discovery/DiscoveryProgress.tsx"
      provides: "Progress display component with timing"
      exports: ["DiscoveryProgress"]
  key_links:
    - from: "src/hooks/useStreamingDiscovery.ts"
      to: "src/app/api/discovery/stream/route.ts"
      via: "EventSource connection"
      pattern: "EventSource.*discovery/stream"
    - from: "src/components/onboarding/steps/DiscoveryStep.tsx"
      to: "src/hooks/useStreamingDiscovery.ts"
      via: "uses streaming hook"
      pattern: "useStreamingDiscovery"
---

<objective>
Integrate streaming discovery into UI with progress display and cancel support

Purpose: Complete FEED-01 through FEED-05 requirements for real-time feedback
Output: Working streaming discovery with live progress, incremental results, and cancellation
</objective>

<execution_context>
@/Users/tylersahagun/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylersahagun/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-real-time-feedback-a-agent-import/03-03-SUMMARY.md
@.planning/phases/03-real-time-feedback-a-agent-import/03-04-SUMMARY.md

Reference existing patterns:
@src/hooks/useRealtimeJobs.ts
@src/lib/discovery/streaming.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useStreamingDiscovery hook</name>
  <files>
    src/hooks/useStreamingDiscovery.ts
    src/hooks/index.ts
  </files>
  <action>
Create `src/hooks/useStreamingDiscovery.ts` following useRealtimeJobs pattern:

```typescript
/**
 * useStreamingDiscovery - Hook for real-time discovery via SSE
 *
 * Provides streaming progress updates during repository scanning.
 * Supports cancellation and handles reconnection on error.
 */

import { useState, useCallback, useRef, useEffect } from "react";
import type {
  DiscoveryResult,
  DiscoveryProgress,
  DiscoveredInitiative,
  DiscoveredContextPath,
  DiscoveredAgent,
} from "@/lib/discovery/types";
import type { DiscoveryStreamEvent } from "@/lib/discovery/streaming";

interface UseStreamingDiscoveryOptions {
  workspaceId: string;
  enabled?: boolean;
  onInitiativeFound?: (initiative: DiscoveredInitiative) => void;
  onComplete?: (result: DiscoveryResult) => void;
  onError?: (error: string) => void;
}

interface UseStreamingDiscoveryReturn {
  // State
  isScanning: boolean;
  progress: DiscoveryProgress | null;
  result: DiscoveryResult | null;
  error: string | null;

  // Incremental results (for live preview)
  initiatives: DiscoveredInitiative[];
  contextPaths: DiscoveredContextPath[];
  agents: DiscoveredAgent[];

  // Actions
  startDiscovery: () => void;
  cancelDiscovery: () => void;
}
```

Implementation:
1. Use EventSource to connect to /api/discovery/stream
2. Track AbortController for cancellation
3. Process incoming events:
   - 'scanning_started': set isScanning=true, reset state
   - 'progress': update progress state
   - 'initiative_found': append to initiatives array
   - 'context_path_found': append to contextPaths array
   - 'agent_found': append to agents array
   - 'completed': set result, isScanning=false
   - 'error': set error, isScanning=false
   - 'cancelled': set isScanning=false, preserve partial results

4. cancelDiscovery() closes EventSource and sends abort signal
5. Clean up EventSource on unmount

Export from `src/hooks/index.ts`
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/hooks/useStreamingDiscovery.ts`</verify>
  <done>useStreamingDiscovery hook exists with SSE connection and cancel support</done>
</task>

<task type="auto">
  <name>Task 2: Create DiscoveryProgress component</name>
  <files>
    src/components/discovery/DiscoveryProgress.tsx
    src/components/discovery/index.ts
  </files>
  <action>
Create `src/components/discovery/DiscoveryProgress.tsx`:

```typescript
"use client";

import { Loader2, Clock, Folder, XCircle } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import type { DiscoveryProgress as ProgressData } from "@/lib/discovery/types";

interface DiscoveryProgressProps {
  progress: ProgressData;
  onCancel?: () => void;
  canCancel?: boolean;
}

export function DiscoveryProgress({
  progress,
  onCancel,
  canCancel = true,
}: DiscoveryProgressProps) {
  const {
    foldersScanned,
    totalFolders,
    currentFolder,
    initiativesFound,
    contextPathsFound,
    agentsFound,
    elapsedMs,
    estimatedRemainingMs,
  } = progress;

  const percentComplete = totalFolders > 0
    ? Math.round((foldersScanned / totalFolders) * 100)
    : 0;

  const formatTime = (ms: number) => {
    if (ms < 1000) return `${ms}ms`;
    const seconds = Math.floor(ms / 1000);
    if (seconds < 60) return `${seconds}s`;
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}m ${remainingSeconds}s`;
  };

  return (
    <div className="space-y-4 p-4 border rounded-lg bg-muted/30">
      {/* Header with spinner and status */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <Loader2 className="h-5 w-5 animate-spin text-primary" />
          <span className="font-medium">Scanning repository...</span>
        </div>
        {canCancel && onCancel && (
          <Button
            variant="ghost"
            size="sm"
            onClick={onCancel}
            className="text-muted-foreground hover:text-destructive"
          >
            <XCircle className="h-4 w-4 mr-1" />
            Cancel
          </Button>
        )}
      </div>

      {/* Progress bar */}
      <div className="space-y-2">
        <Progress value={percentComplete} className="h-2" />
        <div className="flex items-center justify-between text-sm text-muted-foreground">
          <span>
            <Folder className="inline h-4 w-4 mr-1" />
            Analyzing folder {foldersScanned} of {totalFolders}
          </span>
          <span>{percentComplete}%</span>
        </div>
      </div>

      {/* Current folder */}
      {currentFolder && (
        <div className="text-sm text-muted-foreground truncate">
          Scanning: <span className="font-mono">{currentFolder}</span>
        </div>
      )}

      {/* Found items */}
      <div className="flex gap-4 text-sm">
        <span>
          <strong>{initiativesFound}</strong> initiatives
        </span>
        <span>
          <strong>{contextPathsFound}</strong> context paths
        </span>
        <span>
          <strong>{agentsFound}</strong> agents
        </span>
      </div>

      {/* Timing */}
      <div className="flex items-center gap-4 text-xs text-muted-foreground">
        <span>
          <Clock className="inline h-3 w-3 mr-1" />
          Elapsed: {formatTime(elapsedMs)}
        </span>
        {estimatedRemainingMs !== null && (
          <span>
            Est. remaining: {formatTime(estimatedRemainingMs)}
          </span>
        )}
      </div>
    </div>
  );
}
```

Add export to `src/components/discovery/index.ts`
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/components/discovery/DiscoveryProgress.tsx`</verify>
  <done>DiscoveryProgress shows folder count, time, found items, cancel button</done>
</task>

<task type="auto">
  <name>Task 3: Wire streaming discovery into DiscoveryStep</name>
  <files>
    src/components/onboarding/steps/DiscoveryStep.tsx
  </files>
  <action>
Update `src/components/onboarding/steps/DiscoveryStep.tsx` to use streaming:

1. Import new components and hook:
```typescript
import { useStreamingDiscovery } from "@/hooks";
import { DiscoveryProgress } from "@/components/discovery";
```

2. Replace existing fetch-based discovery with streaming hook:
```typescript
const {
  isScanning,
  progress,
  result: streamingResult,
  error: streamingError,
  initiatives: liveInitiatives,
  contextPaths: liveContextPaths,
  agents: liveAgents,
  startDiscovery,
  cancelDiscovery,
} = useStreamingDiscovery({
  workspaceId,
  enabled: true,
  onComplete: (result) => {
    setResult(result);  // Update store with final result
  },
  onError: (error) => {
    setError(error);
  },
});
```

3. Update useEffect to call startDiscovery() on mount instead of fetch

4. During scanning, show DiscoveryProgress component:
```tsx
if (isScanning && progress) {
  return (
    <div className="space-y-4">
      <DiscoveryProgress
        progress={progress}
        onCancel={cancelDiscovery}
        canCancel={true}
      />

      {/* Show items as they're found */}
      {liveInitiatives.length > 0 && (
        <div className="text-sm text-muted-foreground">
          Found so far: {liveInitiatives.map(i => i.name).slice(0, 5).join(', ')}
          {liveInitiatives.length > 5 && ` +${liveInitiatives.length - 5} more`}
        </div>
      )}
    </div>
  );
}
```

5. Keep existing result display logic for when scanning completes

6. Handle cancel by showing partial results option or return to start
  </action>
  <verify>
Run dev server, navigate to discovery step:
- Progress bar shows during scan
- Folder count updates live
- Found items appear incrementally
- Elapsed/estimated time shown
- Cancel button stops scan
  </verify>
  <done>DiscoveryStep uses streaming with live progress and cancel support</done>
</task>

</tasks>

<verification>
- [ ] TypeScript compiles without errors: `npx tsc --noEmit`
- [ ] Progress bar appears during scanning
- [ ] Folder count updates in real-time ("Analyzing folder 23 of 50")
- [ ] Elapsed time increments during scan
- [ ] Estimated remaining time shown
- [ ] Cancel button works - stops scan
- [ ] Discovered items appear incrementally
- [ ] Final result displays correctly after scan completes
</verification>

<success_criteria>
1. User sees live progress bar during discovery (FEED-01, FEED-05)
2. Discovered items appear as they're found (FEED-02)
3. Elapsed and estimated time displayed (FEED-03)
4. Cancel button stops discovery operation (FEED-04)
5. Partial results preserved on cancel
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time-feedback-a-agent-import/03-05-SUMMARY.md`
</output>
