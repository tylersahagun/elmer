---
phase: 03-real-time-feedback-a-agent-import
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/discovery/stream/route.ts
  - src/lib/discovery/types.ts
  - src/lib/discovery/streaming.ts
autonomous: true

must_haves:
  truths:
    - "Discovery API can send progress events as Server-Sent Events"
    - "Progress events include folder count, current folder, items found"
    - "Stream connects successfully and sends initial event"
  artifacts:
    - path: "src/app/api/discovery/stream/route.ts"
      provides: "SSE endpoint for discovery streaming"
      exports: ["GET"]
    - path: "src/lib/discovery/streaming.ts"
      provides: "Streaming utilities and event types"
      exports: ["DiscoveryStreamEvent", "createDiscoveryStream", "sendStreamEvent"]
    - path: "src/lib/discovery/types.ts"
      provides: "Extended types for streaming progress"
      contains: "DiscoveryProgress"
  key_links:
    - from: "src/app/api/discovery/stream/route.ts"
      to: "src/lib/discovery/streaming.ts"
      via: "imports streaming utilities"
      pattern: "import.*from.*streaming"
---

<objective>
Create SSE streaming infrastructure for discovery operations

Purpose: Enable real-time progress updates during repository scanning (FEED-01, FEED-02, FEED-05)
Output: Streaming API endpoint and utility functions for discovery progress
</objective>

<execution_context>
@/Users/tylersahagun/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylersahagun/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-structure-discovery-a-workspace-population/02-03-SUMMARY.md

Reference existing SSE pattern:
@src/app/api/jobs/stream/route.ts
@src/hooks/useRealtimeJobs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create discovery streaming types and utilities</name>
  <files>
    src/lib/discovery/streaming.ts
    src/lib/discovery/types.ts
    src/lib/discovery/index.ts
  </files>
  <action>
Create `src/lib/discovery/streaming.ts` with:

1. DiscoveryStreamEvent types:
```typescript
export type DiscoveryStreamEventType =
  | 'connected'
  | 'scanning_started'
  | 'folder_found'
  | 'initiative_found'
  | 'context_path_found'
  | 'agent_found'
  | 'progress'
  | 'completed'
  | 'error'
  | 'cancelled';

export interface DiscoveryStreamEvent {
  type: DiscoveryStreamEventType;
  timestamp: string;
  data: {
    // Progress tracking
    foldersScanned?: number;
    totalFolders?: number;
    currentFolder?: string;

    // Items found incrementally
    initiative?: DiscoveredInitiative;
    contextPath?: DiscoveredContextPath;
    agent?: DiscoveredAgent;

    // Final result
    result?: DiscoveryResult;

    // Error info
    error?: string;

    // Timing
    elapsedMs?: number;
    estimatedRemainingMs?: number;
  };
}
```

2. Helper function `sendStreamEvent(controller: ReadableStreamDefaultController, event: DiscoveryStreamEvent)` that:
   - Encodes event as SSE format: `data: ${JSON.stringify(event)}\n\n`
   - Uses TextEncoder for proper encoding
   - Handles errors gracefully (connection closed)

3. Helper function `createDiscoveryStreamResponse(stream: ReadableStream)` that returns Response with proper SSE headers:
   - Content-Type: text/event-stream
   - Cache-Control: no-cache
   - Connection: keep-alive

Update `src/lib/discovery/types.ts` to add:
```typescript
export interface DiscoveryProgress {
  foldersScanned: number;
  totalFolders: number;
  currentFolder: string | null;
  initiativesFound: number;
  contextPathsFound: number;
  agentsFound: number;
  elapsedMs: number;
  estimatedRemainingMs: number | null;
}
```

Export from `src/lib/discovery/index.ts`
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/lib/discovery/streaming.ts`</verify>
  <done>Streaming types and utilities exist, compile without errors, exported from barrel</done>
</task>

<task type="auto">
  <name>Task 2: Create discovery streaming API endpoint</name>
  <files>
    src/app/api/discovery/stream/route.ts
  </files>
  <action>
Create `src/app/api/discovery/stream/route.ts` following the pattern from `src/app/api/jobs/stream/route.ts`:

```typescript
/**
 * Discovery Stream API (Server-Sent Events)
 *
 * GET /api/discovery/stream?workspaceId=xxx
 *
 * Provides real-time discovery progress via SSE.
 * Streams folder scanning progress and discovered items as they're found.
 */
```

1. Validate authentication via `auth()`
2. Validate workspaceId parameter
3. Get workspace and validate has connected repo
4. Get GitHub client (return 403 with connectUrl if not connected)
5. Create ReadableStream with:
   - `start(controller)` that:
     a. Sends 'connected' event immediately
     b. Sends 'scanning_started' event with repo info
     c. Calls streaming scanner (to be implemented in 03-02)
     d. Sets up abort handler to clean up on disconnect
6. Return Response with SSE headers

For now, implement a placeholder that sends mock progress events every 500ms to verify SSE works:
- Send 'connected'
- Send 'progress' with incrementing folder count
- After 5 iterations, send 'completed' with empty result

This will be wired to real scanner in Plan 03-02.

Include AbortController pattern for cancellation support (FEED-04 prep).
  </action>
  <verify>
Start dev server, test with curl:
```bash
curl -N "http://localhost:3000/api/discovery/stream?workspaceId=test" -H "Cookie: [session]"
```
Should see SSE events streaming
  </verify>
  <done>SSE endpoint exists, returns streaming response, sends progress events</done>
</task>

<task type="auto">
  <name>Task 3: Add streaming tests</name>
  <files>
    src/lib/discovery/__tests__/streaming.test.ts
  </files>
  <action>
Create `src/lib/discovery/__tests__/streaming.test.ts` with tests for:

1. `sendStreamEvent`:
   - Encodes event correctly as SSE format
   - Handles various event types
   - Gracefully handles closed controller

2. `DiscoveryStreamEvent` type tests:
   - All event types are valid
   - Data fields are correctly typed

3. `createDiscoveryStreamResponse`:
   - Returns Response with correct headers
   - Content-Type is text/event-stream

Use vitest patterns from existing test files.
  </action>
  <verify>`npm test -- src/lib/discovery/__tests__/streaming.test.ts`</verify>
  <done>Streaming utilities have test coverage, all tests pass</done>
</task>

</tasks>

<verification>
- [ ] TypeScript compiles without errors: `npx tsc --noEmit`
- [ ] New streaming tests pass: `npm test -- streaming`
- [ ] API endpoint exists at /api/discovery/stream
- [ ] curl to endpoint returns SSE events (with mock data)
</verification>

<success_criteria>
1. DiscoveryStreamEvent types defined and exported
2. sendStreamEvent utility correctly formats SSE messages
3. /api/discovery/stream endpoint returns streaming response
4. SSE headers are set correctly (Content-Type: text/event-stream)
5. Tests pass for streaming utilities
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time-feedback-a-agent-import/03-01-SUMMARY.md`
</output>
