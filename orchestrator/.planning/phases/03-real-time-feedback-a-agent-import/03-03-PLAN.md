---
phase: 03-real-time-feedback-a-agent-import
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/discovery/scanner.ts
  - src/lib/discovery/streaming-scanner.ts
  - src/app/api/discovery/stream/route.ts
autonomous: true

must_haves:
  truths:
    - "Scanner emits progress events as folders are scanned"
    - "Discovered items are sent incrementally via callback"
    - "Progress includes elapsed time and estimated remaining"
  artifacts:
    - path: "src/lib/discovery/streaming-scanner.ts"
      provides: "Streaming wrapper for repository scanner"
      exports: ["scanRepositoryWithStreaming", "ScanProgressCallback"]
  key_links:
    - from: "src/lib/discovery/streaming-scanner.ts"
      to: "src/lib/discovery/scanner.ts"
      via: "wraps scanRepository"
      pattern: "import.*scanRepository"
    - from: "src/app/api/discovery/stream/route.ts"
      to: "src/lib/discovery/streaming-scanner.ts"
      via: "calls streaming scanner"
      pattern: "scanRepositoryWithStreaming"
---

<objective>
Add streaming capabilities to discovery scanner

Purpose: Enable real-time progress reporting during repository scanning (FEED-01, FEED-02, FEED-03, FEED-05)
Output: Streaming scanner that emits progress events and discovered items incrementally
</objective>

<execution_context>
@/Users/tylersahagun/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylersahagun/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-real-time-feedback-a-agent-import/03-01-SUMMARY.md

Reference existing scanner:
@src/lib/discovery/scanner.ts
@src/lib/discovery/streaming.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create streaming scanner module</name>
  <files>
    src/lib/discovery/streaming-scanner.ts
  </files>
  <action>
Create `src/lib/discovery/streaming-scanner.ts` that wraps the existing scanner with streaming capabilities:

```typescript
/**
 * Streaming Scanner Module
 *
 * Wraps the repository scanner to emit progress events via callbacks.
 * Enables real-time UI updates during discovery operations.
 */

import type { Octokit } from "@octokit/rest";
import type {
  DiscoveryResult,
  DiscoveredInitiative,
  DiscoveredContextPath,
  DiscoveredAgent,
  DiscoveryProgress,
} from "./types";
import type { DiscoveryStreamEvent } from "./streaming";

export type ScanProgressCallback = (event: DiscoveryStreamEvent) => void;

export interface StreamingScanOptions {
  workspaceId: string;
  owner: string;
  repo: string;
  branch: string;
  octokit: Octokit;
  onProgress: ScanProgressCallback;
  signal?: AbortSignal; // For cancellation support
}

export async function scanRepositoryWithStreaming(
  options: StreamingScanOptions
): Promise<DiscoveryResult>
```

Implementation approach:
1. Refactor scanner.ts to accept optional callbacks (or create wrapper that intercepts)
2. Track start time for elapsed/estimated calculations
3. Emit 'folder_found' events as folders are processed
4. Emit 'initiative_found' for each discovered initiative
5. Emit 'context_path_found' for each context path
6. Emit 'agent_found' for each agent
7. Emit 'progress' events periodically (every ~5 folders or 500ms)
8. Calculate estimated remaining time based on:
   - `estimatedRemainingMs = (elapsedMs / foldersScanned) * (totalFolders - foldersScanned)`
9. Check signal.aborted before each major operation
10. Emit 'cancelled' if aborted, 'completed' with result on success, 'error' on failure

Key timing: Use performance.now() or Date.now() for elapsed time tracking.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/lib/discovery/streaming-scanner.ts`</verify>
  <done>Streaming scanner exists, accepts callbacks, emits progress events</done>
</task>

<task type="auto">
  <name>Task 2: Wire streaming scanner to API endpoint</name>
  <files>
    src/app/api/discovery/stream/route.ts
  </files>
  <action>
Update `src/app/api/discovery/stream/route.ts` to use real streaming scanner:

1. Replace mock progress events with actual scanner call
2. Create AbortController for cancellation support
3. In stream start():
   ```typescript
   const abortController = new AbortController();

   // Handle client disconnect
   request.signal.addEventListener("abort", () => {
     abortController.abort();
   });

   const onProgress = (event: DiscoveryStreamEvent) => {
     sendStreamEvent(controller, event);
   };

   try {
     const result = await scanRepositoryWithStreaming({
       workspaceId,
       owner,
       repo,
       branch,
       octokit,
       onProgress,
       signal: abortController.signal,
     });

     sendStreamEvent(controller, {
       type: 'completed',
       timestamp: new Date().toISOString(),
       data: { result }
     });
   } catch (error) {
     if (abortController.signal.aborted) {
       sendStreamEvent(controller, {
         type: 'cancelled',
         timestamp: new Date().toISOString(),
         data: {}
       });
     } else {
       sendStreamEvent(controller, {
         type: 'error',
         timestamp: new Date().toISOString(),
         data: { error: error.message }
       });
     }
   } finally {
     controller.close();
   }
   ```
  </action>
  <verify>
Test with curl against running dev server:
```bash
curl -N "http://localhost:3000/api/discovery/stream?workspaceId=[id]"
```
Should see real progress events with folder counts
  </verify>
  <done>Stream endpoint uses real scanner, emits actual progress events</done>
</task>

<task type="auto">
  <name>Task 3: Add streaming scanner tests</name>
  <files>
    src/lib/discovery/__tests__/streaming-scanner.test.ts
  </files>
  <action>
Create `src/lib/discovery/__tests__/streaming-scanner.test.ts`:

Test cases:
1. Emits 'scanning_started' event first
2. Emits 'progress' events during scan
3. Emits 'initiative_found' for each discovered initiative
4. Emits 'context_path_found' for each context path
5. Emits 'agent_found' for each agent
6. Emits 'completed' with result when done
7. Emits 'cancelled' when signal aborted
8. Emits 'error' on scanner failure
9. Calculates elapsed time correctly
10. Estimates remaining time based on progress

Mock octokit to return controlled tree data for predictable test results.
Use vi.fn() to capture emitted events for assertions.
  </action>
  <verify>`npm test -- src/lib/discovery/__tests__/streaming-scanner.test.ts`</verify>
  <done>Streaming scanner has comprehensive test coverage</done>
</task>

</tasks>

<verification>
- [ ] TypeScript compiles without errors: `npx tsc --noEmit`
- [ ] Streaming scanner tests pass
- [ ] curl to stream endpoint shows real progress events
- [ ] Progress includes elapsed time
- [ ] Items are emitted incrementally (not all at once at end)
</verification>

<success_criteria>
1. scanRepositoryWithStreaming emits progress events during scan
2. Stream endpoint returns real discovery progress
3. Elapsed time calculated and included in events
4. Estimated remaining time calculated after initial progress
5. Cancellation via AbortSignal works
6. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time-feedback-a-agent-import/03-03-SUMMARY.md`
</output>
