---
phase: 03-real-time-feedback-a-agent-import
plan: 04
type: execute
wave: 2
depends_on: ["03-02"]
files_modified:
  - src/components/onboarding/steps/DiscoveryStep.tsx
  - src/lib/stores/discovery-store.ts
  - src/components/discovery/AgentSelectionControls.tsx
autonomous: true

must_haves:
  truths:
    - "User can select/deselect individual agents via checkboxes"
    - "User can bulk select/deselect all agents"
    - "Agent selection state persists in discovery store"
  artifacts:
    - path: "src/components/discovery/AgentSelectionControls.tsx"
      provides: "Select all/none controls for agents"
      exports: ["AgentSelectionControls"]
  key_links:
    - from: "src/components/onboarding/steps/DiscoveryStep.tsx"
      to: "src/components/discovery/AgentPreview.tsx"
      via: "renders AgentPreview"
      pattern: "AgentPreview"
    - from: "src/components/discovery/AgentSelectionControls.tsx"
      to: "src/lib/stores/discovery-store.ts"
      via: "uses store actions"
      pattern: "useDiscoveryStore"
---

<objective>
Add agent selection controls to discovery step

Purpose: Allow selective import of detected agents/commands (AGENT-05)
Output: Selection UI for agents integrated into discovery step
</objective>

<execution_context>
@/Users/tylersahagun/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylersahagun/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-real-time-feedback-a-agent-import/03-02-SUMMARY.md

Reference existing selection patterns:
@src/components/discovery/SelectionControls.tsx
@src/lib/stores/discovery-store.ts
@src/components/onboarding/steps/DiscoveryStep.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add agent selection actions to discovery store</name>
  <files>
    src/lib/stores/discovery-store.ts
  </files>
  <action>
Verify the discovery store already has agent selection (from Phase 2):
- `selectedAgents: Set<string>` - exists
- `toggleAgent: (path: string) => void` - exists

Add new bulk selection actions if not present:
```typescript
selectAllAgents: () => void;
deselectAllAgents: () => void;
```

Implementation:
```typescript
selectAllAgents: () => {
  const { result } = get();
  if (!result) return;
  const allPaths = new Set(result.agents.map(a => a.path));
  set({ selectedAgents: allPaths });
},

deselectAllAgents: () => {
  set({ selectedAgents: new Set() });
},
```

Also add helper getter:
```typescript
getSelectedAgentCount: () => number;
```
  </action>
  <verify>TypeScript compiles, existing tests still pass: `npm test -- discovery-store`</verify>
  <done>Store has selectAllAgents, deselectAllAgents, getSelectedAgentCount</done>
</task>

<task type="auto">
  <name>Task 2: Create AgentSelectionControls component</name>
  <files>
    src/components/discovery/AgentSelectionControls.tsx
    src/components/discovery/index.ts
  </files>
  <action>
Create `src/components/discovery/AgentSelectionControls.tsx` following SelectionControls pattern:

```typescript
"use client";

import { useDiscoveryStore } from "@/lib/stores/discovery-store";
import { Button } from "@/components/ui/button";
import { CheckSquare, Square } from "lucide-react";

export function AgentSelectionControls() {
  const {
    result,
    selectedAgents,
    selectAllAgents,
    deselectAllAgents,
  } = useDiscoveryStore();

  if (!result || result.agents.length === 0) {
    return null;
  }

  const totalAgents = result.agents.length;
  const selectedCount = selectedAgents.size;
  const allSelected = selectedCount === totalAgents;
  const noneSelected = selectedCount === 0;

  return (
    <div className="flex items-center gap-2 text-sm">
      <span className="text-muted-foreground">
        {selectedCount} of {totalAgents} agents selected
      </span>
      <div className="flex gap-1">
        <Button
          variant="ghost"
          size="sm"
          onClick={selectAllAgents}
          disabled={allSelected}
          className="h-7 px-2"
        >
          <CheckSquare className="h-4 w-4 mr-1" />
          All
        </Button>
        <Button
          variant="ghost"
          size="sm"
          onClick={deselectAllAgents}
          disabled={noneSelected}
          className="h-7 px-2"
        >
          <Square className="h-4 w-4 mr-1" />
          None
        </Button>
      </div>
    </div>
  );
}
```

Add export to `src/components/discovery/index.ts`
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/components/discovery/AgentSelectionControls.tsx`</verify>
  <done>AgentSelectionControls component exists and exported</done>
</task>

<task type="auto">
  <name>Task 3: Integrate AgentPreview into DiscoveryStep</name>
  <files>
    src/components/onboarding/steps/DiscoveryStep.tsx
  </files>
  <action>
Update `src/components/onboarding/steps/DiscoveryStep.tsx` to include agent preview:

1. Import new components:
```typescript
import { AgentPreview, AgentSelectionControls } from "@/components/discovery";
```

2. Get agent selection state from store:
```typescript
const { selectedAgents, toggleAgent } = useDiscoveryStore();
```

3. Add AgentPreview section after initiatives preview (before action buttons):
```tsx
{/* Agent Architecture Section */}
{result.agents.length > 0 && (
  <div className="space-y-4 pt-4 border-t">
    <div className="flex items-center justify-between">
      <h3 className="font-medium">Agent Architecture</h3>
      <AgentSelectionControls />
    </div>
    <AgentPreview
      agents={result.agents}
      selectedPaths={selectedAgents}
      onToggleAgent={toggleAgent}
      showCheckboxes={true}
    />
  </div>
)}
```

4. Update ValidationSummary to include agent count (already should show from PREV-03)

5. Ensure import button text reflects agents:
```tsx
const itemCount = selectedInitiatives.size + selectedAgents.size;
`Import ${itemCount} item${itemCount === 1 ? '' : 's'}`
```
  </action>
  <verify>
Run dev server, navigate to onboarding wizard:
- AgentPreview section appears when agents detected
- Checkboxes toggle agent selection
- Select all/none works
- Import count reflects agents
  </verify>
  <done>DiscoveryStep shows agent preview with selection controls</done>
</task>

</tasks>

<verification>
- [ ] TypeScript compiles without errors: `npx tsc --noEmit`
- [ ] Discovery store tests pass
- [ ] Agent section appears in discovery step when agents detected
- [ ] Individual agent checkboxes work
- [ ] Select all/none buttons work
- [ ] Import count includes selected agents
</verification>

<success_criteria>
1. User sees agents section in discovery step
2. Each agent has selectable checkbox
3. Select all/none controls work for agents
4. Selection count updates correctly
5. Selection persists in store for import
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time-feedback-a-agent-import/03-04-SUMMARY.md`
</output>
