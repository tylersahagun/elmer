---
phase: 03-real-time-feedback-a-agent-import
plan: 06
type: execute
wave: 3
depends_on: ["03-04"]
files_modified:
  - src/lib/discovery/population-engine.ts
  - src/lib/agents/sync.ts
  - src/app/api/workspaces/[id]/import/route.ts
autonomous: true

must_haves:
  truths:
    - "Imported agents are saved to database with correct metadata"
    - "Agent definitions are ready to execute after import"
    - "Import result includes accurate agent count"
  artifacts:
    - path: "src/lib/discovery/population-engine.ts"
      provides: "Population engine with enhanced agent import"
      contains: "importAgents"
    - path: "src/lib/agents/sync.ts"
      provides: "Agent sync with selective import"
      exports: ["syncAgentArchitecture"]
  key_links:
    - from: "src/lib/discovery/population-engine.ts"
      to: "src/lib/agents/sync.ts"
      via: "calls sync for selected agents"
      pattern: "syncAgentArchitecture"
---

<objective>
Ensure imported agents are properly configured and executable

Purpose: Complete AGENT-06 - Imported agents are configured and ready to execute in workspace
Output: Working agent import flow with proper database records
</objective>

<execution_context>
@/Users/tylersahagun/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylersahagun/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-real-time-feedback-a-agent-import/03-04-SUMMARY.md

Reference existing implementations:
@src/lib/discovery/population-engine.ts
@src/lib/agents/sync.ts
@src/components/settings/AgentArchitectureImporter.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify agent sync handles selective import</name>
  <files>
    src/lib/agents/sync.ts
  </files>
  <action>
Review and verify `src/lib/agents/sync.ts` properly handles selective import:

1. Confirm `syncAgentArchitecture` accepts selection parameter:
```typescript
selection?: {
  agentsMd?: boolean;
  skills?: boolean;
  commands?: boolean;
  subagents?: boolean;
  rules?: boolean;
  knowledge?: boolean;
  personas?: boolean;
}
```

2. Verify each section is conditionally processed based on selection flags

3. Add validation to ensure imported agents have required fields:
   - `workspaceId` - links to workspace
   - `sourceRepo` - tracks origin
   - `sourcePath` - file location in repo
   - `type` - agent type (skill, command, etc.)
   - `name` - display name
   - `content` - full content for execution

4. Ensure agents are queryable after import:
```typescript
// After sync, verify agents can be retrieved
const imported = await db.query.agentDefinitions.findMany({
  where: eq(agentDefinitions.workspaceId, workspaceId)
});
```

5. Return accurate count in result:
```typescript
return {
  count: definitions.length,
  knowledgePaths: include.knowledge ? knowledgePaths : [],
  include,
};
```
  </action>
  <verify>TypeScript compiles, review agent sync logic is complete</verify>
  <done>Agent sync handles selective import, saves all required fields</done>
</task>

<task type="auto">
  <name>Task 2: Enhance population engine agent import</name>
  <files>
    src/lib/discovery/population-engine.ts
  </files>
  <action>
Review and enhance `importAgents` function in population engine:

1. Verify it correctly maps selected agents to sync selection:
```typescript
const agentSelection = {
  agentsMd: selectedAgents.some((a) => a.type === "agents_md"),
  skills: selectedAgents.some((a) => a.type === "skill"),
  commands: selectedAgents.some((a) => a.type === "command"),
  subagents: selectedAgents.some((a) => a.type === "subagent"),
  rules: selectedAgents.some((a) => a.type === "rule"),
  knowledge: false,
  personas: false,
};
```

2. Add logging for import tracking:
```typescript
console.log(`[PopulationEngine] Importing ${selectedAgents.length} agents:`, {
  types: Object.entries(agentSelection).filter(([, v]) => v).map(([k]) => k)
});
```

3. Verify progress tracking is accurate:
```typescript
progress.agentsImported = result.count;
```

4. Add error handling for partial failures:
```typescript
try {
  const result = await syncAgentArchitecture({...});
  progress.agentsImported = result.count;
} catch (error) {
  const message = error instanceof Error ? error.message : "Unknown error";
  progress.errors.push(`Failed to import agents: ${message}`);
  // Continue with other operations - partial import is acceptable
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/lib/discovery/population-engine.ts`</verify>
  <done>Population engine correctly imports selected agents with proper error handling</done>
</task>

<task type="auto">
  <name>Task 3: Verify import endpoint returns agent status</name>
  <files>
    src/app/api/workspaces/[id]/import/route.ts
  </files>
  <action>
Review and verify the import endpoint returns complete results including agents:

1. Confirm response includes agent import count:
```typescript
return NextResponse.json({
  success: result.success,
  projectsCreated: result.projectsCreated,
  projectsUpdated: result.projectsUpdated,
  columnsCreated: result.columnsCreated,
  knowledgeSynced: result.knowledgeSynced,
  personasSynced: result.personasSynced,
  signalsSynced: result.signalsSynced,
  agentsImported: result.agentsImported,  // This must be included
  errors: result.errors,
});
```

2. If not present, add it to the response

3. Verify error cases return partial success info:
```typescript
// For 207 Multi-Status
if (result.errors.length > 0 && result.projectsCreated > 0) {
  return NextResponse.json(result, { status: 207 });
}
```

4. Test that client receives agent count:
```typescript
// In useDiscoveryImport
setImportResult({
  ...data,
  agentsImported: data.agentsImported || 0,
});
```
  </action>
  <verify>
Test import endpoint returns agentsImported field:
```bash
curl -X POST "http://localhost:3000/api/workspaces/[id]/import" \
  -H "Content-Type: application/json" \
  -d '{"selection": {"initiatives": [], "contextPaths": [], "agents": ["AGENTS.md"]}}'
```
  </verify>
  <done>Import endpoint returns complete results including agent count</done>
</task>

</tasks>

<verification>
- [ ] TypeScript compiles without errors: `npx tsc --noEmit`
- [ ] Agent sync processes selected agents only
- [ ] Population engine tracks agent import count
- [ ] Import endpoint returns agentsImported in response
- [ ] Imported agents appear in database with correct workspaceId
</verification>

<success_criteria>
1. Selected agents are imported to database (AGENT-06)
2. Agents have all required fields for execution
3. Import count is accurate in response
4. Agents are linked to correct workspace
5. Partial failures don't break entire import
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time-feedback-a-agent-import/03-06-SUMMARY.md`
</output>
