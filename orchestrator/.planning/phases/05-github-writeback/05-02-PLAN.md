---
phase: 05-github-writeback
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - drizzle/0014_project_commits.sql
  - src/lib/db/schema.ts
  - src/lib/db/queries.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Project commits are stored with linkage to projects"
    - "Commit history can be queried by project ID"
    - "Commit metadata includes document type and trigger info"
  artifacts:
    - path: "drizzle/0014_project_commits.sql"
      provides: "Migration for project_commits table"
      contains: "CREATE TABLE"
      min_lines: 15
    - path: "src/lib/db/schema.ts"
      provides: "Project commits table schema"
      contains: "projectCommits"
    - path: "src/lib/db/queries.ts"
      provides: "Commit history query functions"
      exports: ["getProjectCommitHistory"]
  key_links:
    - from: "src/lib/db/schema.ts"
      to: "projects"
      via: "foreign key reference"
      pattern: "references.*projects"
---

<objective>
Create database schema and queries for tracking project-level commit history, enabling users to see all Elmer-generated commits for each project.

Purpose: WRITE-06 requires commits to be linked to projects, and WRITE-07 requires viewing commit history per project. This plan establishes the data layer for that functionality.

Output:
- Database migration for project_commits table
- Drizzle schema definition
- Query functions for commit history
</objective>

<execution_context>
@/Users/tylersahagun/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylersahagun/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing schema patterns
@src/lib/db/schema.ts

# Existing queries pattern
@src/lib/db/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration for project_commits table</name>
  <files>drizzle/0014_project_commits.sql</files>
  <action>
Create a SQL migration file for the project_commits table:

```sql
-- Migration: 0014_project_commits.sql
-- Purpose: Track GitHub commits generated by Elmer for each project (WRITE-06, WRITE-07)

CREATE TABLE IF NOT EXISTS "project_commits" (
  "id" text PRIMARY KEY NOT NULL,
  "project_id" text NOT NULL REFERENCES "projects"("id") ON DELETE CASCADE,
  "workspace_id" text NOT NULL REFERENCES "workspaces"("id") ON DELETE CASCADE,
  "commit_sha" text NOT NULL,
  "commit_url" text NOT NULL,
  "message" text NOT NULL,
  "document_type" text,
  "files_changed" jsonb DEFAULT '[]',
  "triggered_by" text,
  "stage_run_id" text REFERENCES "stage_runs"("id") ON DELETE SET NULL,
  "github_write_op_id" text REFERENCES "github_write_ops"("id") ON DELETE SET NULL,
  "created_at" timestamp NOT NULL DEFAULT now()
);

-- Index for efficient project history queries
CREATE INDEX IF NOT EXISTS "project_commits_project_id_idx" ON "project_commits"("project_id");

-- Index for workspace-level queries
CREATE INDEX IF NOT EXISTS "project_commits_workspace_id_idx" ON "project_commits"("workspace_id");

-- Index for chronological ordering
CREATE INDEX IF NOT EXISTS "project_commits_created_at_idx" ON "project_commits"("created_at" DESC);
```

This table:
- Links commits to projects (WRITE-06)
- Stores commit metadata for history display (WRITE-07)
- References stage_runs for execution tracking
- References github_write_ops for audit trail
  </action>
  <verify>SQL syntax is valid (no syntax errors on visual inspection)</verify>
  <done>Migration file created at drizzle/0014_project_commits.sql</done>
</task>

<task type="auto">
  <name>Task 2: Add projectCommits to Drizzle schema</name>
  <files>src/lib/db/schema.ts</files>
  <action>
Add the projectCommits table definition to the schema file. Add this after the existing `githubWriteOps` table definition (around line 795):

```typescript
// ============================================
// PROJECT COMMITS (GitHub Writeback Tracking - Phase 5)
// ============================================

export const projectCommits = pgTable("project_commits", {
  id: text("id").primaryKey().$defaultFn(() => nanoid()),
  projectId: text("project_id").notNull().references(() => projects.id, { onDelete: "cascade" }),
  workspaceId: text("workspace_id").notNull().references(() => workspaces.id, { onDelete: "cascade" }),
  commitSha: text("commit_sha").notNull(),
  commitUrl: text("commit_url").notNull(),
  message: text("message").notNull(),
  documentType: text("document_type"),  // "prd" | "design_brief" | "prototype_notes" | etc.
  filesChanged: jsonb("files_changed").$type<string[]>().default([]),
  triggeredBy: text("triggered_by"),  // "automation" | "user" | stage run ID
  stageRunId: text("stage_run_id").references(() => stageRuns.id, { onDelete: "set null" }),
  githubWriteOpId: text("github_write_op_id").references(() => githubWriteOps.id, { onDelete: "set null" }),
  createdAt: timestamp("created_at").defaultNow().notNull(),
});

// Relations for projectCommits
export const projectCommitsRelations = relations(projectCommits, ({ one }) => ({
  project: one(projects, {
    fields: [projectCommits.projectId],
    references: [projects.id],
  }),
  workspace: one(workspaces, {
    fields: [projectCommits.workspaceId],
    references: [workspaces.id],
  }),
  stageRun: one(stageRuns, {
    fields: [projectCommits.stageRunId],
    references: [stageRuns.id],
  }),
  githubWriteOp: one(githubWriteOps, {
    fields: [projectCommits.githubWriteOpId],
    references: [githubWriteOps.id],
  }),
}));
```

Also add projectCommits to the projectsRelations (find the existing `projectsRelations` definition and add):

```typescript
// In projectsRelations, add:
commits: many(projectCommits),
```

Import note: The `relations` import should already exist at the top of the file.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/lib/db/schema.ts`</verify>
  <done>projectCommits table and relations added to schema</done>
</task>

<task type="auto">
  <name>Task 3: Add commit history query functions</name>
  <files>src/lib/db/queries.ts</files>
  <action>
Add query functions for commit history. First check the existing queries.ts file structure, then add:

```typescript
import { projectCommits } from "./schema";
import { desc } from "drizzle-orm";

/**
 * Get commit history for a project, ordered by most recent first.
 * Used for WRITE-07 (user can see commit history for each project)
 */
export async function getProjectCommitHistory(
  projectId: string,
  options: { limit?: number; offset?: number } = {}
) {
  const { limit = 20, offset = 0 } = options;

  return db.query.projectCommits.findMany({
    where: eq(projectCommits.projectId, projectId),
    orderBy: [desc(projectCommits.createdAt)],
    limit,
    offset,
    with: {
      stageRun: {
        columns: {
          id: true,
          stage: true,
          status: true,
        },
      },
    },
  });
}

/**
 * Get total commit count for a project.
 */
export async function getProjectCommitCount(projectId: string): Promise<number> {
  const result = await db
    .select({ count: sql<number>`count(*)::int` })
    .from(projectCommits)
    .where(eq(projectCommits.projectId, projectId));

  return result[0]?.count || 0;
}

/**
 * Record a new commit in project history.
 * Called by writeback service after successful commit.
 */
export async function recordProjectCommit(data: {
  projectId: string;
  workspaceId: string;
  commitSha: string;
  commitUrl: string;
  message: string;
  documentType?: string;
  filesChanged?: string[];
  triggeredBy?: string;
  stageRunId?: string;
  githubWriteOpId?: string;
}) {
  return db.insert(projectCommits).values({
    id: `pcom_${nanoid()}`,
    ...data,
    filesChanged: data.filesChanged || [],
    createdAt: new Date(),
  }).returning();
}
```

Ensure these imports are added at the top if not already present:
- `sql` from "drizzle-orm"
- `projectCommits` from "./schema"
- `nanoid` from "nanoid"
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/lib/db/queries.ts`

Verify exports are accessible:
```typescript
import { getProjectCommitHistory, recordProjectCommit } from "@/lib/db/queries";
```
  </verify>
  <done>
- getProjectCommitHistory returns paginated commit history
- getProjectCommitCount returns total commits for a project
- recordProjectCommit creates new commit record
  </done>
</task>

</tasks>

<verification>
1. Migration file is valid SQL
2. Schema compiles without TypeScript errors
3. Queries compile without errors
4. Relations are properly defined (projectCommits -> project, workspace, stageRun)
5. Query functions use correct Drizzle patterns matching existing codebase
</verification>

<success_criteria>
- project_commits table migration created
- Drizzle schema includes projectCommits with all required columns
- Relations link commits to projects, workspaces, stage runs, and github write ops
- Query functions provide paginated history and commit recording
- Indexes exist for efficient project-level and chronological queries
</success_criteria>

<output>
After completion, create `.planning/phases/05-github-writeback/05-02-SUMMARY.md`
</output>
